<!DOCTYPE html>
<html lang="en">
<head>
<script>(function(){var t=localStorage.getItem('draftmyforms-theme')||'system';var r=t;if(t==='system'){r=window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'}document.documentElement.setAttribute('data-theme',r)})()</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard | DraftMyForms</title>
<meta name="description" content="Your DraftMyForms dashboard - manage documents, create new ones, and access your account.">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%23c99532'/%3E%3Cstop offset='100%25' stop-color='%23e8b94a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='24' text-anchor='middle' font-size='24' fill='url(%23g)'%3E%E2%9C%A6%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--gold:#c99532;--gold-light:#e8b94a;--gold-dark:#a67a28;--gold-bg:#fef8ee;--paper:#faf7f5;--white:#ffffff;--text:#1a1a1a;--text-secondary:#555;--text-muted:#888;--border:#e5e0db;--border-light:#f0ebe6;--success:#3a6633;--danger:#c24b3b;--font-heading:'Playfair Display',Georgia,serif;--font-body:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;--max-w:1200px}
[data-theme="dark"]{--gold:#F59E0B;--gold-light:#FBBF24;--gold-dark:#D97706;--gold-bg:#1a1608;--paper:#0F0F13;--white:#1A1A22;--text:#E8E6E3;--text-secondary:#A0A0A8;--text-muted:#666670;--border:#2A2A36;--border-light:#333340;--success:#4ADE80;--danger:#EF5350}
[data-theme="dark"] body{background:#0F0F13;color:#E8E6E3}
[data-theme="dark"] .dash-nav{background:#131318;border-color:#2A2A36}
[data-theme="dark"] .doc-card,.stat-card{background:#1A1A22;border-color:#2A2A36}
[data-theme="dark"] .sidebar{background:#131318;border-color:#2A2A36}
[data-theme="dark"] input,[data-theme="dark"] select{background:#242430;color:#E8E6E3;border-color:#333340}
[data-theme="dark"] .modal-overlay .modal{background:#1E1E28;color:#E8E6E3}
.theme-toggle-dash{display:inline-flex;gap:2px;background:rgba(0,0,0,0.05);border-radius:6px;padding:2px;margin-right:8px}
[data-theme="dark"] .theme-toggle-dash{background:rgba(255,255,255,0.05)}
.theme-toggle-dash button{padding:3px 7px;border-radius:4px;border:none;cursor:pointer;font-size:12px;background:transparent;color:var(--text-muted);transition:all 0.2s}
.theme-toggle-dash button.active{background:var(--gold);color:#fff}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);color:var(--text);background:var(--paper);-webkit-font-smoothing:antialiased;min-height:100vh}
a{text-decoration:none;color:inherit}
.navbar{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-light);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between}
.nav-brand{display:flex;align-items:center;gap:10px;font-family:var(--font-heading);font-weight:700;font-size:20px;color:var(--text)}
.nav-brand .star{color:var(--gold);font-size:22px}
.nav-actions{display:flex;align-items:center;gap:12px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 22px;border-radius:8px;font-family:var(--font-body);font-size:14px;font-weight:600;border:none;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--text);color:var(--white)}.btn-primary:hover{background:#333}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-gold{background:var(--gold);color:var(--white)}.btn-gold:hover{background:var(--gold-dark)}
.btn-ghost{background:transparent;color:var(--text-secondary);padding:8px 12px}.btn-ghost:hover{color:var(--gold)}
.btn-sm{padding:8px 16px;font-size:13px}
.btn-lg{padding:14px 32px;font-size:16px}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger)}.btn-danger:hover{background:var(--danger);color:#fff}
.dashboard{padding:88px 32px 48px;max-width:var(--max-w);margin:0 auto}
.dash-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:16px}
.dash-header h1{font-family:var(--font-heading);font-size:28px;font-weight:700}
.dash-header h1 .wave{display:inline-block;animation:wave 2s ease-in-out infinite;transform-origin:70% 70%}
@keyframes wave{0%,100%{transform:rotate(0deg)}15%{transform:rotate(14deg)}30%{transform:rotate(-8deg)}40%{transform:rotate(14deg)}50%{transform:rotate(-4deg)}60%{transform:rotate(10deg)}70%{transform:rotate(0deg)}}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px}
.stat-card{background:#fff;border:1px solid var(--border-light);border-radius:12px;padding:20px;text-align:center}
.stat-card .stat-number{font-family:var(--font-heading);font-size:28px;font-weight:700;color:var(--gold)}
.stat-card .stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.section-header h2{font-family:var(--font-heading);font-size:20px;font-weight:600}
.docs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:40px}
.doc-card{background:#fff;border:1px solid var(--border-light);border-radius:12px;overflow:hidden;transition:all .3s;cursor:pointer}
.doc-card:hover{border-color:var(--gold);box-shadow:0 8px 30px rgba(201,149,50,.1);transform:translateY(-2px)}
.doc-card .doc-preview{height:160px;background:var(--paper);overflow:hidden;padding:12px;font-size:8px;line-height:1.4;color:var(--text-muted);position:relative}
.doc-card .doc-preview-inner{transform:scale(0.25);transform-origin:top left;width:400%;height:400%;pointer-events:none;font-size:14px;line-height:1.6;color:#2d2926}
.doc-card .doc-preview::after{content:'';position:absolute;bottom:0;left:0;right:0;height:40px;background:linear-gradient(transparent,var(--paper))}
.doc-card .doc-info{padding:14px 16px;border-top:1px solid var(--border-light)}
.doc-card .doc-info h4{font-size:14px;font-weight:600;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc-card .doc-info .doc-meta{font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:8px}
.doc-card .doc-date{font-size:11px;color:var(--text-muted);margin-bottom:4px}
.doc-card .doc-excerpt{font-size:11px;color:var(--text-muted);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.doc-card .doc-actions{padding:8px 16px 14px;display:flex;gap:6px}
.doc-card .doc-actions button{flex:1}
.new-doc-card{background:#fff;border:2px dashed var(--border);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;cursor:pointer;transition:all .3s;min-height:260px}
.new-doc-card:hover{border-color:var(--gold);background:var(--gold-bg)}
.new-doc-card i{font-size:32px;color:var(--gold);margin-bottom:12px}
.new-doc-card span{font-size:14px;font-weight:600;color:var(--text-secondary)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty-state i{font-size:48px;color:var(--border);margin-bottom:16px;display:block}
.empty-state h3{font-family:var(--font-heading);font-size:20px;color:var(--text);margin-bottom:8px}
.empty-state p{font-size:14px;margin-bottom:24px}
.account-section{background:#fff;border:1px solid var(--border-light);border-radius:12px;padding:24px;margin-bottom:32px}
.account-section h3{font-family:var(--font-heading);font-size:18px;margin-bottom:16px}
.account-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-light)}
.account-row:last-child{border-bottom:none}
.account-row .label{font-size:13px;color:var(--text-muted)}
.account-row .value{font-size:14px;font-weight:500}
.plan-badge{display:inline-block;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600}
.plan-free{background:#e8f5e2;color:var(--success)}
.plan-pro{background:#fef3d8;color:var(--gold-dark)}
.plan-business{background:#e0e7ff;color:#3730a3}
.loading-spinner{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-muted)}
.user-avatar{width:36px;height:36px;border-radius:50%;background:var(--gold);color:var(--white);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;cursor:pointer}
.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;z-index:9999;transform:translateY(100px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
@media(max-width:768px){.navbar{padding:0 12px;gap:8px}.dashboard{padding:80px 12px 32px}.stats-row{grid-template-columns:1fr 1fr}.docs-grid{grid-template-columns:1fr}.dash-header{flex-direction:column;align-items:flex-start}.nav-actions{gap:6px}.nav-actions .btn-gold{padding:8px 12px;font-size:12px}.nav-actions .btn-gold .btn-text-long{display:none}.user-avatar{width:40px;height:40px;font-size:16px;min-width:40px}.nav-brand{font-size:16px}}
@media(max-width:480px){.stats-row{grid-template-columns:1fr}.nav-actions .btn-gold{padding:6px 10px}.nav-brand{font-size:14px;gap:6px}.nav-brand .star{font-size:18px}}

.upgrade-banner{background:linear-gradient(135deg,#c99532 0%,#e8b94a 50%,#c99532 100%);border-radius:12px;padding:20px 24px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;color:#fff}
.upgrade-banner h3{font-family:var(--font-heading);font-size:18px;margin-bottom:4px}
.upgrade-banner p{font-size:13px;opacity:.9}
.upgrade-banner .btn-upgrade{background:#fff;color:var(--gold-dark);font-weight:700;padding:10px 24px;border-radius:8px;border:none;cursor:pointer;font-size:14px;font-family:var(--font-body);transition:all .2s;display:inline-flex;align-items:center;gap:8px}
.upgrade-banner .btn-upgrade:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.2)}
.upgrade-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.upgrade-overlay.active{display:flex}
.upgrade-modal{background:#fff;border-radius:16px;max-width:720px;width:100%;max-height:90vh;overflow-y:auto;position:relative}
.upgrade-modal-header{padding:24px 28px 16px;border-bottom:1px solid var(--border-light)}
.upgrade-modal-header h2{font-family:var(--font-heading);font-size:24px;margin-bottom:4px}
.upgrade-modal-header p{font-size:14px;color:var(--text-muted)}
.upgrade-modal-close{position:absolute;top:16px;right:20px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px}
.upgrade-modal-close:hover{background:var(--border-light);color:var(--text)}
.upgrade-plans{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:24px 28px}
.plan-card{border:2px solid var(--border-light);border-radius:12px;padding:24px;transition:all .2s;position:relative}
.plan-card:hover{border-color:var(--gold);box-shadow:0 4px 20px rgba(201,149,50,.1)}
.plan-card.popular{border-color:var(--gold)}
.plan-card .popular-tag{position:absolute;top:-12px;right:20px;background:var(--gold);color:#fff;font-size:11px;font-weight:700;padding:4px 12px;border-radius:6px}
.plan-card .plan-name{font-family:var(--font-heading);font-size:18px;font-weight:700;margin-bottom:4px}
.plan-card .plan-price{font-family:var(--font-heading);font-size:32px;font-weight:700;color:var(--gold);margin-bottom:2px}
.plan-card .plan-price span{font-size:14px;font-weight:400;color:var(--text-muted)}
.plan-card .plan-trial{font-size:12px;color:var(--gold-dark);font-weight:600;margin-bottom:12px}
.plan-card .plan-desc{font-size:13px;color:var(--text-secondary);margin-bottom:16px}
.plan-card ul{list-style:none;margin-bottom:20px}
.plan-card ul li{font-size:13px;padding:4px 0;color:var(--text-secondary)}
.plan-card ul li::before{content:'\2713';color:var(--gold);font-weight:700;margin-right:8px}
.plan-card .btn-checkout{width:100%;padding:12px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;border:none;font-family:var(--font-body);transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.plan-card .btn-checkout.primary{background:var(--gold);color:#fff}.plan-card .btn-checkout.primary:hover{background:var(--gold-dark)}
.plan-card .btn-checkout.outline{background:transparent;border:2px solid var(--border);color:var(--text)}.plan-card .btn-checkout.outline:hover{border-color:var(--gold);color:var(--gold)}
.plan-card .btn-checkout:disabled{opacity:.6;cursor:not-allowed}
.plan-card .btn-checkout .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.upgrade-footer{padding:12px 28px 20px;text-align:center;font-size:12px;color:var(--text-muted)}
.nav-upgrade{background:var(--gold);color:#fff;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--font-body);transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.nav-upgrade:hover{background:var(--gold-dark)}
@media(max-width:600px){.upgrade-plans{grid-template-columns:1fr}.upgrade-banner{flex-direction:column;text-align:center}}
/* === Dropdown Menu Polish === */
.user-dropdown{background:#fff;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.12);padding:12px 0;min-width:240px;border:1px solid #eee}
.user-dropdown .user-info{padding:12px 16px;border-bottom:1px solid #f0f0f0;margin-bottom:4px}
.user-dropdown .user-name{font-weight:600;font-size:15px;color:#1a1a1a}
.user-dropdown .user-email{font-size:13px;color:#888;margin-top:2px}
.user-dropdown a,.user-dropdown .menu-item{display:flex;align-items:center;gap:10px;padding:10px 16px;color:#333;text-decoration:none;font-size:14px;transition:background 0.15s;cursor:pointer}
.user-dropdown a:hover,.user-dropdown .menu-item:hover{background:#f8f6f0}
.user-dropdown .separator{border-top:1px solid #f0f0f0;margin:4px 0}
.user-dropdown .sign-out{color:#dc3545 !important}
/* === Mobile Responsive ‚Äî Dashboard === */
@media (max-width: 768px) {
  h1, .greeting { font-size: 1.4rem !important; word-break: break-word; }
  .stats-row { grid-template-columns: 1fr 1fr !important; gap: 10px !important; }
  .stat-card { padding: 12px !important; }
  .stat-number { font-size: 1.3rem !important; }
  .doc-card, .document-card, .new-doc-card { width: 100% !important; max-width: 100% !important; }
  .referral-card { flex-direction: column !important; padding: 16px !important; }
  .referral-card input, #referralLink { width: 100% !important; font-size: 12px !important; }
  #aiCreditsCard { width: 100% !important; }
  body, .main-content, .dashboard-container { overflow-x: hidden !important; max-width: 100vw !important; }
  button, .btn { min-height: 44px; font-size: 14px !important; }
  .docs-grid { grid-template-columns: 1fr 1fr !important; gap: 10px !important; }
  .upgrade-plans { flex-direction: column !important; }
  .plan-card { width: 100% !important; max-width: 100% !important; }
  .user-dropdown, .dropdown-menu {
    position: fixed !important; top: auto !important; bottom: 0 !important;
    left: 0 !important; right: 0 !important; width: 100vw !important;
    max-width: 100vw !important; border-radius: 16px 16px 0 0 !important;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15) !important; padding: 20px !important;
  }
  .user-dropdown a, .dropdown-menu a, .user-dropdown button, .dropdown-menu button {
    padding: 14px 16px !important; font-size: 16px !important;
    display: flex !important; align-items: center !important; gap: 12px !important;
  }
  .nav-actions { gap: 8px !important; }
  .btn { padding: 8px 12px !important; font-size: 13px !important; }
}
</style>
</head>
<body>
<div id="siteBanner"></div>
<nav class="navbar">
<a href="/dashboard.html" class="nav-brand"><span class="star">‚ú¶</span> DraftMyForms</a>
<div class="theme-toggle-dash" id="themeToggle">
<button onclick="setTheme('light')" title="Light">&#9728;</button>
<button onclick="setTheme('dark')" title="Dark">&#9790;</button>
<button onclick="setTheme('system')" title="System">&#128187;</button>
</div>
<div class="nav-actions">
<button class="nav-upgrade" id="navUpgradeBtn" style="display:none" onclick="openUpgradeModal()"><i class="fas fa-crown"></i> Upgrade</button>
<a href="/editor.html" class="btn btn-gold btn-sm"><i class="fas fa-plus"></i> <span class="btn-text-long">New Document</span></a>
<div class="user-avatar" id="userAvatar" onclick="toggleMenu()"></div>
<div id="userDropdown" style="display:none;position:absolute;top:56px;right:32px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.12);z-index:1001">
<div style="padding:10px 14px;border-bottom:1px solid var(--border-light);margin-bottom:4px">
<div style="font-weight:600;font-size:14px" id="menuName">User</div>
<div style="font-size:12px;color:var(--text-muted)" id="menuEmail">email</div>
<div class="plan-badge plan-free" style="margin-top:4px" id="menuPlan">Free</div>
</div>
<a href="#" id="menuUpgradeLink" style="display:none;padding:10px 14px;font-size:14px;border-radius:6px;cursor:pointer;transition:background .2s;color:var(--gold);font-weight:600" onclick="event.preventDefault();openUpgradeModal()" onmouseover="this.style.background='var(--gold-bg)'" onmouseout="this.style.background='transparent'"><i class="fas fa-crown" style="width:20px"></i> Upgrade Plan</a>
<a href="/dashboard.html" style="display:block;padding:10px 14px;font-size:14px;border-radius:6px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='var(--gold-bg)'" onmouseout="this.style.background='transparent'"><i class="fas fa-home" style="width:20px"></i> Dashboard</a>
<a href="/editor.html" style="display:block;padding:10px 14px;font-size:14px;border-radius:6px;cursor:pointer;transition:background .2s" onmouseover="this.style.background='var(--gold-bg)'" onmouseout="this.style.background='transparent'"><i class="fas fa-edit" style="width:20px"></i> Open Editor</a>
<a href="/inbox.html" onmouseover="this.style.background='var(--gold-bg)'" onmouseout="this.style.background='transparent'" style="display:block;padding:10px 16px;text-decoration:none;color:var(--text);font-size:14px;transition:background .2s"><i class="fas fa-inbox" style="margin-right:8px;color:var(--gold)"></i>Inbox <span id="inboxBadge" style="background:var(--gold);color:#fff;font-size:10px;padding:1px 6px;border-radius:10px;margin-left:4px;display:none"></span></a>
<a href="/settings.html" onmouseover="this.style.background='var(--gold-bg)'" onmouseout="this.style.background='transparent'"><i class="fas fa-cog" style="width:20px"></i> Settings</a>
<a href="/admin.html" id="menuAdminLink" style="display:none"><i class="fas fa-shield-alt"></i> Admin Dashboard</a>
<button onclick="handleLogout()" style="display:block;width:100%;text-align:left;padding:10px 14px;font-size:14px;border:none;background:none;cursor:pointer;border-radius:6px;color:var(--danger);font-family:var(--font-body);transition:background .2s" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'"><i class="fas fa-sign-out-alt" style="width:20px"></i> Sign Out</button>
</div>
</div>
</nav>
<div class="dashboard" id="dashboard">
<div class="loading-spinner" id="loadingState"><i class="fas fa-spinner fa-spin" style="margin-right:8px"></i> Loading your dashboard...</div>
<div id="dashContent" style="display:none">
<div class="dash-header">
<h1><span class="wave">üëã</span> Welcome back, <span id="userName">User</span></h1>
<a href="/editor.html" class="btn btn-gold"><i class="fas fa-plus"></i> Create New Document</a>
</div>
<div class="stats-row">
<div class="stat-card"><div class="stat-number" id="statDocs">0</div><div class="stat-label">Documents</div></div>
<div class="stat-card"><div class="stat-number" id="statPlan">Free</div><div class="stat-label">Current Plan</div></div>
<div class="stat-card"><div class="stat-number" id="statExports">‚àû</div><div class="stat-label">Exports Left</div></div>
</div>
<!-- Referral Section -->
<div class="referral-card" id="referralCard" style="background:linear-gradient(135deg,#fffdf5,#fff8e1);border:1px solid #e8d5a3;border-radius:12px;padding:20px 25px;margin:20px 0;display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
  <div style="flex:1;min-width:200px;">
    <h3 style="margin:0 0 5px;font-size:1.1em;color:#333;"><span style="margin-right:6px;">üéÅ</span> Refer a Friend</h3>
    <p style="margin:0;color:#666;font-size:0.9em;">Share your referral link and earn rewards when friends sign up!</p>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <input type="text" id="referralLink" readonly style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:0.85em;width:280px;background:#fff;" value="Loading...">
    <button onclick="copyReferralLink()" style="padding:8px 16px;background:#C8922A;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;white-space:nowrap;">Copy Link</button>
  </div>
  <div id="referralStats" style="display:flex;gap:15px;font-size:0.85em;color:#666;">
    <span><strong id="refCount">0</strong> referrals</span>
    <span><strong id="refRewards">0</strong> rewards</span>
  </div>
</div>


<div class="upgrade-banner" id="upgradeBanner" style="display:none">
<div>
<h3><i class="fas fa-rocket"></i> Unlock the Full Power of DraftMyForms</h3>
<p>Upgrade to Pro or Business for unlimited AI credits, premium templates, PDF/Word export, and more.</p>
</div>
<button class="btn-upgrade" onclick="openUpgradeModal()"><i class="fas fa-crown"></i> Upgrade Now</button>
</div>

<div class="referral-card" id="aiCreditsCard" style="margin-top:24px;">
<h3 style="margin:0 0 8px;font-family:var(--font-heading);color:var(--gold);">
<i class="fas fa-bolt"></i> AI Credits</h3>
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
<div style="flex:1;background:var(--card-border);border-radius:8px;height:12px;overflow:hidden;">
<div id="creditBar" style="height:100%;background:var(--gold);border-radius:8px;width:0%;transition:width 0.5s;"></div>
</div>
<span id="creditCount" style="font-weight:600;color:var(--text);font-size:14px;">--</span>
</div>
<p id="creditPlan" style="margin:0;font-size:13px;color:var(--text-muted);">Loading plan info...</p>
<p id="creditReset" style="margin:4px 0 0;font-size:12px;color:var(--text-muted);"></p>
</div>
<div class="section-header">
<h2>Your Documents</h2>
</div>
<div class="docs-grid" id="docsGrid">
<div class="new-doc-card" onclick="window.location.href='/editor.html'">
<i class="fas fa-plus-circle"></i>
<span>Create New Document</span>
</div>
</div>
<div class="section-header"><h2>Account</h2></div>
<div class="account-section">
<div class="account-row"><span class="label">Email</span><span class="value" id="acctEmail">-</span></div>
<div class="account-row"><span class="label">Name</span><span class="value" id="acctName">-</span></div>
<div class="account-row"><span class="label">Plan</span><span class="value"><span class="plan-badge plan-free" id="acctPlan">Free</span></span></div>
<div class="account-row"><span class="label">Member Since</span><span class="value" id="acctSince">-</span></div>
<div class="account-row"><span class="label">Actions</span><span class="value"><button class="btn btn-danger btn-sm" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Sign Out</button></span></div>
<div class="account-row" id="subscriptionRow" style="display:none"><span class="label">Subscription</span><span class="value"><button class="btn btn-outline btn-sm" onclick="manageSubscription()"><i class="fas fa-credit-card"></i> Manage Subscription</button></span></div>
</div>
</div>
</div>

<div class="upgrade-overlay" id="upgradeOverlay" onclick="if(event.target===this)closeUpgradeModal()">
<div class="upgrade-modal">
<button class="upgrade-modal-close" onclick="closeUpgradeModal()">&times;</button>
<div class="upgrade-modal-header">
<h2>Choose Your Plan</h2>
<p>Upgrade to unlock premium features. Cancel anytime.</p>
</div>
<div class="upgrade-plans">
<div class="plan-card popular">
<div class="popular-tag">Most Popular</div>
<div class="plan-name">Pro</div>
<div class="plan-price">$9.99<span>/month</span></div>
<div class="plan-trial">3-day free trial included</div>
<div class="plan-desc">For freelancers and professionals.</div>
<ul>
<li>50 AI credits per month</li>
<li>Unlimited document types</li>
<li>Contracts, NDAs, proposals</li>
<li>PDF, Word &amp; HTML export</li>
<li>Custom logo &amp; branding</li>
<li>Priority support</li>
</ul>
<button class="btn-checkout primary" id="btnCheckoutPro" onclick="startCheckout('pro')"><i class="fas fa-bolt"></i> Start Free Trial</button>
</div>
<div class="plan-card">
<div class="plan-name">Business</div>
<div class="plan-price">$24.99<span>/month</span></div>
<div class="plan-trial">No trial ‚Äî instant access</div>
<div class="plan-desc">For teams and growing businesses.</div>
<ul>
<li>Unlimited AI credits</li>
<li>Everything in Pro</li>
<li>Team collaboration (Coming Soon)</li>
<li>CRM &amp; Sheets auto-fill (Coming Soon)</li>
<li>API access (Coming Soon)</li>
<li>Dedicated account manager</li>
</ul>
<button class="btn-checkout outline" id="btnCheckoutBiz" onclick="startCheckout('business')"><i class="fas fa-building"></i> Get Started</button>
</div>
</div>
<div class="upgrade-footer">Secure payment via Stripe. Cancel your subscription anytime from your account settings.</div>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
var SUPABASE_URL='https://mupeqeuuwdmkndvtbhzb.supabase.co';
var SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
window.__supabase = sb;
var currentUser=null;
var currentProfile=null;

function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},3000)}

function toggleMenu(){var d=document.getElementById('userDropdown');d.style.display=d.style.display==='none'?'block':'none'}
document.addEventListener('click',function(e){var d=document.getElementById('userDropdown');var a=document.getElementById('userAvatar');if(!d.contains(e.target)&&e.target!==a)d.style.display='none'});

async function init(){
try{
var r=await sb.auth.getSession();
if(!r.data.session||!r.data.session.user){window.location.href='/';return}
currentUser=r.data.session.user;
var p=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
if(p.data)currentProfile=p.data;
renderDashboard();
loadSavedDocuments();
// Fire auth-callback for session logging + welcome email
fetch("/api/auth-callback", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    userId: currentUser.id,
    email: currentUser.email,
    name: (currentProfile && currentProfile.display_name) || currentUser.email
  })
}).catch(function() {});
}catch(e){console.error('Init error:',e);window.location.href='/'}
}

function renderDashboard(){
document.getElementById('loadingState').style.display='none';
document.getElementById('dashContent').style.display='block';
var name=(currentProfile&&currentProfile.display_name)||currentUser.email.split('@')[0];
document.getElementById('userName').textContent=name;
document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
document.getElementById('menuName').textContent=name;
document.getElementById('menuEmail').textContent=currentUser.email;
document.getElementById('acctEmail').textContent=currentUser.email;
document.getElementById('acctName').textContent=name;
var plan=(currentProfile&&currentProfile.plan)||'free';
var planLabel=plan.charAt(0).toUpperCase()+plan.slice(1);
document.getElementById('statPlan').textContent=planLabel;
document.getElementById('menuPlan').textContent=planLabel;
document.getElementById('menuPlan').className='plan-badge plan-'+plan;
document.getElementById('acctPlan').textContent=planLabel;
document.getElementById('acctPlan').className='plan-badge plan-'+plan;
if(currentUser.created_at){var d=new Date(currentUser.created_at);document.getElementById('acctSince').textContent=d.toLocaleDateString('en-US',{month:'long',year:'numeric'});
showUpgradeElements(plan);
if(currentProfile&&currentProfile.role==='admin'){var al=document.getElementById('menuAdminLink');if(al)al.style.display='block';}
}
}

function loadSavedDocuments(){
  const container=document.getElementById('docsGrid');
  if(!container)return;
  // Get current user ID for filtering
  let currentUserId = null;
  try {
    const sessionStr = localStorage.getItem('sb-mupeqeuuwdmkndvtbhzb-auth-token');
    if(sessionStr){const sData=JSON.parse(sessionStr);currentUserId=sData?.user?.id||sData?.currentSession?.user?.id||null;}
  } catch(e){}
  
  let docs=[];
  for(let i=0;i<localStorage.length;i++){
    const key=localStorage.key(i);
    if(key.startsWith('dmf_doc_')){
      try{
        const d=JSON.parse(localStorage.getItem(key));
        // Migration: if doc has no user_id, tag it with current user
        if(!d.user_id && currentUserId){
          d.user_id=currentUserId;
          localStorage.setItem(key,JSON.stringify(d));
        }
        // Only show docs belonging to current user (or untagged if no user)
        if(currentUserId && d.user_id && d.user_id !== currentUserId) continue;
        docs.push({key:key,data:d});
      }catch(e){}
    }
  }
  let html='<div class="doc-card new-doc" onclick="window.location.href=\'/editor.html\'"><div class="doc-preview" style="display:flex;align-items:center;justify-content:center;"><i class="fas fa-plus" style="font-size:2em;color:var(--primary);"></i></div><div class="doc-info"><h4>Create New Document</h4></div></div>';
  document.getElementById('statDocs').textContent=docs.length;
  docs.sort((a,b)=>(b.data.updated_at||b.data.created_at||0)-(a.data.updated_at||a.data.created_at||0));
  docs.forEach(({key,data:d})=>{
    const title=d.title||'Untitled Document';
    const date=d.updated_at?new Date(d.updated_at).toLocaleDateString():'';
    const rawHtml = d.html || d.content || '';
    const previewText = rawHtml.replace(/<[^>]*>/g,'').substring(0,80);
    html+='<div class="doc-card" onclick="openDoc(\'' + key.replace(/'/g,"\\'") + '\')"><div class="doc-preview"><div class="doc-preview-inner">' + rawHtml + '</div></div><div class="doc-info"><h4>'+title.substring(0,40)+'</h4><p class="doc-date">'+(date||'Draft')+'</p><p class="doc-excerpt">'+previewText+'</p></div></div>';
  });
  container.innerHTML=html;
}

function openDoc(key){
sessionStorage.setItem('dmf_load_doc',key);
window.location.href='/editor.html';
}

function downloadDoc(key){
try{
var doc=JSON.parse(localStorage.getItem(key));
if(doc&&doc.content){
var canvas=document.createElement('div');
canvas.innerHTML=doc.content;
showToast('Opening document for download...');
sessionStorage.setItem('dmf_load_doc',key);
window.location.href='/editor.html?action=pdf';
}
}catch(e){showToast('Error loading document')}
}

function deleteDoc(key,event){
event.stopPropagation();
showToast('To delete documents, please use the editor. Documents are stored locally for your privacy.');
}

async function handleLogout(){
await sb.auth.signOut();
currentUser=null;currentProfile=null;
window.location.href='/';
}


function openUpgradeModal() {
  document.getElementById('upgradeOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeUpgradeModal() {
  document.getElementById('upgradeOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

async function startCheckout(plan) {
  var btn = document.getElementById(plan === 'pro' ? 'btnCheckoutPro' : 'btnCheckoutBiz');
  var origHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Redirecting...';
  try {
    var resp = await fetch('/api/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plan: plan, userId: currentUser.id, userEmail: currentUser.email })
    });
    var data = await resp.json();
    if (resp.status === 409) {
      showToast(data.message || 'You already have an active subscription.');
      closeUpgradeModal();
      btn.disabled = false;
      btn.innerHTML = origHTML;
      return;
    }
    if (!resp.ok) {
      showToast('Error: ' + (data.error || 'Could not start checkout'));
      btn.disabled = false;
      btn.innerHTML = origHTML;
      return;
    }
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast('Error: ' + (data.error || 'Could not start checkout'));
      btn.disabled = false;
      btn.innerHTML = origHTML;
    }
  } catch (e) {
    showToast('Connection error. Please try again.');
    btn.disabled = false;
    btn.innerHTML = origHTML;
  }
}

function showUpgradeElements(plan) {
  var isFree = !plan || plan === 'free';
  var banner = document.getElementById('upgradeBanner');
  var navBtn = document.getElementById('navUpgradeBtn');
  var menuLink = document.getElementById('menuUpgradeLink');
  if (banner) banner.style.display = isFree ? 'flex' : 'none';
  if (navBtn) navBtn.style.display = isFree ? 'inline-flex' : 'none';
  if (menuLink) menuLink.style.display = isFree ? 'block' : 'none';
  var subRow = document.getElementById('subscriptionRow');
  if (subRow) {
    var isPaid = (plan === 'pro' || plan === 'business');
    var hasStripeId = currentProfile && currentProfile.stripe_customer_id;
    if (isPaid && !hasStripeId) {
      subRow.style.display = '';
      subRow.querySelector('.value').innerHTML = '<span style="font-size:13px;color:var(--text-muted)"><i class="fas fa-shield-alt"></i> Plan managed by admin</span>';
    } else if (isPaid) {
      subRow.style.display = '';
    } else {
      subRow.style.display = 'none';
    }
  }
}


// Handle payment success redirect from Stripe
var urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('payment') === 'success') {
  var sessionId = urlParams.get('session_id');
  window.history.replaceState({}, '', '/dashboard.html');
  if (sessionId) {
    (async function() {
      try {
        var user = (await sb.auth.getUser()).data.user;
        if (user) {
          var resp = await fetch('/api/verify-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: sessionId, userId: user.id })
          });
          var data = await resp.json();
          if (data.plan && data.customerId) {
            await sb.from('profiles').update({
              plan: data.plan,
              stripe_customer_id: data.customerId
            }).eq('id', user.id);
            showToast('Welcome to ' + data.plan.charAt(0).toUpperCase() + data.plan.slice(1) + '! Your subscription is active.');
            setTimeout(function() { location.reload(); }, 1500);
          } else {
            showToast('Payment successful! Your plan will update shortly.');
          }
        }
      } catch(e) {
        console.error('Payment verification error:', e);
        showToast('Payment received! Plan updating...');
      }
    })();
  } else {
    showToast('Payment successful! Your plan has been upgraded.');
  }
}
if (urlParams.get('payment') === 'cancelled') {
  window.history.replaceState({}, '', '/dashboard.html');
  showToast('Checkout was cancelled. No charges were made.');
}

// Manage subscription via Stripe Customer Portal
async function manageSubscription() {
  var user = (await sb.auth.getUser()).data.user;
  if (!user) return;

  try {
    var resp = await fetch('/api/create-portal-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: user.id })
    });
    var data = await resp.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast(data.error || 'Could not open subscription portal. Please try again.');
    }
  } catch(e) {
    showToast('Error: ' + e.message);
  }
}
init();


// Load site banner
async function loadSiteBanner() {
  try {
    const { data } = await sb.from("site_banners").select("*").eq("is_active", true).order("created_at", { ascending: false }).limit(1);
    if (data && data.length) {
      const b = data[0];
      if (b.ends_at && new Date(b.ends_at) < new Date()) return;
      document.getElementById("siteBanner").innerHTML = '<div style="background:' + (b.bg_color || "#c99532") + ';color:' + (b.text_color || "#fff") + ';padding:10px 20px;text-align:center;font-size:14px;font-weight:500">' + b.message + (b.link_url ? ' <a href="' + b.link_url + '" style="color:inherit;text-decoration:underline">' + (b.link_text || "Learn more") + '</a>' : '') + (b.is_dismissible ? ' <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:10px;font-size:18px">&times;</button>' : '') + '</div>';
    }
  } catch(e) { console.log("Banner load error:", e); }
}

// Load unread message count
async function loadUnreadCount() {
  try {
    const user = (await sb.auth.getUser()).data.user;
    if (!user) return;
    const { count } = await sb.from("messages").select("*", { count: "exact", head: true }).eq("recipient_id", user.id).eq("is_read", false);
    const badge = document.getElementById("inboxBadge");
    if (badge && count > 0) { badge.textContent = count; badge.style.display = "inline"; }
  } catch(e) {}
}

loadSiteBanner();
loadUnreadCount();

// Referral System
async function loadReferralInfo() {
  try {
    const {data:{session}} = await sb.auth.getSession();
    if (!session) return;
    const userId = session.user.id;
    
    // Check if user has a referral code, generate one if not
    const {data: profile} = await sb.from('profiles').select('referral_code').eq('id', userId).single();
    let code = profile?.referral_code;
    if (!code) {
      code = 'DMF' + Math.random().toString(36).substring(2, 8).toUpperCase();
      await sb.from('profiles').update({referral_code: code}).eq('id', userId);
    }
    
    const link = 'https://www.draftmyforms.com/?ref=' + code;
    const linkEl = document.getElementById('referralLink');
    if (linkEl) linkEl.value = link;
    
    // Get referral stats
    const {data: referrals} = await sb.from('referrals').select('id,status').eq('referrer_id', userId);
    const total = referrals ? referrals.length : 0;
    const rewarded = referrals ? referrals.filter(r => r.status === 'rewarded').length : 0;
    const countEl = document.getElementById('refCount');
    const rewardsEl = document.getElementById('refRewards');
    if (countEl) countEl.textContent = total;
    if (rewardsEl) rewardsEl.textContent = rewarded;
  } catch(e) { console.error('Referral load error:', e); }
}


    async function loadAICredits() {
      try {
        var session = (await sb.auth.getSession()).data.session;
        if (!session) return;
        var uid = session.user.id;
        var { data: p } = await sb.from('profiles').select('plan, plan_override, ai_credits_used, ai_credits_reset_at, ai_credits_limit').eq('id', uid).single();
        if (!p) return;
        var effectivePlan = p.plan_override || p.plan || 'Free';
    var limits = { free: 5, starter: 50, pro: 50, professional: 50, business: Infinity, enterprise: Infinity, Free: 5, Starter: 50, Professional: 200, Enterprise: Infinity };
        var limit = p.ai_credits_limit || limits[effectivePlan] || 5;
        var used = p.ai_credits_used || 0;
    var isUnlimited = (limit === Infinity || limit >= 999999);
    var remaining = isUnlimited ? Infinity : Math.max(0, limit - used);
    var pct = (!isUnlimited && limit > 0) ? Math.min(100, (used / limit) * 100) : 0;
    var bar = document.getElementById('creditBar');
    var count = document.getElementById('creditCount');
    var planEl = document.getElementById('creditPlan');
    var resetEl = document.getElementById('creditReset');
    if (bar) { if (isUnlimited) { bar.parentElement.style.display = 'none'; } else { bar.parentElement.style.display = ''; bar.style.width = pct + '%'; if (pct > 80) bar.style.background = 'var(--danger)'; else bar.style.background = 'var(--gold)'; } }
    if (count) count.textContent = isUnlimited ? '\u221e' : remaining + ' / ' + limit;
    if (planEl) planEl.textContent = effectivePlan.toLowerCase() + ' Plan' + (isUnlimited ? ' (Unlimited)' : '');
    if (resetEl) { if (isUnlimited) { resetEl.style.display = 'none'; } else if (p.ai_credits_reset_at) { resetEl.style.display = ''; var rd = new Date(p.ai_credits_reset_at); rd.setMonth(rd.getMonth() + 1); resetEl.textContent = 'Resets ' + rd.toLocaleDateString(); } }
      } catch(e) { console.error('loadAICredits error:', e); }
    }

function copyReferralLink() {
  const linkEl = document.getElementById('referralLink');
  if (linkEl) {
    navigator.clipboard.writeText(linkEl.value).then(() => {
      const btn = event.target;
      btn.textContent = 'Copied!';
      btn.style.background = '#4CAF50';
      setTimeout(() => { btn.textContent = 'Copy Link'; btn.style.background = '#C8922A'; }, 2000);
    });
  }
}

// Call on load
setTimeout(() => { loadReferralInfo();
        loadAICredits(); }, 500);

// Process stored referral code on first login
async function processReferral() {
  try {
    const refCode = localStorage.getItem('dmf_referral');
    if (!refCode) return;
    
    const {data:{session}} = await sb.auth.getSession();
    if (!session) return;
    const userId = session.user.id;
    
    // Check if already processed (user has referred_by set)
    const {data: profile} = await sb.from('profiles').select('referred_by').eq('id', userId).single();
    if (profile?.referred_by) {
      localStorage.removeItem('dmf_referral');
      localStorage.removeItem('dmf_referral_time');
      return;
    }
    
    // Find the referrer by code
    const {data: referrer} = await sb.from('profiles').select('id').eq('referral_code', refCode).single();
    if (!referrer || referrer.id === userId) {
      localStorage.removeItem('dmf_referral');
      return;
    }
    
    // Record the referral
    await sb.from('profiles').update({referred_by: referrer.id}).eq('id', userId);
    await sb.from('referrals').insert({
      referrer_id: referrer.id,
      referred_id: userId,
      referral_code: refCode,
      status: 'completed',
      completed_at: new Date().toISOString()
    });
    
    localStorage.removeItem('dmf_referral');
    localStorage.removeItem('dmf_referral_time');
  } catch(e) { console.error('Referral process error:', e); }
}
setTimeout(() => { processReferral(); }, 1000);

// ===== ACTIVE DAY TRACKING FOR TRIAL ELIGIBILITY =====
(function logDashboardActivity() {
  try {
    var session = JSON.parse(localStorage.getItem('sb-mupeqeuuwdmkndvtbhzb-auth-token') || '{}');
    var token = session.access_token;
    var userId = session.user ? session.user.id : null;
    if (!token || !userId) return;
    fetch('/api/log-activity', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ userId: userId, action: 'dashboard_visit' })
    }).catch(function() {});
  } catch(e) {}
})();
</script>
<div style="text-align:center;padding:8px;font-size:11px;color:var(--text-muted);border-top:1px solid var(--border-light);margin-top:20px">A product of <strong>WMK Speciality Services L.L.C.</strong></div>

<script>
function setTheme(t){localStorage.setItem('draftmyforms-theme',t);var r=t;if(t==='system'){r=window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'}document.documentElement.setAttribute('data-theme',r);updateThemeButtons(t)}
function updateThemeButtons(t){var btns=document.querySelectorAll('#themeToggle button');btns.forEach(function(b,i){var vals=['light','dark','system'];b.classList.toggle('active',vals[i]===t)})}
function initTheme(){var saved=localStorage.getItem('draftmyforms-theme')||'system';updateThemeButtons(saved);window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',function(){if((localStorage.getItem('draftmyforms-theme')||'system')==='system'){setTheme('system')}})}
initTheme();
</script>
</body>
</html>
