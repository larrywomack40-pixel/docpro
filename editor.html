<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Document Editor | DraftMyForms</title>
<meta name="description" content="Create, edit, and design professional documents with AI assistance. Free document editor by DraftMyForms.">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%23c99532'/%3E%3Cstop offset='100%25' stop-color='%23e8b94a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='16' y='24' text-anchor='middle' font-size='24' fill='url(%23g)'%3E%E2%9C%A6%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Caveat:wght@400;600&family=Homemade+Apple&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--gold:#c99532;--gold-light:#e8b94a;--gold-dark:#a67a28;
--paper:#f9f4f3;--paper-dark:#f3ede8;
--card:#fffcf9;--card-border:#e8ddd4;
--text:#2d2926;--text-muted:#8a7f76;
--success:#3a6633;--danger:#c24b3b;
--sidebar-w:280px;--toolbar-h:48px;
--font-heading:'Playfair Display',Georgia,serif;
--font-body:'DM Sans',-apple-system,sans-serif;
--font-mono:'DM Mono',monospace;
}
body{font-family:var(--font-body);background:var(--paper);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
/* TOP NAV */
.top-nav{display:flex;align-items:center;gap:12px;padding:8px 16px;background:#fff;border-bottom:1px solid var(--card-border);z-index:100;min-height:52px}
.top-nav .brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--gold);font-family:var(--font-heading);font-weight:700;font-size:18px}
.top-nav .brand span{color:var(--text)}
.doc-title-input{border:none;background:transparent;font-size:15px;font-family:var(--font-body);color:var(--text);padding:6px 12px;border-radius:6px;flex:1;max-width:300px}
.doc-title-input:hover,.doc-title-input:focus{background:var(--paper);outline:none}
.nav-actions{display:flex;align-items:center;gap:8px;margin-left:auto}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-family:var(--font-body);font-size:13px;font-weight:500;transition:all .2s}
.btn-gold{background:var(--gold);color:#fff}.btn-gold:hover{background:var(--gold-dark)}
.btn-outline{background:transparent;border:1px solid var(--card-border);color:var(--text)}.btn-outline:hover{background:var(--paper)}
.btn-ghost{background:transparent;color:var(--text-muted);padding:8px}.btn-ghost:hover{color:var(--text);background:var(--paper)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{opacity:.9}
.btn-success{background:var(--success);color:#fff}.btn-success:hover{opacity:.9}
.btn-sm{padding:5px 10px;font-size:12px}
/* MAIN LAYOUT */
.main-layout{display:flex;flex:1;overflow:hidden}
/* AI SIDEBAR */
.ai-sidebar{width:var(--sidebar-w);background:#fff;border-right:1px solid var(--card-border);display:flex;flex-direction:column;transition:width .3s;overflow:hidden}
.ai-sidebar.collapsed{width:0;border:none}
.ai-header{padding:12px 16px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between}
.ai-header h3{font-family:var(--font-heading);font-size:15px;display:flex;align-items:center;gap:6px}
.ai-header h3 .star{color:var(--gold)}
.ai-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.ai-msg{padding:10px 12px;border-radius:10px;font-size:13px;line-height:1.5;max-width:95%}
.ai-msg.system{background:linear-gradient(135deg,#fdf6e8,#fef9f0);border:1px solid #f0ddb8;align-self:flex-start}
.ai-msg.user{background:var(--gold);color:#fff;align-self:flex-end;border-radius:10px 10px 2px 10px}
.ai-msg.assistant{background:#f5f0eb;align-self:flex-start;border-radius:10px 10px 10px 2px}
.ai-input-area{padding:12px;border-top:1px solid var(--card-border);display:flex;flex-direction:column;gap:8px}
.ai-prompt-input{width:100%;border:1px solid var(--card-border);border-radius:8px;padding:10px 12px;font-size:13px;font-family:var(--font-body);resize:none;min-height:60px;outline:none;transition:border .2s}
.ai-prompt-input:focus{border-color:var(--gold)}
.ai-quick-actions{display:flex;flex-wrap:wrap;gap:4px}
.ai-quick-btn{padding:4px 8px;border-radius:12px;border:1px solid var(--card-border);background:#fff;font-size:11px;cursor:pointer;color:var(--text-muted);transition:all .2s}
.ai-quick-btn:hover{border-color:var(--gold);color:var(--gold)}
/* EDITOR AREA */
.editor-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
/* TOOLBAR */
.editor-toolbar{display:flex;align-items:center;gap:2px;padding:4px 12px;background:#fff;border-bottom:1px solid var(--card-border);flex-wrap:wrap;min-height:var(--toolbar-h)}
.toolbar-group{display:flex;align-items:center;gap:1px;padding:0 6px;border-right:1px solid var(--card-border)}
.toolbar-group:last-child{border-right:none}
.tool-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;border-radius:6px;cursor:pointer;color:var(--text-muted);font-size:13px;transition:all .15s}
.tool-btn:hover{background:var(--paper);color:var(--text)}
.tool-btn.active{background:var(--gold);color:#fff}
.tool-btn select{border:none;background:transparent;font-size:12px;font-family:var(--font-body);cursor:pointer;outline:none;color:inherit;padding:2px}
.tool-btn input[type="color"]{width:20px;height:20px;border:none;cursor:pointer;background:transparent;padding:0}
.font-select{border:1px solid var(--card-border);border-radius:4px;padding:4px 6px;font-size:12px;font-family:var(--font-body);outline:none;background:#fff;max-width:120px}
.size-select{border:1px solid var(--card-border);border-radius:4px;padding:4px 4px;font-size:12px;outline:none;background:#fff;width:50px}
/* EDITOR + PREVIEW SPLIT */
.editor-split{flex:1;display:flex;overflow:hidden}
.edit-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
.canvas-wrapper{flex:1;overflow:auto;padding:32px;background:var(--paper);display:flex;justify-content:center}
.doc-canvas{width:816px;min-height:1056px;background:#fff;box-shadow:0 2px 20px rgba(0,0,0,.08);border-radius:4px;padding:72px 72px 96px;outline:none;font-size:14px;line-height:1.7;color:var(--text);position:relative}
.doc-canvas:empty::before{content:'Start typing or use AI to create your document...';color:var(--text-muted);font-style:italic;pointer-events:none}
.doc-canvas h1{font-family:var(--font-heading);font-size:28px;margin-bottom:16px;color:var(--text)}
.doc-canvas h2{font-family:var(--font-heading);font-size:22px;margin-bottom:12px;color:var(--text)}
.doc-canvas h3{font-family:var(--font-heading);font-size:18px;margin-bottom:8px;color:var(--text)}
.doc-canvas table{width:100%;border-collapse:collapse;margin:16px 0}
.doc-canvas table th,.doc-canvas table td{border:1px solid var(--card-border);padding:8px 12px;text-align:left;font-size:13px}
.doc-canvas table th{background:var(--gold);color:#fff;font-weight:600}
.doc-canvas img{max-width:100%;border-radius:4px}
.doc-canvas .logo-placeholder{width:120px;height:60px;border:2px dashed var(--card-border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-muted);font-size:11px;transition:all .2s}
.doc-canvas .logo-placeholder:hover{border-color:var(--gold);color:var(--gold)}
/* PREVIEW PANE */
.preview-divider{width:4px;background:var(--card-border);cursor:col-resize;transition:background .2s}
.preview-divider:hover{background:var(--gold)}
.preview-pane{width:45%;display:flex;flex-direction:column;overflow:hidden;background:var(--paper)}
.preview-header{padding:8px 16px;background:#fff;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between;font-size:13px;font-weight:500}
.preview-frame{flex:1;overflow:auto;padding:24px;display:flex;justify-content:center}
.preview-doc{width:100%;max-width:700px;background:#fff;box-shadow:0 1px 10px rgba(0,0,0,.06);border-radius:4px;padding:48px;min-height:600px}
/* UPLOAD OVERLAY */
.upload-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;align-items:center;justify-content:center}
.upload-overlay.active{display:flex}
.upload-modal{background:#fff;border-radius:16px;padding:32px;max-width:500px;width:90%;text-align:center}
.upload-modal h2{font-family:var(--font-heading);margin-bottom:8px}
.upload-modal p{color:var(--text-muted);font-size:14px;margin-bottom:24px}
.upload-zone{border:2px dashed var(--card-border);border-radius:12px;padding:48px 24px;cursor:pointer;transition:all .2s}
.upload-zone:hover{border-color:var(--gold);background:rgba(201,149,50,.03)}
.upload-zone i{font-size:36px;color:var(--gold);margin-bottom:12px}
.upload-zone p{font-size:13px}
/* TEMPLATE PANEL */
.template-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;align-items:center;justify-content:center}
.template-panel.active{display:flex}
.template-modal{background:#fff;border-radius:16px;width:90%;max-width:900px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column}
.template-modal-header{padding:20px 24px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between}
.template-modal-header h2{font-family:var(--font-heading)}
.template-tabs{display:flex;gap:4px;padding:12px 24px;border-bottom:1px solid var(--card-border);overflow-x:auto}
.template-tab{padding:6px 14px;border-radius:20px;border:1px solid var(--card-border);background:#fff;font-size:13px;cursor:pointer;white-space:nowrap;transition:all .2s}
.template-tab.active,.template-tab:hover{background:var(--gold);color:#fff;border-color:var(--gold)}
.template-grid{flex:1;overflow-y:auto;padding:24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));grid-auto-rows:min-content;gap:16px}
.template-card{border:1px solid var(--card-border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .2s}
.template-card:hover{border-color:var(--gold);box-shadow:0 4px 16px rgba(201,149,50,.15);transform:translateY(-2px)}
.template-card .preview{height:120px;background:var(--paper);overflow:hidden;padding:8px;display:flex;align-items:center;justify-content:center}
.template-card .preview iframe{width:200%;height:200%;transform:scale(.5);transform-origin:top left;pointer-events:none;border:none}
.template-card .info{padding:10px 12px;border-top:1px solid var(--card-border)}
.template-card .info h4{font-size:13px;font-weight:600;margin-bottom:2px}
.template-card .info span{font-size:11px;color:var(--text-muted)}
.template-card .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-left:4px}
.badge-free{background:#e8f5e2;color:var(--success)}
.badge-pro{background:#fef3d8;color:var(--gold-dark)}
.badge-biz{background:#fde8e6;color:var(--danger)}
/* STATUS BAR */
.status-bar{display:flex;align-items:center;justify-content:space-between;padding:4px 16px;background:#fff;border-top:1px solid var(--card-border);font-size:11px;color:var(--text-muted)}
/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;z-index:9999;transform:translateY(100px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
/* LOGO MODAL */
.logo-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;align-items:center;justify-content:center}
.logo-modal.active{display:flex}
.logo-modal-content{background:#fff;border-radius:16px;padding:32px;max-width:480px;width:90%}
/* AI LOADING */
.ai-loading{display:flex;align-items:center;gap:8px;padding:10px;font-size:12px;color:var(--text-muted)}
.ai-loading .dots span{animation:blink 1.4s infinite both}
.ai-loading .dots span:nth-child(2){animation-delay:.2s}
.ai-loading .dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
/* MOBILE */

  /* MOBILE AI CHAT (Issue 12) */
  .mobile-ai-btn{display:none;position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--gold);color:#fff;border:none;font-size:22px;box-shadow:0 4px 20px rgba(201,149,50,.4);z-index:300;cursor:pointer;transition:transform .2s}
  .mobile-ai-btn:active{transform:scale(.9)}
  .mobile-ai-overlay{display:none;position:fixed;bottom:0;left:0;right:0;top:0;background:rgba(0,0,0,.4);z-index:400}
  .mobile-ai-overlay.active{display:block}
  .mobile-ai-sheet{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:16px 16px 0 0;max-height:70vh;display:flex;flex-direction:column;z-index:401;transform:translateY(100%);transition:transform .3s ease}
  .mobile-ai-sheet.active{transform:translateY(0)}
  .mobile-ai-sheet .sheet-header{padding:12px 16px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between}
  .mobile-ai-sheet .sheet-header h3{font-size:15px;font-family:var(--font-heading)}
  .mobile-ai-sheet .sheet-messages{flex:1;overflow-y:auto;padding:12px;max-height:40vh}
  .mobile-ai-sheet .sheet-input{padding:12px;border-top:1px solid var(--card-border);display:flex;gap:8px}
  .mobile-ai-sheet .sheet-input input{flex:1;padding:12px;border:1px solid var(--card-border);border-radius:24px;font-size:14px;outline:none;font-family:var(--font-body)}
  .mobile-ai-sheet .sheet-input input:focus{border-color:var(--gold)}
  .mobile-ai-sheet .sheet-input button{width:44px;height:44px;border-radius:50%;background:var(--gold);color:#fff;border:none;font-size:16px;cursor:pointer}
  @media(max-width:768px){
    .mobile-ai-btn{display:flex;align-items:center;justify-content:center}
    .editor-toolbar{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;gap:0}
    .toolbar-group{flex-shrink:0;padding:0 4px}
    .tool-btn{width:28px;height:28px;font-size:11px}
    .font-select{max-width:90px;font-size:11px}
    .size-select{width:40px;font-size:11px}
    .top-nav .nav-actions{gap:4px}
    .top-nav .nav-actions .btn{padding:6px 8px;font-size:11px}
    .top-nav .nav-actions .btn-sm{padding:4px 6px}
    .doc-title-input{max-width:120px;font-size:13px}
  }
  @media(max-width:768px){
.ai-sidebar{position:fixed;left:-100%;top:0;bottom:0;z-index:200;width:85%;max-width:320px;transition:left .3s}
.ai-sidebar.open{left:0}
.preview-pane,.preview-divider{display:none!important}
.doc-canvas{width:100%;padding:24px;min-height:auto}
.canvas-wrapper{padding:8px}
.top-nav{flex-wrap:wrap}
.template-grid{grid-template-columns:1fr 1fr}
.editor-toolbar{overflow-x:auto}
}

/* Print styles - hide everything except document content */
@media print {
  body { background: white !important; overflow: visible !important; height: auto !important; }
  .top-bar, .editor-toolbar, .ai-sidebar, .live-preview, .mobile-ai-btn,
  #mobileAiOverlay, #mobileAiSheet, .template-chips, .ai-input-area,
  .editor-footer, .toast, #uploadModal, #templateModal, #logoModal,
  .preview-panel, nav, footer, .upgrade-banner { display: none !important; }
  .editor-layout { display: block !important; }
  .editor-main { width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
  .doc-canvas-wrapper { overflow: visible !important; height: auto !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; }
  .doc-canvas {
    width: 100% !important; max-width: 100% !important;
    min-height: auto !important; height: auto !important;
    box-shadow: none !important; border: none !important; border-radius: 0 !important;
    padding: 0 !important; margin: 0 !important;
    -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  .doc-canvas * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
  .doc-canvas table { page-break-inside: avoid; }
  .doc-canvas img { max-width: 100%; page-break-inside: avoid; }
  .doc-canvas h1, .doc-canvas h2, .doc-canvas h3 { page-break-after: avoid; }
  @page { margin: 20mm; }
}

/* E-Signature Modal */
.sig-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center}
.sig-overlay.active{display:flex}
.sig-modal{background:#fff;border-radius:12px;width:560px;max-width:95vw;max-height:90vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.sig-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e8ddd4}
.sig-header h3{margin:0;font-family:var(--font-heading);font-size:18px;color:var(--text)}
.sig-close{background:none;border:none;font-size:20px;cursor:pointer;color:#8a7f76}
.sig-tabs{display:flex;gap:0;border-bottom:1px solid #e8ddd4}
.sig-tab{flex:1;padding:10px;text-align:center;background:none;border:none;cursor:pointer;font-size:13px;color:#8a7f76;border-bottom:2px solid transparent;transition:all 0.2s}
.sig-tab.active{color:var(--gold);border-bottom-color:var(--gold);font-weight:600}
.sig-body{padding:20px}
.sig-canvas-wrap{border:2px dashed #d4ccc4;border-radius:8px;background:#faf9f7;position:relative;margin-bottom:12px}
.sig-canvas-wrap canvas{width:100%;height:180px;display:block;cursor:crosshair}
.sig-type-input{width:100%;padding:16px;font-size:32px;border:2px dashed #d4ccc4;border-radius:8px;background:#faf9f7;text-align:center;outline:none}
.sig-type-input:focus{border-color:var(--gold)}
.sig-font-select{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.sig-font-opt{padding:6px 12px;border:1px solid #d4ccc4;border-radius:6px;background:#fff;cursor:pointer;font-size:14px}
.sig-font-opt.active{border-color:var(--gold);background:#fef8ee}
.sig-preview{text-align:center;padding:20px;border:2px dashed #d4ccc4;border-radius:8px;margin-top:12px;min-height:80px;display:flex;align-items:center;justify-content:center}
.sig-preview img{max-width:100%;max-height:100px}
.sig-actions{display:flex;gap:10px;padding:16px 20px;border-top:1px solid #e8ddd4;justify-content:space-between}
.sig-btn{padding:8px 20px;border-radius:8px;border:none;cursor:pointer;font-size:14px;font-weight:500}
.sig-btn-clear{background:#f5f0eb;color:#8a7f76}
.sig-btn-insert{background:var(--gold);color:#fff}
.sig-btn-insert:hover{background:var(--gold-dark)}
.sig-saved-list{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px}
.sig-saved-item{border:2px solid #e8ddd4;border-radius:8px;padding:8px 12px;cursor:pointer;background:#fff;text-align:center;min-width:120px}
.sig-saved-item:hover,.sig-saved-item.selected{border-color:var(--gold);background:#fef8ee}
.sig-saved-item img{max-width:140px;max-height:50px}
.sig-saved-item .sig-name{font-size:11px;color:#8a7f76;margin-top:4px}
/* === Document Canvas Page Constraints === */
#docCanvas {
  max-width: 8.5in;
  min-height: 11in;
  margin: 0 auto;
  padding: 0.75in 0.85in;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow-wrap: break-word;
  word-wrap: break-word;
  word-break: break-word;
}
#docCanvas *, [contenteditable] * {
  max-width: 100%;
  overflow-wrap: break-word;
}
#docCanvas table {
  table-layout: fixed;
  width: 100%;
  word-wrap: break-word;
}
/* Live Preview overflow fix */
.live-preview, .preview-content, .preview-frame {
  overflow-wrap: break-word;
  word-wrap: break-word;
  overflow-x: hidden;
  max-width: 100%;
}
/* === Mobile Responsive ‚Äî Editor === */
@media (max-width: 768px) {
  .ai-sidebar, #aiSidebar {
    position: fixed;
    left: -100%;
    top: 0;
    width: 85vw;
    height: 100vh;
    z-index: 1000;
    transition: left 0.3s ease;
    background: var(--paper, #fff);
  }
  .ai-sidebar.open, #aiSidebar:not(.collapsed) {
    left: 0;
  }
  #docCanvas {
    width: 100% !important;
    max-width: 100vw !important;
    padding: 16px !important;
    font-size: 14px !important;
    min-height: auto;
    box-shadow: none;
  }
  .toolbar, .editor-toolbar {
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    padding: 8px;
  }
  .toolbar button, .editor-toolbar button {
    min-width: 36px;
    min-height: 36px;
    padding: 4px !important;
    font-size: 12px !important;
  }
  .live-preview, .preview-panel, #previewPanel {
    display: none !important;
  }
  body, .main-content {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }

        /* === Template Modal ‚Äî Mobile Fix === */
        .template-panel {
                    padding: 10px;
        }
        .template-modal {
                    width: 100% !important;
                    max-width: 100vw !important;
                    max-height: 95vh !important;
                    border-radius: 12px 12px 0 0 !important;
                    margin: 0;
        }
        .template-modal-header {
                    padding: 14px 16px !important;
                    flex-wrap: wrap;
                    gap: 10px;
        }
        .template-modal-header h2 {
                    font-size: 20px !important;
                    width: 100%;
        }
        .template-modal-header > div {
                    width: 100%;
                    display: flex;
                    gap: 8px;
        }
        .template-modal-header input {
                    flex: 1;
                    min-width: 0;
        }
        .template-tabs {
                    padding: 8px 12px !important;
                    gap: 6px !important;
                    overflow-x: auto !important;
                    -webkit-overflow-scrolling: touch;
                    scroll-snap-type: x mandatory;
                    scrollbar-width: none;
                    flex-shrink: 0;
        }
        .template-tabs::-webkit-scrollbar {
                    display: none;
        }
        .template-tab {
                    padding: 10px 16px !important;
                    font-size: 14px !important;
                    min-height: 40px !important;
                    flex-shrink: 0;
                    scroll-snap-align: start;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
        }
        .template-grid {
                    padding: 12px !important;
            grid-template-columns: 1fr 1fr !important;
                    gap: 10px !important;
        }
        .template-card .preview {
                    height: 80px !important;
        }
        .template-card .info {
                    padding: 8px 10px !important;
        }
        .template-card .info h4 {
                    font-size: 12px !important;
        }
}

/* === TASK 1: Toolbar Button Polish === */
.nav-actions .btn.btn-outline.btn-sm { background: #fff; border: 1.5px solid #E5E5E5; color: #555; border-radius: 6px; padding: 7px 14px; font-weight: 600; font-size: 13px; transition: all 0.15s ease; gap: 6px; }
.nav-actions .btn.btn-outline.btn-sm:hover { background: #F5F5F5; border-color: #CCC; color: #1B3A5C; }
.nav-actions .btn.btn-outline.btn-sm .fa-file-pdf { color: #D32F2F; }
.nav-actions .btn.btn-outline.btn-sm[onclick*="PDF"] { border-color: #D32F2F; color: #D32F2F; }
.nav-actions .btn.btn-outline.btn-sm[onclick*="PDF"]:hover { background: #FFF5F5; border-color: #B71C1C; }
.nav-actions .btn.btn-outline.btn-sm .fa-file-word { color: #1565C0; }
.nav-actions .btn.btn-outline.btn-sm[onclick*="Docx"] { border-color: #1565C0; color: #1565C0; }
.nav-actions .btn.btn-outline.btn-sm[onclick*="Docx"]:hover { background: #F5F8FF; border-color: #0D47A1; }
.nav-actions .btn.btn-gold.btn-sm { background: #1B3A5C; color: #fff; border: none; border-radius: 6px; padding: 7px 14px; font-weight: 600; font-size: 13px; transition: all 0.15s ease; gap: 6px; }
.nav-actions .btn.btn-gold.btn-sm:hover { background: #152D49; }
.nav-actions .tool-icon-btn { width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; background: #F5F5F5; border: 1px solid #E5E5E5; border-radius: 6px; color: #555; cursor: pointer; transition: all 0.15s ease; font-size: 14px; }
.nav-actions .tool-icon-btn:hover { background: #EBEBEB; color: #1B3A5C; }
</style>
</head>
<body>
<div id="siteBanner"></div>
<!-- TOP NAVIGATION -->
<nav class="top-nav">
<a href="/dashboard.html" class="brand">‚ú¶ <span>DraftMyForms</span></a>
<input class="doc-title-input" id="docTitle" value="Untitled Document" spellcheck="false">
<div class="nav-actions">
<button class="btn btn-ghost" onclick="toggleAI()" title="AI Assistant"><i class="fas fa-robot"></i></button>
<button class="btn btn-ghost" onclick="openTemplates()" title="Browse 120+ Templates"><i class="fas fa-th-large"></i></button>
<button class="btn btn-ghost" onclick="openUploadDoc()" title="Upload PDF, DOCX, or TXT"><i class="fas fa-file-upload"></i></button>
<button class="btn btn-ghost" onclick="openLogoUpload()" title="Upload or Generate Logo"><i class="fas fa-image"></i></button>
<button class="btn btn-sm" id="editorUpgradeBtn" style="display:none;background:var(--gold);color:#fff;font-weight:700;gap:6px" onclick="openEditorUpgrade()"><i class="fas fa-crown"></i> Upgrade</button>
<button class="btn btn-outline btn-sm" onclick="downloadPDF()" title="Export as PDF"><i class="fas fa-file-pdf"></i> PDF</button>
<button class="btn btn-outline btn-sm" onclick="downloadDocx()" title="Export as Word Document"><i class="fas fa-file-word"></i> DOCX</button>
<button class="btn btn-gold btn-sm" onclick="saveDocument()" title="Save Document (Ctrl+S)"><i class="fas fa-save"></i> Save</button>
<a href="/settings.html" class="btn btn-ghost btn-sm" title="Settings"><i class="fas fa-cog"></i></a>
<a href="/dashboard.html" class="btn btn-ghost btn-sm" title="Back to Dashboard"><i class="fas fa-home"></i></a>
</div>
</nav>

<!-- MAIN LAYOUT -->
<div class="main-layout">

<!-- AI SIDEBAR -->
<aside class="ai-sidebar" id="aiSidebar">
<div class="ai-header">
<h3><span class="star">‚ú¶</span> AI Assistant</h3>
<button class="btn btn-ghost btn-sm" onclick="toggleAI()"><i class="fas fa-times"></i></button>
</div>
<div class="ai-messages" id="aiMessages">
<div class="ai-msg system">
<strong>Welcome to DraftMyForms AI</strong><br>
I can help you create, edit, and perfect any document. Try:
<br>‚Ä¢ "Create a professional invoice"
<br>‚Ä¢ "Write a cover letter for a marketing role"
<br>‚Ä¢ "Generate an NDA agreement"
<br>‚Ä¢ "Help me improve this resume"
<br>‚Ä¢ "Create a company logo"
</div>
</div>
<div class="ai-input-area">
<div class="ai-quick-actions">
<button class="ai-quick-btn" onclick="aiQuick('invoice')">üìÑ Invoice</button>
<button class="ai-quick-btn" onclick="aiQuick('contract')">üìã Contract</button>
<button class="ai-quick-btn" onclick="aiQuick('resume')">üìù Resume</button>
<button class="ai-quick-btn" onclick="aiQuick('letter')">‚úâÔ∏è Letter</button>
<button class="ai-quick-btn" onclick="aiQuick('proposal')">üíº Proposal</button>
<button class="ai-quick-btn" onclick="aiQuick('nda')">üîí NDA</button>
<button class="ai-quick-btn" onclick="aiQuick('logo')">üé® Logo</button>
</div>
<textarea class="ai-prompt-input" id="aiPrompt" placeholder="Describe your document or ask AI to edit..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAI()}"></textarea>
<div style="display:flex;gap:6px">
<button class="btn btn-gold" style="flex:1" onclick="sendAI()"><i class="fas fa-paper-plane"></i> Send</button>
<button class="btn btn-outline btn-sm" onclick="applyAIToDoc()" title="Apply AI changes to document"><i class="fas fa-magic"></i></button>
</div>
</div>
</aside>

<!-- EDITOR CONTAINER -->
<div class="editor-container">

<!-- TOOLBAR -->
<div class="editor-toolbar" id="toolbar">
<div class="toolbar-group">
<button class="tool-btn" onclick="execCmd('undo')" title="Undo"><i class="fas fa-undo"></i></button>
<button class="tool-btn" onclick="execCmd('redo')" title="Redo"><i class="fas fa-redo"></i></button>
</div>
<div class="toolbar-group">
<select class="font-select" onchange="execCmd('fontName',this.value)" title="Font">
<option value="DM Sans">DM Sans</option>
<option value="Playfair Display">Playfair Display</option>
<option value="Georgia">Georgia</option>
<option value="Times New Roman">Times New Roman</option>
<option value="Arial">Arial</option>
<option value="Helvetica">Helvetica</option>
<option value="Courier New">Courier New</option>
<option value="Verdana">Verdana</option>
<option value="Trebuchet MS">Trebuchet MS</option>
</select>
<select class="size-select" onchange="execCmd('fontSize',this.value)" title="Size">
<option value="1">8</option>
<option value="2">10</option>
<option value="3" selected>12</option>
<option value="4">14</option>
<option value="5">18</option>
<option value="6">24</option>
<option value="7">36</option>
</select>
</div>
<div class="toolbar-group">
<button class="tool-btn" onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
<button class="tool-btn" onclick="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
<button class="tool-btn" onclick="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
<button class="tool-btn" onclick="execCmd('strikeThrough')" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
</div>
<div class="toolbar-group">
<button class="tool-btn" title="Text Color"><input type="color" value="#2d2926" onchange="execCmd('foreColor',this.value)"></button>
<button class="tool-btn" title="Highlight"><input type="color" value="#fef3d8" onchange="execCmd('hiliteColor',this.value)"></button>
</div>
<div class="toolbar-group">
<button class="tool-btn" onclick="execCmd('justifyLeft')" title="Align Left"><i class="fas fa-align-left"></i></button>
<button class="tool-btn" onclick="execCmd('justifyCenter')" title="Center"><i class="fas fa-align-center"></i></button>
<button class="tool-btn" onclick="execCmd('justifyRight')" title="Align Right"><i class="fas fa-align-right"></i></button>
<button class="tool-btn" onclick="execCmd('justifyFull')" title="Justify"><i class="fas fa-align-justify"></i></button>
</div>
<div class="toolbar-group">
<button class="tool-btn" onclick="execCmd('insertUnorderedList')" title="Bullet List"><i class="fas fa-list-ul"></i></button>
<button class="tool-btn" onclick="execCmd('insertOrderedList')" title="Number List"><i class="fas fa-list-ol"></i></button>
<button class="tool-btn" onclick="execCmd('indent')" title="Indent"><i class="fas fa-indent"></i></button>
<button class="tool-btn" onclick="execCmd('outdent')" title="Outdent"><i class="fas fa-outdent"></i></button>
</div>
<div class="toolbar-group">
<button class="tool-btn" onclick="insertHeading('h1')" title="Heading 1">H1</button>
<button class="tool-btn" onclick="insertHeading('h2')" title="Heading 2">H2</button>
<button class="tool-btn" onclick="insertHeading('h3')" title="Heading 3">H3</button>
</div>
<div class="toolbar-group">
<button class="tool-btn" onclick="insertTable()" title="Insert Table"><i class="fas fa-table"></i></button>
<button class="tool-btn" onclick="insertHR()" title="Horizontal Rule"><i class="fas fa-minus"></i></button>
<button class="tool-btn" onclick="insertLink()" title="Insert Link"><i class="fas fa-link"></i></button>
<button class="tool-btn" onclick="insertImage()" title="Insert Image"><i class="fas fa-image"></i></button>
</div>
<div class="toolbar-group">
<button class="tool-btn" onclick="clearFormatting()" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
<button class="tool-btn" onclick="printDoc()" title="Print"><i class="fas fa-print"></i></button>
      <button class="tool-btn" onclick="openSignatureModal()" title="E-Signature"><i class="fas fa-signature"></i></button>
</div>
</div>

<!-- EDITOR SPLIT -->
<div class="editor-split">

<!-- EDIT PANE -->
<div class="edit-pane">
<div class="canvas-wrapper">
<div class="doc-canvas" id="docCanvas" contenteditable="true" spellcheck="true">
</div>
</div>
</div>

<!-- DIVIDER -->
<div class="preview-divider" id="previewDivider"></div>

<!-- PREVIEW PANE -->
<div class="preview-pane" id="previewPane">
<div class="preview-header">
<span><i class="fas fa-eye"></i> Live Preview</span>
<div style="display:flex;gap:4px">
<button class="btn btn-ghost btn-sm" onclick="togglePreview()"><i class="fas fa-times"></i></button>
</div>
</div>
<div class="preview-frame">
<div class="preview-doc" id="previewDoc"></div>
</div>
</div>

</div>
</div>
</div>

<!-- STATUS BAR -->
<div class="status-bar">
<span id="wordCount">0 words</span>
<span id="saveStatus">Ready</span>
<span id="aiCredits">AI Credits: ‚àû</span>
</div>

<!-- UPLOAD DOCUMENT OVERLAY -->
<div class="upload-overlay" id="uploadOverlay">
<div class="upload-modal">
<h2>Upload Document</h2>
<p>Upload a PDF, DOCX, or image to edit with AI assistance</p>
<div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
<i class="fas fa-cloud-upload-alt"></i>
<p>Drag & drop or click to upload</p>
<p style="font-size:11px;color:var(--text-muted);margin-top:4px">PDF, DOCX, DOC, TXT, RTF, PNG, JPG</p>
</div>
<input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,.rtf,.png,.jpg,.jpeg" style="display:none" onchange="handleFileUpload(this)">
<div style="margin-top:16px;display:flex;gap:8px;justify-content:center">
<button class="btn btn-outline" onclick="closeUpload()">Cancel</button>
</div>
</div>
</div>

<!-- LOGO UPLOAD MODAL -->
<div class="logo-modal" id="logoModal">
<div class="logo-modal-content">
<h2 style="font-family:var(--font-heading);margin-bottom:8px">Add Your Logo</h2>
<p style="color:var(--text-muted);font-size:14px;margin-bottom:16px">Upload your company logo or let AI create one</p>
<div class="upload-zone" onclick="document.getElementById('logoInput').click()" style="margin-bottom:16px">
<i class="fas fa-image"></i>
<p>Upload logo (PNG, JPG, SVG)</p>
</div>
<input type="file" id="logoInput" accept=".png,.jpg,.jpeg,.svg,.webp" style="display:none" onchange="handleLogoUpload(this)">
<div style="text-align:center;margin-bottom:16px;color:var(--text-muted);font-size:12px">‚Äî or ‚Äî</div>
<div style="display:flex;gap:8px">
<input type="text" id="logoCompanyName" placeholder="Company name for AI logo..." style="flex:1;padding:10px;border:1px solid var(--card-border);border-radius:8px;font-size:13px;outline:none">
<button class="btn btn-gold" onclick="generateLogo()"><i class="fas fa-magic"></i> AI Logo</button>
</div>
<div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
<button class="btn btn-outline" onclick="closeLogoModal()">Cancel</button>
</div>
</div>
</div>

<!-- TEMPLATE PANEL -->
<div class="template-panel" id="templatePanel">
<div class="template-modal">
<div class="template-modal-header">
<h2>Document Templates</h2>
<div style="display:flex;gap:8px;align-items:center"><input type="text" id="templateSearch" placeholder="Search templates..." style="padding:8px 14px;border:1px solid var(--card-border);border-radius:8px;font-size:13px;outline:none;width:200px;font-family:var(--font-body)" oninput="filterTemplates(this.value)"><button class="btn btn-ghost" onclick="closeTemplates()"><i class="fas fa-times"></i></button></div>
</div>
<div class="template-tabs" id="templateTabs"></div>
<div class="template-grid" id="templateGrid"></div>
</div>
</div>

<!-- MOBILE AI (Issue 12) -->
<button class="mobile-ai-btn" id="mobileAiBtn" onclick="openMobileAI()"><i class="fas fa-robot"></i></button>
<div class="mobile-ai-overlay" id="mobileAiOverlay" onclick="closeMobileAI()"></div>
<div class="mobile-ai-sheet" id="mobileAiSheet">
<div class="sheet-header">
<h3><span style="color:var(--gold)">‚ú¶</span> AI Assistant</h3>
<button class="btn btn-ghost btn-sm" onclick="closeMobileAI()"><i class="fas fa-times"></i></button>
</div>
<div class="sheet-messages" id="mobileAiMessages">
<div class="ai-msg system" style="font-size:12px">Tell me what document to create, or ask me to edit the current one.</div>
</div>
<div class="sheet-input">
<input type="text" id="mobileAiInput" placeholder="Describe your document..." onkeydown="if(event.key==='Enter'){sendMobileAI()}">
<button onclick="sendMobileAI()"><i class="fas fa-paper-plane"></i></button>
</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib)window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script>
    // --- AI Credit Tracking: get userId and plan from auth token ---
    (function() {
      try {
        var keys = Object.keys(localStorage);
        for (var i = 0; i < keys.length; i++) {
          if (keys[i].indexOf('sb-') === 0 && keys[i].indexOf('-auth-token') > 0) {
            var parsed = JSON.parse(localStorage.getItem(keys[i]));
            if (parsed && parsed.user && parsed.user.id) {
              window.__dmfUserId = parsed.user.id;
            }
            break;
          }
        }
      } catch(e) {}
      window.__dmfUserPlan = 'Free';
    })();
// ==============================
// GLOBAL STATE
// ==============================
let lastAIResponse = '';
let currentTemplate = null;
let previewVisible = true;
let userLogo = null;

// ==============================
// TOOLBAR COMMANDS
// ==============================
function execCmd(cmd, val) {
  document.execCommand(cmd, false, val || null);
  docCanvas.focus();
  updatePreview();
}

function insertHeading(tag) {
  document.execCommand('formatBlock', false, tag);
  docCanvas.focus();
  updatePreview();
}

function insertTable() {
  const rows = prompt('Number of rows:', '3');
  const cols = prompt('Number of columns:', '3');
  if (!rows || !cols) return;
  let html = '<table><thead><tr>';
  for (let c = 0; c < +cols; c++) html += '<th>Header ' + (c + 1) + '</th>';
  html += '</tr></thead><tbody>';
  for (let r = 0; r < +rows - 1; r++) {
    html += '<tr>';
    for (let c = 0; c < +cols; c++) html += '<td>&nbsp;</td>';
    html += '</tr>';
  }
  html += '</tbody></table><p>&nbsp;</p>';
  document.execCommand('insertHTML', false, html);
  updatePreview();
}

function insertHR() {
  document.execCommand('insertHTML', false, '<hr style="border:none;border-top:2px solid #c99532;margin:20px 0">');
  updatePreview();
}

function insertLink() {
  const url = prompt('Enter URL:', 'https://');
  if (url) document.execCommand('createLink', false, url);
  updatePreview();
}

function insertImage() {
  const url = prompt('Enter image URL:');
  if (url) document.execCommand('insertImage', false, url);
  updatePreview();
}

function clearFormatting() {
  document.execCommand('removeFormat');
  updatePreview();
}

function printDoc() {
    const canvas = document.getElementById('docCanvas');
    if (!canvas) return;
    const content = canvas.innerHTML;
    const docTitle = document.getElementById('docTitle') ? document.getElementById('docTitle').value || 'Document' : 'Document';

    const printWindow = window.open('', '_blank');
    if (!printWindow) { showToast('Pop-up blocked. Please allow pop-ups.'); return; }

    printWindow.document.write(
      '<!DOCTYPE html><html><head><title>' + docTitle + '</title><meta charset="UTF-8">' +
      '<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">' +
      '<style>' +
      '@page { size: letter; margin: 0 !important; }' +
      'html, body { margin:0; padding:0; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; color-adjust:exact !important; }' +
      'body { padding: 0.6in 0.75in; font-family: DM Sans, Segoe UI, Arial, sans-serif; font-size: 11pt; line-height: 1.5; color: #000; background: #fff; }' +
      '* { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }' +
      'h1,h2,h3,h4 { page-break-after:avoid; }' +
      'table,figure,img { page-break-inside:avoid; }' +
      'table { border-collapse:collapse; width:100%; }' +
      'img { max-width:100%; height:auto; }' +
      '</style></head><body>' + content + '</body></html>'
    );
    printWindow.document.close();
    printWindow.onload = function() { printWindow.focus(); printWindow.print(); };
    setTimeout(function() { printWindow.focus(); printWindow.print(); }, 800);
  }

// ==============================
// DOCUMENT CANVAS
// ==============================
const docCanvas = document.getElementById('docCanvas');
const previewDoc = document.getElementById('previewDoc');

docCanvas.addEventListener('input', () => {
    updatePreview();
    updateWordCount();
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(autoSave, 3000);
  })

function updatePreview() {
  if (previewDoc) previewDoc.innerHTML = docCanvas.innerHTML;
}

function updateWordCount() {
  const text = docCanvas.innerText.trim();
  const words = text ? text.split(/\s+/).length : 0;
  document.getElementById('wordCount').textContent = words + ' words';
}

// ==============================
// AI SIDEBAR
// ==============================
function toggleAI() {
  const sb = document.getElementById('aiSidebar');
  sb.classList.toggle('collapsed');
    // Update placeholder based on document content
    var aiInput = document.getElementById('aiPrompt');
    if (aiInput) {
      var canvas = document.getElementById('editor-canvas') || document.querySelector('.doc-canvas');
      var hasDoc = canvas && canvas.innerHTML.trim().length > 0 && canvas.innerHTML.trim() !== '<br>';
      aiInput.placeholder = hasDoc ? 'Describe what changes to make to this document...' : 'Describe the document you want to create...';
    }
}

function addAIMessage(text, role) {
  const div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  div.innerHTML = fixEncoding(text);
  document.getElementById('aiMessages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function showAILoading() {
  const div = document.createElement('div');
  div.className = 'ai-loading';
  div.id = 'aiLoading';
  div.innerHTML = 'AI is thinking <span class="dots"><span>.</span><span>.</span><span>.</span></span>';
  document.getElementById('aiMessages').appendChild(div);
  div.scrollIntoView({ behavior: 'smooth' });
}

function removeAILoading() {
  const el = document.getElementById('aiLoading');
  if (el) el.remove();
}

function aiQuick(type) {
  const prompts = {
    invoice: 'Create a professional invoice template with company details, line items table, subtotal, tax, and total. Use elegant gold (#c99532) accents.',
    contract: 'Create a professional business service contract with all necessary legal clauses, signature blocks, and clean formatting.',
    resume: 'Create a modern professional resume template with sections for contact info, summary, experience, education, and skills.',
    letter: 'Create a professional business letter template with proper formatting, sender/recipient blocks, and a formal structure.',
    proposal: 'Create a professional business proposal template with executive summary, scope of work, timeline, pricing, and terms.',
    nda: 'Create a comprehensive Non-Disclosure Agreement with standard clauses, definitions, obligations, and signature blocks.',
    logo: 'Create a modern, professional company logo design concept using SVG. Make it elegant and suitable for business documents.'
  };
  document.getElementById('aiPrompt').value = prompts[type] || '';
  sendAI();
}

async function sendAI() {
  const prompt = document.getElementById('aiPrompt').value.trim();
  if (!prompt) return;
  
  addAIMessage(prompt, 'user');
  document.getElementById('aiPrompt').value = '';
  showAILoading();
  
  const currentContent = docCanvas.innerHTML;
  const hasContent = currentContent.trim().length > 100 && currentContent.trim() !== '<br>' && currentContent.trim() !== '<p><br></p>';
  console.log('[AI] Mode:', hasContent ? 'edit' : 'create', '| Content length:', currentContent.length, '| Sending existing:', hasContent);
  // Show edit mode indicator
  if (hasContent) {
    addAIMessage('\u270f\ufe0f Editing current document - your changes will be applied to the existing content.', 'system');
  }
  
  try {
    const res = await fetch('/api/ai-generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: prompt,
        docType: 'custom',
        userId: window.__dmfUserId || null,
        plan: window.__dmfUserPlan || 'Free',
        currentContent: hasContent ? currentContent : null,
        mode: hasContent ? 'edit' : 'create'
      })
    });
    
    removeAILoading();
    
    if (!res.ok) {
      const err = await res.json();
      if (res.status === 429 && err.creditsRemaining === 0) {
          addAIMessage('You have used all ' + err.creditLimit + ' AI credits for this month (' + (err.plan || 'Free') + ' plan). Upgrade your plan for more credits or wait until next month.', 'system');
        } else {
          addAIMessage('Error: ' + (err.error || 'Something went wrong'), 'system');
        }
      return;
    }
    
    const data = await res.json();
    lastAIResponse = data.html;
    
    // Auto-apply to canvas
    docCanvas.innerHTML = fixEncoding(data.html);
    updatePreview();
    updateWordCount();
    
    // Show credit info if available
      if (data.credits) {
        var creditMsg = '\u2728 ' + data.credits.remaining + ' AI credits remaining this month (' + data.credits.used + '/' + data.credits.limit + ')';
        addAIMessage(creditMsg, 'system');
      }
      addAIMessage('Document updated! You can edit it directly in the canvas, or ask me to make more changes.', 'assistant');
    
  } catch (e) {
    removeAILoading();
    addAIMessage('Connection error. Please try again.', 'system');
  }
}

function applyAIToDoc() {
  if (lastAIResponse) {
    docCanvas.innerHTML = lastAIResponse;
    updatePreview();
    updateWordCount();
    showToast('AI content applied to document');
  }
}

// ==============================
// FILE UPLOAD
// ==============================
function openUploadDoc() {
  document.getElementById('uploadOverlay').classList.add('active');
}

function closeUpload() {
  document.getElementById('uploadOverlay').classList.remove('active');
}


    function escapeHTML(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function fixEncoding(str) {
      // Fix common UTF-8 double-encoding artifacts (Windows-1252 misinterpretation)
      return str
        .replace(/\u00e2\u0080\u0099/g, "\u2019") // right single quote
        .replace(/\u00e2\u0080\u009c/g, "\u201c") // left double quote
        .replace(/\u00e2\u0080\u009d/g, "\u201d") // right double quote
        .replace(/\u00e2\u0080\u0093/g, "\u2013") // en dash
        .replace(/\u00e2\u0080\u0094/g, "\u2014") // em dash
        .replace(/\u00e2\u0080\u00a2/g, "\u2022") // bullet
        .replace(/\u00c2\u00b7/g, "\u00b7") // middle dot
        .replace(/\u00e2\u0080\u00b2/g, "\u2032") // prime
        .replace(/\u00e2\u0080\u00b3/g, "\u2033") // double prime
        .replace(/\u00e2\u0080\u0098/g, "\u2018") // left single quote
        .replace(/\u00c3\u00a9/g, "\u00e9") // e-acute
        .replace(/\u00e2\u009c\u0093/g, "\u2713") // check mark
        .replace(/\u00e2\u009c\u0097/g, "\u2717") // cross mark
        .replace(/\u00e2\u009c\u00a6/g, "\u2726") // four-pointed star
        .replace(/\u00c2\u00a0/g, " "); // non-breaking space
    }



    function buildTableHTML(tableLines, pageWidth) {
      if (!tableLines.length) return '';
      // Determine columns by clustering X positions across all rows
      const allX = [];
      for (const line of tableLines) {
        for (const item of line.items) {
          let found = false;
          for (const ax of allX) {
            if (Math.abs(ax - item.x) < 20) { found = true; break; }
          }
          if (!found) allX.push(item.x);
        }
      }
      allX.sort((a, b) => a - b);
      const numCols = Math.max(allX.length, 2);
      let html = '<table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:13px">';
      for (let r = 0; r < tableLines.length; r++) {
        const line = tableLines[r];
        const isHeader = r === 0 && line.items.some(it => it.fontSize > 12);
        const tag = isHeader ? 'th' : 'td';
        const bgStyle = isHeader ? 'background:#c99532;color:#fff;font-weight:bold;' : (r % 2 === 0 ? 'background:#faf8f5;' : '');
        html += '<tr>';
        // Assign items to columns based on X position
        const cells = new Array(numCols).fill('');
        for (const item of line.items) {
          let colIdx = 0;
          let minDist = Infinity;
          for (let c = 0; c < allX.length; c++) {
            const dist = Math.abs(item.x - allX[c]);
            if (dist < minDist) { minDist = dist; colIdx = c; }
          }
          cells[colIdx] = (cells[colIdx] ? cells[colIdx] + ' ' : '') + item.text;
        }
        for (const cell of cells) {
          html += '<' + tag + ' style="' + bgStyle + 'padding:8px 10px;border:1px solid #e0dcd8;text-align:left">' + escapeHTML(cell.trim()) + '</' + tag + '>';
        }
        html += '</tr>';
      }
      html += '</table>';
      return html;
    }

    async function handleFileUpload(input) {
  const file = input.files[0];
  if (!file) return;
  window.__uploadedFile = file;
  closeUpload();
  showToast('Processing ' + file.name + '...');

  if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      document.getElementById('docCanvas').innerHTML = '<div style="white-space:pre-wrap;font-family:var(--font-body);padding:20px;line-height:1.6">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      document.getElementById('docTitle').textContent = file.name.replace(/\.[^.]+$/, '');
      updatePreview();
      updateWordCount();
    };
    reader.readAsText(file);
    showToast('File loaded! You can now edit or ask AI to improve it.');
  } else if (file.type === 'text/html' || file.name.endsWith('.html')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('docCanvas').innerHTML = e.target.result;
      document.getElementById('docTitle').textContent = file.name.replace(/\.[^.]+$/, '');
      updatePreview();
      updateWordCount();
      showToast('HTML loaded!');
    };
    reader.readAsText(file);
  } else if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.execCommand('insertImage', false, e.target.result);
      updatePreview();
      showToast('Image inserted!');
    };
    reader.readAsDataURL(file);
  } else if (file.name.endsWith('.pdf')) {
    // PDF - extract text with structure preservation, NO AI reformatting
    addAIMessage('Processing PDF: ' + file.name + ' (preserving original format)', 'system');
    showAILoading();
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const pages = [];
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const viewport = page.getViewport({ scale: 1 });
        const pageWidth = viewport.width;
        // Group text items into lines based on Y position
        const lines = [];
        let currentLine = [];
        let lastY = null;
        const sortedItems = textContent.items.sort((a, b) => {
          const yDiff = b.transform[5] - a.transform[5];
          if (Math.abs(yDiff) > 3) return yDiff;
          return a.transform[4] - b.transform[4];
        });
        for (const item of sortedItems) {
          const y = Math.round(item.transform[5]);
          const x = item.transform[4];
          const fontSize = Math.abs(item.transform[0]) || 12;
          if (lastY !== null && Math.abs(y - lastY) > 5) {
            if (currentLine.length) lines.push({ items: [...currentLine], y: lastY });
            currentLine = [];
          }
          currentLine.push({ text: item.str, x, y, fontSize, width: item.width });
          lastY = y;
        }
        if (currentLine.length) lines.push({ items: [...currentLine], y: lastY });
        pages.push({ lines, pageWidth, pageHeight: viewport.height });
      }
      // Build HTML preserving structure
      let html = '';
      for (let p = 0; p < pages.length; p++) {
        const pg = pages[p];
        if (p > 0) html += '<hr style="border:none;border-top:2px dashed #ccc;margin:30px 0;page-break-before:always">';
        let prevFontSize = 12;
        let tableLines = [];
        let inTable = false;
        for (const line of pg.lines) {
          const lineText = line.items.map(it => it.text).join(' ').trim();
          if (!lineText) { html += '<br>'; continue; }
          const maxFontSize = Math.max(...line.items.map(it => it.fontSize));
          // Detect potential table rows (multiple items with significant X gaps)
          const hasMultipleColumns = line.items.length >= 2 && line.items.some((it, idx) => {
            if (idx === 0) return false;
            return (it.x - (line.items[idx-1].x + line.items[idx-1].width)) > 30;
          });
          if (hasMultipleColumns) {
            if (!inTable) { inTable = true; tableLines = []; }
            tableLines.push(line);
            continue;
          }
          // Flush any pending table
          if (inTable) {
            html += buildTableHTML(tableLines, pg.pageWidth);
            tableLines = [];
            inTable = false;
          }
          // Determine element type by font size
          if (maxFontSize >= 22) {
            html += '<h1 style="margin:16px 0 8px;font-size:' + Math.min(maxFontSize * 1.2, 36) + 'px">' + escapeHTML(lineText) + '</h1>';
          } else if (maxFontSize >= 17) {
            html += '<h2 style="margin:12px 0 6px;font-size:' + Math.min(maxFontSize * 1.1, 28) + 'px">' + escapeHTML(lineText) + '</h2>';
          } else if (maxFontSize >= 14) {
            html += '<h3 style="margin:10px 0 4px;font-size:' + maxFontSize + 'px">' + escapeHTML(lineText) + '</h3>';
          } else {
            html += '<p style="margin:4px 0;line-height:1.5;font-size:' + maxFontSize + 'px">' + escapeHTML(lineText) + '</p>';
          }
        }
        // Flush remaining table
        if (inTable && tableLines.length) {
          html += buildTableHTML(tableLines, pg.pageWidth);
        }
      }
      removeAILoading();
      if (html.trim()) {
        document.getElementById('docCanvas').innerHTML = '<div style="padding:20px;font-family:var(--font-body)">' + html + '</div>';
        document.getElementById('docTitle').textContent = file.name.replace(/\.pdf$/i, '');
        updatePreview();
        updateWordCount();
        addAIMessage('PDF loaded with original formatting preserved (' + pdf.numPages + ' page' + (pdf.numPages > 1 ? 's' : '') + '). You can edit directly in the canvas. Ask me if you need help making changes.', 'assistant');
      } else {
        addAIMessage('Could not extract text from this PDF. It may be image-based or encrypted.', 'system');
      }
    } catch(err) {
      removeAILoading();
      addAIMessage('Error reading PDF: ' + err.message, 'system');
    }
  } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
    // DOCX - use mammoth.js for high-fidelity HTML conversion, NO AI reformatting
    addAIMessage('Processing Word document: ' + file.name + ' (preserving original format)', 'system');
    showAILoading();
    try {
      const arrayBuffer = await file.arrayBuffer();
      if (typeof mammoth !== 'undefined') {
        // Use mammoth.js for proper DOCX to HTML conversion
        const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer }, {
          styleMap: [
            "p[style-name='Heading 1'] => h1:fresh",
            "p[style-name='Heading 2'] => h2:fresh",
            "p[style-name='Heading 3'] => h3:fresh",
            "p[style-name='Title'] => h1.doc-title:fresh",
            "b => strong",
            "i => em",
            "u => u",
            "strike => s"
          ]
        });
        removeAILoading();
        if (result.value && result.value.trim()) {
          // Add some base styling to the mammoth output
          let styledHTML = '<div style="padding:20px;font-family:var(--font-body);line-height:1.6;color:#2d2926">';
          styledHTML += result.value;
          styledHTML += '</div>';
          document.getElementById('docCanvas').innerHTML = styledHTML;
          document.getElementById('docTitle').textContent = file.name.replace(/\.docx?$/i, '');
          updatePreview();
          updateWordCount();
          let msg = 'Word document loaded with formatting preserved!';
          if (result.messages && result.messages.length) {
            msg += ' (' + result.messages.length + ' minor conversion note' + (result.messages.length > 1 ? 's' : '') + ')';
          }
          msg += ' You can edit directly. Ask me if you need help.';
          addAIMessage(msg, 'assistant');
        } else {
          addAIMessage('Could not extract content from this Word document.', 'system');
        }
      } else {
        // Fallback: basic DOCX text extraction without mammoth
        removeAILoading();
        const textDecoder = new TextDecoder('utf-8');
        const text = textDecoder.decode(arrayBuffer);
        const xmlMatch = text.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
        let extractedText = '';
        if (xmlMatch) {
          extractedText = xmlMatch.map(m => m.replace(/<[^>]+>/g, '')).join(' ');
        }
        if (extractedText.trim()) {
          document.getElementById('docCanvas').innerHTML = '<div style="padding:20px;font-family:var(--font-body);line-height:1.6">' + escapeHTML(extractedText) + '</div>';
          document.getElementById('docTitle').textContent = file.name.replace(/\.docx?$/i, '');
          updatePreview();
          updateWordCount();
          addAIMessage('Word document loaded (basic text extraction). Some formatting may be simplified. Ask me to help improve the layout.', 'assistant');
        } else {
          addAIMessage('Could not extract text. Try saving as .pdf or .txt first.', 'system');
        }
      }
    } catch(err) {
      removeAILoading();
      addAIMessage('Error processing Word file: ' + err.message, 'system');
    }
  } else {
    addAIMessage('Unsupported file format. Please upload PDF, DOCX, TXT, or HTML.', 'system');
  }
}

// ==============================
// LOGO UPLOAD
// ==============================
function openLogoUpload() {
  document.getElementById('logoModal').classList.add('active');
}

function closeLogoModal() {
  document.getElementById('logoModal').classList.remove('active');
}

function handleLogoUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    userLogo = e.target.result;
    insertLogoInDoc(userLogo);
    closeLogoModal();
    showToast('Logo inserted! Drag to reposition.');
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function insertLogoInDoc(src) {
  const img = '<img src="' + src + '" style="max-width:180px;max-height:80px;cursor:move" class="doc-logo" draggable="true">';
  // Insert at beginning of doc or at cursor
  const sel = window.getSelection();
  if (sel.rangeCount > 0 && docCanvas.contains(sel.anchorNode)) {
    document.execCommand('insertHTML', false, img);
  } else {
    docCanvas.innerHTML = img + docCanvas.innerHTML;
  }
  updatePreview();
}

async function generateLogo() {
  const name = document.getElementById('logoCompanyName').value.trim();
  if (!name) { showToast('Enter a company name'); return; }
  
  closeLogoModal();
  addAIMessage('Creating a logo for "' + name + '"...', 'system');
  showAILoading();
  
  try {
    const res = await fetch('/api/ai-generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: 'Create an elegant, professional SVG logo for a company called "' + name + '". The logo should be modern, clean, and suitable for business documents. Use gold (#c99532) as the primary accent color with dark text. Output ONLY the SVG code, nothing else.',
        docType: 'logo',
        mode: 'create'
      })
    });
    removeAILoading();
    if (res.ok) {
      const data = await res.json();
      const svgMatch = data.html.match(/<svg[\s\S]*?<\/svg>/i);
      if (svgMatch) {
        const blob = new Blob([svgMatch[0]], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        insertLogoInDoc(url);
        addAIMessage('Logo created and inserted into your document!', 'assistant');
      } else {
        docCanvas.innerHTML = data.html + docCanvas.innerHTML;
        updatePreview();
        addAIMessage('Logo concept generated!', 'assistant');
      }
    }
  } catch (e) {
    removeAILoading();
    addAIMessage('Error generating logo. Try again.', 'system');
  }
  }

// ==============================
// TEMPLATES (20 variations per type)
// ==============================
const TEMPLATES = {
  'Invoices': [
    { name: 'Executive Gold', tier: 'free', style: 'elegant gold accents, serif headings, clean table with gold header' },
    { name: 'Minimal Clean', tier: 'free', style: 'ultra-minimal, lots of white space, thin borders, small sans-serif' },
    { name: 'Corporate Bold', tier: 'free', style: 'bold dark header bar, professional corporate feel, structured layout' },
    { name: 'Modern Stripe', tier: 'free', style: 'colorful left stripe accent, modern sans-serif, rounded table corners' },
    { name: 'Classic Traditional', tier: 'free', style: 'traditional serif fonts, classic border, formal layout' },
    { name: 'Creative Studio', tier: 'pro', style: 'artistic layout, asymmetric design, creative agency feel' },
    { name: 'Tech Startup', tier: 'pro', style: 'tech-focused, monospace elements, modern grid layout' },
    { name: 'Luxury Black', tier: 'pro', style: 'black and gold, premium feel, luxury brand aesthetic' },
    { name: 'Fresh Green', tier: 'pro', style: 'eco-friendly green accents, clean modern layout, natural feel' },
    { name: 'Warm Terracotta', tier: 'pro', style: 'warm earth tones, rounded elements, friendly feel' },
    { name: 'Neon Gradient', tier: 'pro', style: 'bold gradient accents, modern design, eye-catching' },
    { name: 'Blueprint', tier: 'pro', style: 'architectural/engineering feel, grid lines, technical' },
    { name: 'Retro Vintage', tier: 'pro', style: 'vintage typography, retro colors, classic ornaments' },
    { name: 'Swiss Design', tier: 'pro', style: 'Swiss/International style, grid-based, Helvetica, red accents' },
    { name: 'Japanese Zen', tier: 'pro', style: 'minimalist Japanese aesthetic, zen garden inspired, subtle' },
    { name: 'Geometric Art', tier: 'biz', style: 'geometric shapes, abstract art elements, bold colors' },
    { name: 'Watercolor', tier: 'biz', style: 'soft watercolor background accents, artistic, premium' },
    { name: 'Magazine', tier: 'biz', style: 'magazine-style layout, columns, editorial feel' },
    { name: 'Dark Professional', tier: 'biz', style: 'dark mode design, white text on dark, sleek' },
    { name: 'Royal Crest', tier: 'biz', style: 'ornate borders, royal crest feel, prestigious, gold and navy' }
  ],
  'Contracts': [
    { name: 'Standard Legal', tier: 'free', style: 'clean legal formatting, numbered clauses, professional' },
    { name: 'Modern Contract', tier: 'free', style: 'modern layout, clear sections, easy to read' },
    { name: 'Simple Agreement', tier: 'free', style: 'simplified contract, plain language, minimal' },
    { name: 'Corporate Master', tier: 'free', style: 'corporate master agreement style, detailed sections' },
    { name: 'Freelancer', tier: 'free', style: 'freelancer-friendly, clear scope/payment terms' },
    { name: 'Employment', tier: 'pro', style: 'employment contract, comprehensive terms' },
    { name: 'Service Agreement', tier: 'pro', style: 'professional services agreement, detailed SLA' },
    { name: 'Lease Agreement', tier: 'pro', style: 'property lease, residential/commercial' },
    { name: 'Partnership', tier: 'pro', style: 'business partnership agreement, equity terms' },
    { name: 'NDA Standard', tier: 'pro', style: 'standard non-disclosure agreement, mutual/one-way' },
    { name: 'NDA Mutual', tier: 'pro', style: 'mutual NDA, bidirectional confidentiality' },
    { name: 'Consulting', tier: 'pro', style: 'consulting agreement, deliverables focus' },
    { name: 'Sales Contract', tier: 'pro', style: 'product sales agreement, warranty terms' },
    { name: 'IP Assignment', tier: 'pro', style: 'intellectual property assignment, work for hire' },
    { name: 'Joint Venture', tier: 'pro', style: 'joint venture agreement, shared responsibilities' },
    { name: 'Licensing', tier: 'biz', style: 'software/IP licensing agreement, royalties' },
    { name: 'Merger Agreement', tier: 'biz', style: 'M&A agreement, comprehensive due diligence' },
    { name: 'Non-Compete', tier: 'biz', style: 'non-compete/non-solicitation agreement' },
    { name: 'SaaS Terms', tier: 'biz', style: 'SaaS terms of service, data processing' },
    { name: 'Investment', tier: 'biz', style: 'investment agreement, term sheet style' }
  ],
  'Resumes': [
    { name: 'Professional Clean', tier: 'free', style: 'clean ATS-friendly resume, clear sections, professional' },
    { name: 'Modern Two-Column', tier: 'free', style: 'two-column layout, skills sidebar, modern feel' },
    { name: 'Classic Traditional', tier: 'free', style: 'traditional resume, Times New Roman, conservative' },
    { name: 'Minimalist', tier: 'free', style: 'ultra-minimal, focus on content, no distractions' },
    { name: 'Bold Header', tier: 'free', style: 'prominent name header, bold section dividers' },
    { name: 'Creative Portfolio', tier: 'pro', style: 'creative/design resume, portfolio style' },
    { name: 'Executive', tier: 'pro', style: 'C-suite executive resume, leadership focus' },
    { name: 'Tech Developer', tier: 'pro', style: 'developer resume, code-inspired design, skill bars' },
    { name: 'Academic CV', tier: 'pro', style: 'academic CV, publications, research focus' },
    { name: 'Healthcare', tier: 'pro', style: 'medical/healthcare professional resume' },
    { name: 'Marketing Pro', tier: 'pro', style: 'marketing professional, metrics-driven, visual' },
    { name: 'Legal Professional', tier: 'pro', style: 'attorney/legal resume, formal, prestigious' },
    { name: 'Sales Executive', tier: 'pro', style: 'sales resume, achievement-focused, numbers' },
    { name: 'Teacher/Educator', tier: 'pro', style: 'education professional, certifications' },
    { name: 'Federal Resume', tier: 'pro', style: 'US federal/government resume format, detailed' },
    { name: 'Infographic', tier: 'biz', style: 'infographic-style, visual data, charts' },
    { name: 'Video Resume', tier: 'biz', style: 'multimedia resume template, video embed ready' },
    { name: 'International', tier: 'biz', style: 'europass-style international CV format' },
    { name: 'Career Changer', tier: 'biz', style: 'functional resume for career transition' },
    { name: 'Entry Level', tier: 'biz', style: 'new graduate, internships, coursework focus' }
  ],
  'Letters': [
    { name: 'Business Formal', tier: 'free', style: 'formal business letter, standard block format' },
    { name: 'Cover Letter', tier: 'free', style: 'job application cover letter, persuasive' },
    { name: 'Recommendation', tier: 'free', style: 'letter of recommendation, positive professional' },
    { name: 'Resignation', tier: 'free', style: 'professional resignation letter, graceful' },
    { name: 'Thank You', tier: 'free', style: 'professional thank you letter, interview follow-up' },
    { name: 'Complaint', tier: 'pro', style: 'formal complaint letter, structured grievance' },
    { name: 'Demand Letter', tier: 'pro', style: 'legal demand letter, firm but professional' },
    { name: 'Reference', tier: 'pro', style: 'character/professional reference letter' },
    { name: 'Intent Letter', tier: 'pro', style: 'letter of intent, business/education' },
    { name: 'Termination', tier: 'pro', style: 'employment termination letter, legal compliance' },
    { name: 'Offer Letter', tier: 'pro', style: 'job offer letter, compensation details' },
    { name: 'Acceptance', tier: 'pro', style: 'acceptance letter, job/admission' },
    { name: 'Appeal', tier: 'pro', style: 'appeal letter, decision reconsideration' },
    { name: 'Condolence', tier: 'pro', style: 'condolence/sympathy letter, sensitive' },
    { name: 'Invitation', tier: 'pro', style: 'formal event invitation letter' },
    { name: 'Authorization', tier: 'biz', style: 'authorization letter, power delegation' },
    { name: 'Cease & Desist', tier: 'biz', style: 'cease and desist letter, legal warning' },
    { name: 'Collection', tier: 'biz', style: 'debt collection letter, professional' },
    { name: 'Sponsorship', tier: 'biz', style: 'sponsorship request letter, partnership' },
    { name: 'Testimonial', tier: 'biz', style: 'client testimonial/endorsement letter' }
  ],
  'Proposals': [
    { name: 'Business Plan', tier: 'free', style: 'business plan template, executive summary, financials' },
    { name: 'Project Proposal', tier: 'free', style: 'project proposal, scope, timeline, budget' },
    { name: 'Service Proposal', tier: 'free', style: 'professional services proposal, pricing tiers' },
    { name: 'Grant Proposal', tier: 'free', style: 'grant application, research methodology' },
    { name: 'Marketing Plan', tier: 'free', style: 'marketing strategy proposal, channels, KPIs' },
    { name: 'Consulting Proposal', tier: 'pro', style: 'management consulting proposal, analysis' },
    { name: 'Software Dev', tier: 'pro', style: 'software development proposal, tech stack, sprints' },
    { name: 'Construction', tier: 'pro', style: 'construction bid proposal, materials, schedule' },
    { name: 'Event Planning', tier: 'pro', style: 'event proposal, venue, catering, timeline' },
    { name: 'Real Estate', tier: 'pro', style: 'real estate investment proposal, ROI analysis' },
    { name: 'Design Proposal', tier: 'pro', style: 'creative/design proposal, portfolio samples' },
    { name: 'Research', tier: 'pro', style: 'research proposal, hypothesis, methodology' },
    { name: 'Training', tier: 'pro', style: 'corporate training proposal, curriculum' },
    { name: 'Partnership', tier: 'pro', style: 'strategic partnership proposal, mutual benefits' },
    { name: 'Nonprofit', tier: 'pro', style: 'nonprofit program proposal, impact metrics' },
    { name: 'Merger Proposal', tier: 'biz', style: 'M&A proposal, synergies, valuation' },
    { name: 'Government RFP', tier: 'biz', style: 'government RFP response, compliance matrix' },
    { name: 'Franchise', tier: 'biz', style: 'franchise proposal, operations manual outline' },
    { name: 'Venture Capital', tier: 'biz', style: 'VC pitch deck style, cap table, projections' },
    { name: 'White Label', tier: 'biz', style: 'white label partnership proposal, licensing' }
  ],
  'Reports': [
    { name: 'Annual Report', tier: 'free', style: 'company annual report, financials, highlights' },
    { name: 'Progress Report', tier: 'free', style: 'project progress report, milestones, status' },
    { name: 'Incident Report', tier: 'free', style: 'workplace incident report, detailed account' },
    { name: 'Financial Report', tier: 'free', style: 'financial summary, P&L, balance sheet' },
    { name: 'Meeting Minutes', tier: 'free', style: 'meeting minutes, action items, attendance' },
    { name: 'Audit Report', tier: 'pro', style: 'internal audit report, findings, recommendations' },
    { name: 'Sales Report', tier: 'pro', style: 'sales performance report, metrics, charts layout' },
    { name: 'Market Research', tier: 'pro', style: 'market research report, analysis, trends' },
    { name: 'HR Report', tier: 'pro', style: 'human resources report, headcount, turnover' },
    { name: 'IT Status', tier: 'pro', style: 'IT infrastructure status report, uptime, incidents' },
    { name: 'Risk Assessment', tier: 'pro', style: 'risk assessment report, matrix, mitigation' },
    { name: 'Quality Report', tier: 'pro', style: 'quality assurance report, defects, compliance' },
    { name: 'Expense Report', tier: 'pro', style: 'expense report, categorized, receipts layout' },
    { name: 'Project Closure', tier: 'pro', style: 'project closure report, lessons learned' },
    { name: 'Compliance', tier: 'pro', style: 'regulatory compliance report, checklist' },
    { name: 'Board Report', tier: 'biz', style: 'board of directors report, executive dashboard' },
    { name: 'Due Diligence', tier: 'biz', style: 'due diligence report, comprehensive analysis' },
    { name: 'ESG Report', tier: 'biz', style: 'environmental/social/governance report' },
    { name: 'Valuation', tier: 'biz', style: 'company valuation report, DCF, comparables' },
    { name: 'Strategic Plan', tier: 'biz', style: 'strategic planning report, SWOT, goals' }
  ],
  'Forms': [
    { name: 'Application Form', tier: 'free', style: 'job/membership application form, fields layout' },
    { name: 'Registration', tier: 'free', style: 'event/course registration form' },
    { name: 'Feedback Survey', tier: 'free', style: 'customer feedback form, rating scales' },
    { name: 'Order Form', tier: 'free', style: 'product/service order form, calculations' },
    { name: 'Contact Form', tier: 'free', style: 'professional contact information form' },
    { name: 'Employee Onboard', tier: 'pro', style: 'new hire onboarding form, checklist' },
    { name: 'Medical Intake', tier: 'pro', style: 'patient medical history intake form' },
    { name: 'Consent Form', tier: 'pro', style: 'informed consent form, medical/legal' },
    { name: 'Insurance Claim', tier: 'pro', style: 'insurance claim form, detailed sections' },
    { name: 'Tax Worksheet', tier: 'pro', style: 'tax preparation worksheet, deductions' },
    { name: 'Vendor Setup', tier: 'pro', style: 'new vendor registration form, banking' },
    { name: 'Change Request', tier: 'pro', style: 'project change request form, impact analysis' },
    { name: 'Leave Request', tier: 'pro', style: 'employee leave/vacation request form' },
    { name: 'Purchase Order', tier: 'pro', style: 'purchase order form, itemized' },
    { name: 'Evaluation', tier: 'pro', style: 'performance evaluation form, competencies' },
    { name: 'Audit Checklist', tier: 'biz', style: 'audit checklist form, compliance items' },
    { name: 'Risk Register', tier: 'biz', style: 'risk register form, probability/impact matrix' },
    { name: 'Asset Inventory', tier: 'biz', style: 'asset tracking inventory form' },
    { name: 'Incident Tracker', tier: 'biz', style: 'incident management tracking form' },
    { name: 'KPI Dashboard', tier: 'biz', style: 'KPI tracking dashboard template' }
  ]
};

function openTemplates() {
  document.getElementById('templatePanel').classList.add('active');
  renderTemplateTabs();
  renderTemplateGrid(Object.keys(TEMPLATES)[0]);
}

function closeTemplates() {
  document.getElementById('templatePanel').classList.remove('active');
}

function renderTemplateTabs() {
  const tabs = document.getElementById('templateTabs');
  tabs.innerHTML = Object.keys(TEMPLATES).map((cat, i) =>
    '<button class="template-tab ' + (i === 0 ? 'active' : '') + '" onclick="selectTemplateTab(this,\'' + cat + '\')">' + cat + ' <span style=\"font-size:10px;opacity:.6\">(' + TEMPLATES[cat].length + ')</span></button>'
  ).join('');
}

function selectTemplateTab(btn, cat) {
  document.querySelectorAll('.template-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderTemplateGrid(cat);
}

function renderTemplateGrid(category) {
  const grid = document.getElementById('templateGrid');
  grid.innerHTML = TEMPLATES[category].map((t, i) => {
    const badgeCls = t.tier === 'free' ? 'badge-free' : t.tier === 'pro' ? 'badge-pro' : 'badge-biz';
    const tierLabel = t.tier.charAt(0).toUpperCase() + t.tier.slice(1);
    return '<div class="template-card" onclick="loadTemplate(\'' + category + '\',' + i + ')">' +
      '<div class="preview" style="display:flex;align-items:center;justify-content:center;font-size:32px;color:var(--gold)">' +
      '<i class="fas fa-file-alt"></i></div>' +
      '<div class="info"><h4>' + t.name + ' <span class="badge ' + badgeCls + '">' + tierLabel + '</span></h4>' +
      '<span>' + category.slice(0, -1) + '</span></div></div>';
  }).join('');
}

async function loadTemplate(category, index) {
  const template = TEMPLATES[category][index];
  closeTemplates();
  showToast('Generating ' + template.name + '...');
  
  addAIMessage('Generate a professional ' + category.slice(0,-1).toLowerCase() + ' using the "' + template.name + '" style: ' + template.style, 'user');
  showAILoading();
  
  try {
    const res = await fetch('/api/ai-generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: 'Create a professional ' + category.slice(0,-1).toLowerCase() + ' document. Style: "' + template.name + '" - ' + template.style + '. Fill in with realistic sample data. Make it look premium and polished with proper spacing, colors, and typography. Include all standard sections for this document type.',
        docType: category.slice(0,-1).toLowerCase(),
        mode: 'create',
        templateStyle: template.style
      })
    });
    removeAILoading();
    if (res.ok) {
      const data = await res.json();
      docCanvas.innerHTML = data.html;
      updatePreview();
      updateWordCount();
      document.getElementById('docTitle').value = template.name + ' ' + category.slice(0,-1);
      addAIMessage('"' + template.name + '" template loaded! Edit any field directly.', 'assistant');
    }
  } catch (e) {
    removeAILoading();
    addAIMessage('Error loading template. Try again.', 'system');
  }
  }

// ==============================
// DOWNLOADS
// ==============================
async function downloadPDF() {
    var canvas = document.getElementById('docCanvas');
    if (!canvas) return;
    var docTitle = document.getElementById('docTitle') ? document.getElementById('docTitle').value || 'DraftMyForms_Document' : 'DraftMyForms_Document';
    var safeName = docTitle.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');

    if (typeof html2pdf === 'undefined') {
      showToast('PDF library loading... try again in a moment.');
      return;
    }

    showToast('Generating PDF...');

    var clone = canvas.cloneNode(true);
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.width = '7.5in';
    clone.style.background = '#fff';
    clone.style.padding = '0.5in';
    document.body.appendChild(clone);

    var opt = {
      margin: [0.5, 0.6, 0.5, 0.6],
      filename: 'dmyf.' + safeName + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().set(opt).from(clone).save().then(function() {
      document.body.removeChild(clone);
      showToast('PDF downloaded!');
    }).catch(function(err) {
      console.error('PDF generation error:', err);
      document.body.removeChild(clone);
      showToast('PDF failed, falling back to print...');
      printDoc();
    });
  }

function downloadDocx() {
    const canvas = document.getElementById('docCanvas');
    const title = document.getElementById('docTitle').value || 'Untitled Document';
    
    // Inline computed styles before extracting HTML
    const allEls = canvas.querySelectorAll('*');
    const origStyles = [];
    allEls.forEach((el, i) => {
      origStyles[i] = el.getAttribute('style') || '';
      const cs = window.getComputedStyle(el);
      let s = el.style.cssText || '';
      if (cs.backgroundColor && cs.backgroundColor !== 'rgba(0, 0, 0, 0)') {
        s += 'background-color:' + cs.backgroundColor + ';';
      }
      if (cs.color) s += 'color:' + cs.color + ';';
      if (cs.fontFamily) s += 'font-family:' + cs.fontFamily + ';';
      if (cs.fontSize) s += 'font-size:' + cs.fontSize + ';';
      if (cs.fontWeight && cs.fontWeight !== '400' && cs.fontWeight !== 'normal') s += 'font-weight:' + cs.fontWeight + ';';
      if (cs.textAlign && cs.textAlign !== 'start') s += 'text-align:' + cs.textAlign + ';';
      if (el.tagName === 'TABLE') s += 'width:100%;border-collapse:collapse;';
      if (el.tagName === 'TH' || el.tagName === 'TD') {
        s += 'border:1px solid #999;padding:4px 8px;';
      }
      el.style.cssText = s;
    });
    
    const styledHTML = canvas.innerHTML;
    
    // Restore original styles
    allEls.forEach((el, i) => {
      if (origStyles[i]) el.setAttribute('style', origStyles[i]);
      else el.removeAttribute('style');
    });
    
    const header = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">' +
      '<head><meta charset="utf-8"><style>' +
      'body { font-family:Calibri,sans-serif; font-size:11pt; color:#2d2926; line-height:1.6; }' +
      'h1,h2,h3 { font-family:Georgia,serif; margin-bottom:8px; }' +
      'table { width:100%; border-collapse:collapse; }' +
      'th,td { border:1px solid #999; padding:4px 8px; }' +
      'th { background-color:#c99532; color:#fff; font-weight:bold; }' +
      'img { max-width:100%; }' +
      'ul,ol { margin-left:20px; }' +
      'hr { border:none; border-top:1px solid #ccc; margin:10px 0; }' +
      '</style></head><body>' + styledHTML + '</body></html>';
    
    const blob = new Blob([header], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = title.replace(/[^a-zA-Z0-9 ]/g, '_') + '.doc';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Document downloaded!');
  }

function saveDocument() {
  let _uid = null; try { const _s = localStorage.getItem("sb-mupeqeuuwdmkndvtbhzb-auth-token"); if(_s){const _d=JSON.parse(_s);_uid=_d?.user?.id||_d?.currentSession?.user?.id||null;} } catch(e){}

  const data = {
    title: document.getElementById('docTitle').value,
    user_id: _uid,
    content: docCanvas.innerHTML,
    savedAt: new Date().toISOString()
  };
  localStorage.setItem('dmf_doc_' + Date.now(), JSON.stringify(data));
  document.getElementById('saveStatus').textContent = 'Saved ' + new Date().toLocaleTimeString();
  showToast('Document saved locally!');
}

// ==============================
// PREVIEW TOGGLE + RESIZE
// ==============================
function togglePreview() {
  const pane = document.getElementById('previewPane');
  const divider = document.getElementById('previewDivider');
  previewVisible = !previewVisible;
  pane.style.display = previewVisible ? 'flex' : 'none';
  divider.style.display = previewVisible ? 'block' : 'none';
}

// Resizable divider
(function() {
  const divider = document.getElementById('previewDivider');
  const preview = document.getElementById('previewPane');
  let isResizing = false;
  
  divider.addEventListener('mousedown', (e) => {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    const container = document.querySelector('.editor-split');
    const rect = container.getBoundingClientRect();
    const newWidth = rect.right - e.clientX;
    if (newWidth > 200 && newWidth < rect.width * 0.7) {
      preview.style.width = newWidth + 'px';
    }
  });
  
  document.addEventListener('mouseup', () => {
    isResizing = false;
    document.body.style.cursor = '';
  });
})();

// ==============================
// DRAG & DROP
// ==============================
docCanvas.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
docCanvas.addEventListener('drop', (e) => {
  e.preventDefault();
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    const file = files[0];
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.createElement('img');
        img.src = ev.target.result;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '4px';
        docCanvas.appendChild(img);
        updatePreview();
      };
      reader.readAsDataURL(file);
    }
  }
});

// Upload zone drag/drop
const uploadZone = document.getElementById('uploadZone');
if (uploadZone) {
  uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.style.borderColor = '#c99532'; });
  uploadZone.addEventListener('dragleave', () => { uploadZone.style.borderColor = ''; });
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '';
    const fileInput = document.getElementById('fileInput');
    fileInput.files = e.dataTransfer.files;
    handleFileUpload(fileInput);
  });
}

// ==============================
// TOAST
// ==============================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}


  // AUTO-SAVE (Issue 13)
  var autoSaveTimer = null;
  function autoSave() {
  let _uid = null; try { const _s = localStorage.getItem("sb-mupeqeuuwdmkndvtbhzb-auth-token"); if(_s){const _d=JSON.parse(_s);_uid=_d?.user?.id||_d?.currentSession?.user?.id||null;} } catch(e){}

    var cnt = docCanvas.innerHTML;
    if (!cnt || cnt.trim() === '' || cnt.trim() === '<br>') return;
    var data = { title: document.getElementById('docTitle').value,user_id:_uid, content: cnt, savedAt: new Date().toISOString() };
    localStorage.setItem('dmf_autosave', JSON.stringify(data));
    document.getElementById('saveStatus').textContent = 'Auto-saved ' + new Date().toLocaleTimeString();
  }

  // MOBILE AI FUNCTIONS (Issue 12)
  function openMobileAI() {
    document.getElementById('mobileAiOverlay').classList.add('active');
    document.getElementById('mobileAiSheet').classList.add('active');
    setTimeout(function(){ document.getElementById('mobileAiInput').focus(); }, 300);
  }
  function closeMobileAI() {
    document.getElementById('mobileAiOverlay').classList.remove('active');
    document.getElementById('mobileAiSheet').classList.remove('active');
  }
  function sendMobileAI() {
    var input = document.getElementById('mobileAiInput');
    var prompt = input.value.trim();
    if (!prompt) return;
    input.value = '';
    var msgs = document.getElementById('mobileAiMessages');
    msgs.innerHTML += '<div class="ai-msg user" style="font-size:12px;margin-bottom:8px">' + prompt.replace(/</g,'&lt;') + '</div>';
    msgs.innerHTML += '<div class="ai-loading" id="mobileLoading" style="font-size:12px">Generating<span class="dots"><span>.</span><span>.</span><span>.</span></span></div>';
    msgs.scrollTop = msgs.scrollHeight;
    document.getElementById('aiPrompt').value = prompt;
    sendAI().then(function() {
      var el = document.getElementById('mobileLoading');
      if (el) el.remove();
      msgs.innerHTML += '<div class="ai-msg assistant" style="font-size:12px;margin-bottom:8px">Done! Check the editor.</div>';
      msgs.scrollTop = msgs.scrollHeight;
    });
  }

  // TEMPLATE SEARCH (Issue 11)
  function filterTemplates(query) {
    if (!query) { var activeTab = document.querySelector('.template-tab.active'); if (activeTab) { var cat = activeTab.textContent.split(' ')[0]; renderTemplateGrid(cat); } return; }
    query = query.toLowerCase();
    var results = [];
    Object.keys(TEMPLATES).forEach(function(cat) {
      TEMPLATES[cat].forEach(function(t, i) {
        if (t.name.toLowerCase().includes(query) || t.style.toLowerCase().includes(query) || cat.toLowerCase().includes(query)) {
          results.push({t: t, cat: cat, i: i});
        }
      });
    });
    var grid = document.getElementById('templateGrid');
    if (!results.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">No templates match your search</div>'; return; }
    grid.innerHTML = results.map(function(r) {
      var b = r.t.tier === 'free' ? 'badge-free' : r.t.tier === 'pro' ? 'badge-pro' : 'badge-biz';
      return '<div class="template-card" onclick="loadTemplate(\'' + r.cat + '\',' + r.i + ')"><div class="preview" style="display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:28px;background:var(--paper)"><i class="fas fa-file-alt"></i></div><div class="info"><h4>' + r.t.name + ' <span class="badge ' + b + '">' + r.t.tier.charAt(0).toUpperCase() + r.t.tier.slice(1) + '</span></h4><span>' + r.cat.slice(0,-1) + '</span></div></div>';
    }).join('');
  }

  // LOAD FROM DASHBOARD / AUTOSAVE
  (
// === TASK 2: Default Editor Content by Plan ===
function getDefaultEditorContent() {
  var plan = window.__dmfUserPlan || "free";
  if (plan === "business") {
    return '<div style="text-align:center;padding:60px 20px;"><h1 style="font-size:24px;color:#1B3A5C;margin-bottom:8px;font-family:Playfair Display,serif;">Untitled Document</h1><p style="color:#7C3AED;font-size:13px;font-weight:500;">\ud83d\udcbc Business Plan \u2014 Unlimited AI credits</p><p style="color:#999;font-size:14px;margin-top:12px;">Start typing or use AI to create a document</p></div>';
  }
  if (plan === "pro") {
    return '<div style="text-align:center;padding:60px 20px;"><h1 style="font-size:24px;color:#1B3A5C;margin-bottom:8px;font-family:Playfair Display,serif;">Untitled Document</h1><p style="color:#D97706;font-size:13px;font-weight:500;">\u2728 Pro Plan \u2014 50 AI credits/month</p><p style="color:#999;font-size:14px;margin-top:12px;">Start typing or use AI to create a document</p></div>';
  }
  return '<div style="text-align:center;padding:60px 20px;"><h1 style="font-size:24px;color:#1B3A5C;margin-bottom:8px;font-family:Playfair Display,serif;">Untitled Document</h1><p style="color:#999;font-size:14px;">Start typing or choose a template from the sidebar</p></div>';
}
function loadSavedContent() {
    var loadKey = sessionStorage.getItem('dmf_load_doc');
    if (loadKey) {
      sessionStorage.removeItem('dmf_load_doc');
      try { var doc = JSON.parse(localStorage.getItem(loadKey)); if (doc && doc.content) { docCanvas.innerHTML = doc.content; document.getElementById('docTitle').value = doc.title || 'Untitled'; updatePreview(); updateWordCount(); return; } } catch(e) {}
    }
    var auto = localStorage.getItem('dmf_autosave');
    if (auto) {
      try { var doc = JSON.parse(auto); if (doc.content && doc.content.trim() !== '' && doc.content.trim() !== '<br>') { docCanvas.innerHTML = doc.content; document.getElementById('docTitle').value = doc.title || 'Untitled'; updatePreview(); updateWordCount(); } } catch(e) {}
    }
  
  // Default content if no saved document
  if (docCanvas && !docCanvas.innerHTML.trim()) {
    docCanvas.innerHTML = getDefaultEditorContent();
  }
})();

// ==============================
// KEYBOARD SHORTCUTS
// ==============================
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveDocument();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
    e.preventDefault();
    printDoc();
  }
});

// ==============================
// INIT: Load from URL params
// ==============================
(function init() {
  const params = new URLSearchParams(window.location.search);
  const type = params.get('type');
  const template = params.get('template');
  
  if (type) {
    document.getElementById('aiPrompt').value = 'Create a professional ' + type + (template ? ' using ' + template + ' style' : '') + ' with sample data. Make it polished and professional.';
    setTimeout(() => sendAI(), 500);
  }
  
  // Auto-show AI sidebar on desktop
  if (window.innerWidth > 768) {
    document.getElementById('aiSidebar').classList.remove('collapsed');
  }
  
  updatePreview();
})();

function openEditorUpgrade() {
  var overlay = document.getElementById('editorUpgradeOverlay');
  if (overlay) { overlay.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
}
function closeEditorUpgrade() {
  var overlay = document.getElementById('editorUpgradeOverlay');
  if (overlay) { overlay.style.display = 'none'; document.body.style.overflow = ''; }
}
async function editorCheckout(plan) {
  var btn = document.getElementById(plan === 'pro' ? 'edBtnPro' : 'edBtnBiz');
  var orig = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = 'Redirecting...';
  try {
    var session = JSON.parse(localStorage.getItem('sb-mupeqeuuwdmkndvtbhzb-auth-token') || '{}');
    var user = session && session.user ? session.user : null;
    if (!user) { alert('Please sign in first.'); btn.disabled = false; btn.innerHTML = orig; return; }
    var resp = await fetch('/api/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plan: plan, userId: user.id, userEmail: user.email })
    });
    var data = await resp.json();
    if (data.url) { window.location.href = data.url; }
    else { alert('Error: ' + (data.error || 'Could not start checkout')); btn.disabled = false; btn.innerHTML = orig; }
  } catch (e) { alert('Connection error. Please try again.'); btn.disabled = false; btn.innerHTML = orig; }
}
(function checkEditorPlan() {
  try {
    var session = JSON.parse(localStorage.getItem('sb-mupeqeuuwdmkndvtbhzb-auth-token') || '{}');
    var user = session && session.user ? session.user : null;
    if (user) {
      var sbClient = window.supabase ? window.supabase.createClient('https://mupeqeuuwdmkndvtbhzb.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk') : null;
      if (sbClient) {
        sbClient.from('profiles').select('plan').eq('id', user.id).single().then(function(r) {
          var plan = r.data ? r.data.plan : 'free';
      window.__dmfUserPlan = plan;
          var btn = document.getElementById('editorUpgradeBtn');
          if (btn && (!plan || plan === 'free')) { btn.style.display = 'inline-flex'; }
        });
      }
    }
  } catch(e) {}
})();


    // ===== ACTIVE DAY TRACKING FOR TRIAL ELIGIBILITY =====
    (function logEditorActivity() {
        try {
            var session = JSON.parse(localStorage.getItem('sb-mupeqeuuwdmkndvtbhzb-auth-token') || '{}');
            var token = session.access_token;
            var userId = session.user ? session.user.id : null;
            if (!token || !userId) return;
            fetch('/api/log-activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ userId: userId, action: 'editor_open' })
            }).catch(function() {});
        } catch(e) {}
    })();
// ===== AUTH CALLBACK ‚Äî Session Logging + Welcome Email =====
(function callAuthCallback() {
  try {
    var session = JSON.parse(localStorage.getItem("sb-mupeqeuuwdmkndvtbhzb-auth-token") || "{}");
    var userId = session.user ? session.user.id : null;
    var email = session.user ? session.user.email : null;
    if (!userId || !email) return;
    fetch("/api/auth-callback", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: userId, email: email, name: email })
    }).catch(function() {});
  } catch(e) {}
})();

  // ===== SITE BANNER LOADER =====
  async function loadSiteBanner() {
    try {
      if (typeof sbClient === 'undefined') return;
      const now = new Date().toISOString();
      const { data, error } = await sbClient
        .from('site_banners')
        .select('*')
        .eq('is_active', true)
        .or('starts_at.is.null,starts_at.lte.' + now)
        .or('ends_at.is.null,ends_at.gte.' + now)
        .order('created_at', { ascending: false })
        .limit(1);
      if (error || !data || data.length === 0) return;
      const b = data[0];
      const dismissed = sessionStorage.getItem('banner_dismissed_' + b.id);
      if (dismissed) return;
      const el = document.getElementById('siteBanner');
      if (!el) return;
      let linkHtml = '';
      if (b.link_url) {
        linkHtml = ' <a href="' + b.link_url + '" style="color:' + (b.text_color || '#fff') + ';text-decoration:underline;font-weight:600">' + (b.link_text || 'Learn More') + '</a>';
      }
      let closeBtn = '';
      if (b.is_dismissible) {
        closeBtn = ' <button onclick="dismissBanner(' + b.id + ')" style="background:none;border:none;color:' + (b.text_color || '#fff') + ';font-size:18px;cursor:pointer;margin-left:12px" aria-label="Close">&times;</button>';
      }
      el.innerHTML = '<div style="background:' + (b.bg_color || '#c99532') + ';color:' + (b.text_color || '#ffffff') + ';text-align:center;padding:10px 16px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px">' + '<span>' + b.message + linkHtml + '</span>' + closeBtn + '</div>';
    } catch (e) {
      console.error('Banner load error:', e);
    }
  }
  function dismissBanner(id) {
    sessionStorage.setItem('banner_dismissed_' + id, '1');
    const el = document.getElementById('siteBanner');
    if (el) el.innerHTML = '';
  }
  loadSiteBanner();

  // ===== E-SIGNATURE FEATURE =====
  var sigCanvas, sigCtx, sigDrawing = false, sigCurrentTab = 'draw', sigSelectedFont = 'Dancing Script';
  var sigSelectedSavedId = null;

  function initSigCanvas() {
    sigCanvas = document.getElementById('sigCanvas');
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');
    sigCanvas.width = sigCanvas.offsetWidth * 2;
    sigCanvas.height = 360;
    sigCtx.scale(2, 2);
    sigCtx.lineCap = 'round';
    sigCtx.lineJoin = 'round';
    sigCanvas.addEventListener('mousedown', sigStartDraw);
    sigCanvas.addEventListener('mousemove', sigDraw);
    sigCanvas.addEventListener('mouseup', sigStopDraw);
    sigCanvas.addEventListener('mouseleave', sigStopDraw);
    sigCanvas.addEventListener('touchstart', function(e) { e.preventDefault(); sigStartDraw(e.touches[0]); }, {passive:false});
    sigCanvas.addEventListener('touchmove', function(e) { e.preventDefault(); sigDraw(e.touches[0]); }, {passive:false});
    sigCanvas.addEventListener('touchend', sigStopDraw);
  }

  function sigStartDraw(e) {
    sigDrawing = true;
    var rect = sigCanvas.getBoundingClientRect();
    sigCtx.beginPath();
    sigCtx.strokeStyle = document.getElementById('sigColor').value;
    sigCtx.lineWidth = parseInt(document.getElementById('sigWidth').value);
    sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  }

  function sigDraw(e) {
    if (!sigDrawing) return;
    var rect = sigCanvas.getBoundingClientRect();
    sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    sigCtx.stroke();
  }

  function sigStopDraw() { sigDrawing = false; }

  function clearSigPad() {
    if (sigCurrentTab === 'draw' && sigCtx) {
      sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    } else if (sigCurrentTab === 'type') {
      document.getElementById('sigTypeInput').value = '';
    }
    sigSelectedSavedId = null;
  }

  function openSignatureModal() {
    document.getElementById('sigOverlay').classList.add('active');
    setTimeout(initSigCanvas, 100);
    loadSavedSignatures();
  }

  function closeSignatureModal() {
    document.getElementById('sigOverlay').classList.remove('active');
  }

  function switchSigTab(tab) {
    sigCurrentTab = tab;
    document.querySelectorAll('.sig-tab').forEach(function(t, i) {
      t.classList.toggle('active', (i === 0 && tab === 'draw') || (i === 1 && tab === 'type') || (i === 2 && tab === 'saved'));
    });
    document.getElementById('sigTabDraw').style.display = tab === 'draw' ? '' : 'none';
    document.getElementById('sigTabType').style.display = tab === 'type' ? '' : 'none';
    document.getElementById('sigTabSaved').style.display = tab === 'saved' ? '' : 'none';
    if (tab === 'draw') setTimeout(initSigCanvas, 100);
    if (tab === 'saved') loadSavedSignatures();
  }

  function setSigFont(btn, font) {
    sigSelectedFont = font;
    document.querySelectorAll('.sig-font-opt').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('sigTypeInput').style.fontFamily = "'" + font + "',cursive";
  }

  function getSignatureDataURL() {
    if (sigCurrentTab === 'draw') {
      if (!sigCanvas) return null;
      var tempCanvas = document.createElement('canvas');
      tempCanvas.width = sigCanvas.width;
      tempCanvas.height = sigCanvas.height;
      var tCtx = tempCanvas.getContext('2d');
      tCtx.drawImage(sigCanvas, 0, 0);
      var imgData = tCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height).data;
      var hasContent = false;
      for (var i = 3; i < imgData.length; i += 4) { if (imgData[i] > 0) { hasContent = true; break; } }
      if (!hasContent) return null;
      return sigCanvas.toDataURL('image/png');
    } else if (sigCurrentTab === 'type') {
      var text = document.getElementById('sigTypeInput').value.trim();
      if (!text) return null;
      var tc = document.createElement('canvas');
      tc.width = 600; tc.height = 160;
      var ctx = tc.getContext('2d');
      ctx.font = '48px ' + sigSelectedFont + ', cursive';
      ctx.fillStyle = document.getElementById('sigColor').value || '#000';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, 300, 80);
      return tc.toDataURL('image/png');
    } else if (sigCurrentTab === 'saved' && sigSelectedSavedId) {
      var selItem = document.querySelector('.sig-saved-item.selected img');
      return selItem ? selItem.src : null;
    }
    return null;
  }

  async function insertSignature() {
    var dataURL = getSignatureDataURL();
    if (!dataURL) { alert('Please draw, type, or select a signature first.'); return; }
    var shouldSave = document.getElementById('sigSaveCheck').checked;
    if (shouldSave && sigCurrentTab !== 'saved') {
      await saveSignatureToDb(dataURL);
    }
    var imgHTML = '<div style="margin:16px 0;"><img src="' + dataURL + '" style="max-width:250px;max-height:80px;" alt="Signature"><div style="border-top:1px solid #333;width:250px;margin-top:4px;padding-top:2px;font-size:11px;color:#666;">Authorized Signature \u2022 ' + new Date().toLocaleDateString() + '</div></div>';
    var editor = document.getElementById('editor');
    if (editor) {
      editor.focus();
      document.execCommand('insertHTML', false, imgHTML);
    }
    closeSignatureModal();
  }

  async function saveSignatureToDb(dataURL) {
    try {
      if (typeof sbClient === 'undefined') return;
      var session = (await sbClient.auth.getSession()).data.session;
      if (!session) return;
      var name = sigCurrentTab === 'type' ? document.getElementById('sigTypeInput').value.trim() : 'Drawn Signature';
      await sbClient.from('signatures').insert({
        user_id: session.user.id,
        name: name || 'My Signature',
        type: sigCurrentTab,
        data: dataURL,
        font_family: sigCurrentTab === 'type' ? sigSelectedFont : null,
        is_default: false
      });
    } catch(e) { console.error('Save signature error:', e); }
  }

  async function loadSavedSignatures() {
    var list = document.getElementById('sigSavedList');
    if (!list) return;
    try {
      if (typeof sbClient === 'undefined') { list.innerHTML = '<p style="color:#8a7f76;text-align:center;width:100%">Sign in to save signatures</p>'; return; }
      var session = (await sbClient.auth.getSession()).data.session;
      if (!session) { list.innerHTML = '<p style="color:#8a7f76;text-align:center;width:100%">Sign in to save signatures</p>'; return; }
      var result = await sbClient.from('signatures').select('*').eq('user_id', session.user.id).order('created_at', { ascending: false });
      if (!result.data || result.data.length === 0) {
        list.innerHTML = '<p style="color:#8a7f76;text-align:center;width:100%">No saved signatures yet. Draw or type one and save it.</p>';
        return;
      }
      list.innerHTML = result.data.map(function(s) {
        return '<div class="sig-saved-item" onclick="selectSavedSig(this,\'' + s.id + '\')" data-id="' + s.id + '"><img src="' + s.data + '"><div class="sig-name">' + (s.name || 'Signature') + '</div></div>';
      }).join('');
    } catch(e) { list.innerHTML = '<p style="color:#c24b3b">Error loading signatures</p>'; }
  }

  function selectSavedSig(el, id) {
    document.querySelectorAll('.sig-saved-item').forEach(function(item){ item.classList.remove('selected'); });
    el.classList.add('selected');
    sigSelectedSavedId = id;
  }
</script>

<!-- LLC FOOTER -->
<div style="position:fixed;bottom:0;left:0;right:0;text-align:center;padding:3px;font-size:10px;color:#8a7f76;background:rgba(255,255,255,.9);border-top:1px solid #e8ddd4;z-index:10;pointer-events:none">A product of <strong>Wmk Speciality Services L.L.C.</strong></div>


<!-- E-SIGNATURE MODAL -->
<div class="sig-overlay" id="sigOverlay">
  <div class="sig-modal">
    <div class="sig-header">
      <h3><i class="fas fa-signature" style="color:var(--gold);margin-right:8px"></i>E-Signature</h3>
      <button class="sig-close" onclick="closeSignatureModal()">&times;</button>
    </div>
    <div class="sig-tabs">
      <button class="sig-tab active" onclick="switchSigTab('draw')"><i class="fas fa-pen"></i> Draw</button>
      <button class="sig-tab" onclick="switchSigTab('type')"><i class="fas fa-keyboard"></i> Type</button>
      <button class="sig-tab" onclick="switchSigTab('saved')"><i class="fas fa-bookmark"></i> Saved</button>
    </div>
    <div class="sig-body">
      <div id="sigTabDraw">
        <div class="sig-canvas-wrap">
          <canvas id="sigCanvas" width="520" height="180"></canvas>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:12px;color:#8a7f76">Color:</label>
          <input type="color" id="sigColor" value="#000000" style="width:32px;height:28px;border:none;cursor:pointer">
          <label style="font-size:12px;color:#8a7f76;margin-left:8px">Width:</label>
          <input type="range" id="sigWidth" min="1" max="6" value="2" style="width:80px">
        </div>
      </div>
      <div id="sigTabType" style="display:none">
        <input type="text" class="sig-type-input" id="sigTypeInput" placeholder="Type your name" style="font-family:'Dancing Script',cursive">
        <div class="sig-font-select">
          <button class="sig-font-opt active" onclick="setSigFont(this,'Dancing Script')" style="font-family:'Dancing Script',cursive">Signature</button>
          <button class="sig-font-opt" onclick="setSigFont(this,'Great Vibes')" style="font-family:'Great Vibes',cursive">Elegant</button>
          <button class="sig-font-opt" onclick="setSigFont(this,'Caveat')" style="font-family:'Caveat',cursive">Casual</button>
          <button class="sig-font-opt" onclick="setSigFont(this,'Homemade Apple')" style="font-family:'Homemade Apple',cursive">Handwritten</button>
        </div>
      </div>
      <div id="sigTabSaved" style="display:none">
        <div class="sig-saved-list" id="sigSavedList"><p style="color:#8a7f76;text-align:center;width:100%">Loading saved signatures...</p></div>
      </div>
    </div>
    <div class="sig-actions">
      <div style="display:flex;gap:8px">
        <button class="sig-btn sig-btn-clear" onclick="clearSigPad()">Clear</button>
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#8a7f76"><input type="checkbox" id="sigSaveCheck" checked> Save for reuse</label>
      </div>
      <button class="sig-btn sig-btn-insert" onclick="insertSignature()"><i class="fas fa-check"></i> Insert Signature</button>
    </div>
  </div>
</div>
<script src="template-previews.js"></script>
</body>
</html>
