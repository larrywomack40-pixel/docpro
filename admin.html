<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Dashboard | DraftMyForms</title>
<meta name="robots" content="noindex,nofollow">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--gold:#c99532;--gold-light:#e8b94a;--gold-dark:#a67a28;--gold-bg:#fef8ee;--paper:#faf7f5;--white:#ffffff;--text:#1a1a1a;--text-secondary:#555;--text-muted:#888;--border:#e5e0db;--border-light:#f0ebe6;--success:#3a6633;--danger:#c24b3b;--info:#2563eb;--font-heading:'Playfair Display',Georgia,serif;--font-body:'DM Sans',-apple-system,sans-serif}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:#f5f3f0;color:var(--text);min-height:100vh}
.navbar{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-light);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between}
.nav-brand{display:flex;align-items:center;gap:10px;font-family:var(--font-heading);font-weight:700;font-size:20px;color:var(--text);text-decoration:none}
.nav-brand .star{color:var(--gold);font-size:22px}
.nav-badge{background:var(--danger);color:#fff;font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600;font-family:var(--font-body)}
.nav-actions{display:flex;align-items:center;gap:12px}
.nav-actions a{color:var(--text-secondary);text-decoration:none;font-size:14px;padding:8px 12px;border-radius:8px;transition:all .2s}
.nav-actions a:hover{background:var(--gold-bg);color:var(--gold-dark)}

.container{max-width:1200px;margin:0 auto;padding:88px 24px 40px}

.loading-state{display:flex;justify-content:center;align-items:center;min-height:60vh;font-size:18px;color:var(--text-muted)}
.access-denied{display:none;text-align:center;padding:120px 24px}
.access-denied h2{font-family:var(--font-heading);font-size:32px;margin-bottom:12px;color:var(--danger)}
.access-denied p{color:var(--text-secondary);margin-bottom:24px}

.admin-content{display:none}
.page-header{margin-bottom:32px}
.page-header h1{font-family:var(--font-heading);font-size:28px;margin-bottom:4px}
.page-header p{color:var(--text-muted);font-size:14px}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:#fff;border-radius:12px;padding:20px 24px;border:1px solid var(--border-light)}
.stat-card .value{font-family:var(--font-heading);font-size:28px;color:var(--gold);font-weight:700}
.stat-card .label{font-size:13px;color:var(--text-muted);margin-top:4px}

.section{background:#fff;border-radius:12px;border:1px solid var(--border-light);margin-bottom:24px;overflow:hidden}
.section-header{padding:20px 24px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center}
.section-header h2{font-family:var(--font-heading);font-size:20px}
.section-body{padding:0}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px 24px;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;background:#faf9f7;border-bottom:1px solid var(--border-light)}
td{padding:14px 24px;font-size:14px;border-bottom:1px solid var(--border-light)}
tr:last-child td{border-bottom:none}
tr:hover td{background:#faf9f7}

.plan-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;text-transform:capitalize}
.plan-free{background:#f0f0f0;color:#666}
.plan-pro{background:#e8f4fd;color:#1a73e8}
.plan-business{background:var(--gold-bg);color:var(--gold-dark)}

.role-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;text-transform:capitalize}
.role-admin{background:#fce4ec;color:#c62828}
.role-customer{background:#e8f5e9;color:#2e7d32}

.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer;font-family:var(--font-body);transition:all .2s}
.btn-sm:hover{background:var(--gold-bg);border-color:var(--gold)}
.btn-danger{color:var(--danger);border-color:var(--danger)}
.btn-danger:hover{background:#fce4ec}

.search-bar{padding:16px 24px;border-bottom:1px solid var(--border-light)}
.search-bar input{width:100%;padding:10px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font-body);outline:none;transition:border .2s}
.search-bar input:focus{border-color:var(--gold)}

.empty-state{padding:40px;text-align:center;color:var(--text-muted)}
.quick-actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:32px}
.quick-actions a{display:flex;align-items:center;gap:8px;padding:10px 20px;background:#fff;border:1px solid var(--border-light);border-radius:10px;text-decoration:none;color:var(--text);font-size:14px;transition:all .2s}
.quick-actions a:hover{border-color:var(--gold);background:var(--gold-bg)}
.quick-actions a i{color:var(--gold)}

footer{text-align:center;padding:24px;color:var(--text-muted);font-size:13px}
footer strong{color:var(--gold-dark)}

select.plan-select{padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:var(--font-body);cursor:pointer;background:#fff}
</style>
</head>
<body>

<nav class="navbar">
<a href="/" class="nav-brand"><span class="star">&#10022;</span> DraftMyForms <span class="nav-badge">ADMIN</span></a>
<div class="nav-actions">
<a href="/dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
<a href="/editor.html"><i class="fas fa-edit"></i> Editor</a>
<a href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>
</nav>

<div class="container">
<div id="loadingState" class="loading-state">
<div><i class="fas fa-shield-alt" style="font-size:24px;color:var(--gold);margin-right:10px"></i> Verifying admin access...</div>
</div>

<div id="accessDenied" class="access-denied">
<i class="fas fa-lock" style="font-size:48px;color:var(--danger);margin-bottom:16px"></i>
<h2>Access Denied</h2>
<p>You do not have admin privileges to view this page.</p>
<a href="/dashboard.html" style="color:var(--gold);text-decoration:underline">Return to Dashboard</a>
</div>

<div id="adminContent" class="admin-content">
<div class="page-header">
<h1>&#9881; Admin Dashboard</h1>
<p>Platform overview and user management for DraftMyForms</p>
</div>

<div class="quick-actions">
<a href="/"><i class="fas fa-globe"></i> View Live Site</a>
<a href="/editor.html"><i class="fas fa-edit"></i> Open Editor</a>
<a href="/dashboard.html"><i class="fas fa-tachometer-alt"></i> User Dashboard</a>
<a href="https://supabase.com/dashboard" target="_blank"><i class="fas fa-database"></i> Supabase</a>
<a href="https://vercel.com" target="_blank"><i class="fas fa-server"></i> Vercel</a>
<a href="https://dashboard.stripe.com" target="_blank"><i class="fas fa-credit-card"></i> Stripe</a>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="value" id="statTotalUsers">-</div><div class="label">Total Users</div></div>
<div class="stat-card"><div class="value" id="statFreeUsers">-</div><div class="label">Free Plan</div></div>
<div class="stat-card"><div class="value" id="statProUsers">-</div><div class="label">Pro Plan</div></div>
<div class="stat-card"><div class="value" id="statBizUsers">-</div><div class="label">Business Plan</div></div>
<div class="stat-card"><div class="value" id="statEmailLeads">-</div><div class="label">Email Leads</div></div>
<div class="stat-card"><div class="value" id="statDocs">-</div><div class="label">Saved Documents</div></div>
</div>

<div class="section">
<div class="section-header">
<h2><i class="fas fa-users" style="color:var(--gold);margin-right:8px"></i> User Management</h2>
<span id="userCount" style="color:var(--text-muted);font-size:13px"></span>
</div>
<div class="search-bar">
<input type="text" id="userSearch" placeholder="Search by email or name..." oninput="filterUsers()">
</div>
<div class="section-body">
<table>
<thead><tr><th>Email</th><th>Display Name</th><th>Role</th><th>Plan</th><th>Actions</th></tr></thead>
<tbody id="usersTableBody"><tr><td colspan="5" class="empty-state">Loading users...</td></tr></tbody>
</table>
</div>
</div>

<div class="section">
<div class="section-header">
<h2><i class="fas fa-envelope" style="color:var(--gold);margin-right:8px"></i> Email Leads</h2>
<span id="leadCount" style="color:var(--text-muted);font-size:13px"></span>
</div>
<div class="section-body">
<table>
<thead><tr><th>Email</th><th>Source</th><th>Date</th></tr></thead>
<tbody id="leadsTableBody"><tr><td colspan="3" class="empty-state">Loading...</td></tr></tbody>
</table>
</div>
</div>

</div>
</div>



<!-- Banner Management -->
<div class="admin-section" style="background:#fff;border:1px solid #e8ddd4;border-radius:12px;padding:30px;margin:30px 0">
<h2 style="font-family:Playfair Display,serif;margin-bottom:5px">üì¢ Site Banner</h2>
<p style="color:#8a7f76;margin-bottom:20px">Control the global banner shown across all user pages</p>
<div id="bannerPreview" style="margin-bottom:16px;border-radius:8px;overflow:hidden"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Banner Message</label>
  <input type="text" id="bannerMsg" placeholder="e.g. Maintenance tonight at 11 PM EST" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Type</label>
  <select id="bannerType" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"><option value="info">Info (Gold)</option><option value="warning">Warning (Orange)</option><option value="success">Success (Green)</option><option value="error">Error (Red)</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Link URL (optional)</label>
  <input type="text" id="bannerLink" placeholder="https://..." style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Link Text</label>
  <input type="text" id="bannerLinkText" placeholder="Learn more" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
  <div style="display:flex;align-items:end;gap:8px">
    <label style="font-size:13px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="bannerDismissible" checked> Dismissible</label>
  </div>
</div>
<div style="display:flex;gap:10px">
  <button onclick="publishBanner()" style="background:#c99532;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600">Publish Banner</button>
  <button onclick="deactivateBanner()" style="background:#c24b3b;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600">Remove Banner</button>
</div>
</div>

<!-- Admin Messaging -->
<div class="admin-section" style="background:#fff;border:1px solid #e8ddd4;border-radius:12px;padding:30px;margin:30px 0">
<h2 style="font-family:Playfair Display,serif;margin-bottom:5px">‚úâÔ∏è Messages</h2>
<p style="color:#8a7f76;margin-bottom:20px">Send messages to individual users or broadcast to all</p>
<div style="background:var(--paper,#f9f4f3);border-radius:10px;padding:20px;margin-bottom:20px">
<h3 style="font-size:16px;margin-bottom:12px">Send New Message</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">To</label>
  <select id="msgRecipient" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"><option value="broadcast">üì£ Broadcast to All Users</option></select></div>
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Subject</label>
  <input type="text" id="msgSubject" placeholder="Message subject" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
</div>
<div style="margin-bottom:12px"><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Message Body</label>
<textarea id="msgBody" rows="4" placeholder="Write your message..." style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px;font-family:inherit;resize:vertical"></textarea></div>
<button onclick="sendAdminMessage()" style="background:#c99532;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600"><i class="fas fa-paper-plane"></i> Send Message</button>
</div>
<h3 style="font-size:16px;margin-bottom:12px">Recent Messages</h3>
<div id="adminMsgList" style="max-height:300px;overflow-y:auto"><p style="color:#8a7f76;text-align:center;padding:20px">Loading...</p></div>
</div>

<footer>A product of <strong>WMK Speciality Services L.L.C.</strong></footer>

<script>
var SUPABASE_URL='https://mupeqeuuwdmkndvtbhzb.supabase.co';
var SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk';
var sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    var currentUser = null;
var allUsers=[];

async function init(){
try{
var{data:{session}}=await sb.auth.getSession();
if(!session){window.location.href='/';return}
var{data:profile}=await sb.from('profiles').select('role').eq('id',session.user.id).single();
if(!profile||profile.role!=='admin'){
document.getElementById('loadingState').style.display='none';
document.getElementById('accessDenied').style.display='block';
return;
}
    currentUser = session.user;
document.getElementById('loadingState').style.display='none';
document.getElementById('adminContent').style.display='block';
await loadStats();
await loadUsers();
await loadLeads();
    if(typeof loadBannerAdmin === "function") await loadBannerAdmin();
    if(typeof loadUserListForMessaging === "function") loadUserListForMessaging();
    if(typeof loadAdminMessages === "function") await loadAdminMessages();
}catch(e){
console.error('Admin init error:',e);
document.getElementById('loadingState').innerHTML='<div style="color:var(--danger)">Error loading admin dashboard. <a href="/">Go home</a></div>';
}
}

async function loadStats(){
var{data:profiles}=await sb.from('profiles').select('plan');
var{data:leads}=await sb.from('email_leads').select('id');
var{data:docs}=await sb.from('saved_documents').select('id');
var total=profiles?profiles.length:0;
var free=profiles?profiles.filter(function(p){return p.plan==='free'||!p.plan}).length:0;
var pro=profiles?profiles.filter(function(p){return p.plan==='pro'}).length:0;
var biz=profiles?profiles.filter(function(p){return p.plan==='business'}).length:0;
document.getElementById('statTotalUsers').textContent=total;
document.getElementById('statFreeUsers').textContent=free;
document.getElementById('statProUsers').textContent=pro;
document.getElementById('statBizUsers').textContent=biz;
document.getElementById('statEmailLeads').textContent=leads?leads.length:0;
document.getElementById('statDocs').textContent=docs?docs.length:0;
}

async function loadUsers(){
var{data:users,error}=await sb.from('profiles').select('*').order('email');
if(error){document.getElementById('usersTableBody').innerHTML='<tr><td colspan="5" class="empty-state">Error loading users</td></tr>';return}
allUsers=users||[];
document.getElementById('userCount').textContent=allUsers.length+' users';
renderUsers(allUsers);
}

function renderUsers(users){
var tbody=document.getElementById('usersTableBody');
if(!users.length){tbody.innerHTML='<tr><td colspan="5" class="empty-state">No users found</td></tr>';return}
var html='';
users.forEach(function(u){
var planClass='plan-'+(u.plan||'free');
var roleClass='role-'+(u.role||'customer');
html+='<tr>';
html+='<td style="font-weight:500">'+escHtml(u.email)+'</td>';
html+='<td>'+(u.display_name?escHtml(u.display_name):'<span style="color:var(--text-muted)">Not set</span>')+'</td>';
html+='<td><span class="role-badge '+roleClass+'">'+(u.role||'customer')+'</span></td>';
html+='<td><select class="plan-select" onchange="changePlan(this,\''+u.id+'\')" data-current="'+(u.plan||'free')+'">';
html+='<option value="free"'+(u.plan==='free'||!u.plan?' selected':'')+'>Free</option>';
html+='<option value="pro"'+(u.plan==='pro'?' selected':'')+'>Pro</option>';
html+='<option value="business"'+(u.plan==='business'?' selected':'')+'>Business</option>';
html+='</select></td>';
html+='<td>';
if(u.role!=='admin'){html+='<button class="btn-sm" onclick="toggleRole(\''+u.id+'\',\''+u.role+'\')">Toggle Admin</button> '}
html+='</td>';
html+='</tr>';
});
tbody.innerHTML=html;
}

function filterUsers(){
var q=document.getElementById('userSearch').value.toLowerCase();
if(!q){renderUsers(allUsers);return}
var filtered=allUsers.filter(function(u){
return (u.email&&u.email.toLowerCase().indexOf(q)>=0)||(u.display_name&&u.display_name.toLowerCase().indexOf(q)>=0);
});
renderUsers(filtered);
}

async function changePlan(selectEl,userId){
var newPlan=selectEl.value;
var oldPlan=selectEl.getAttribute('data-current');
if(newPlan===oldPlan)return;
var{error}=await sb.from('profiles').update({plan:newPlan}).eq('id',userId);
if(error){alert('Error updating plan: '+error.message);selectEl.value=oldPlan;return}
selectEl.setAttribute('data-current',newPlan);
await loadStats();
}

async function toggleRole(userId,currentRole){
var newRole=currentRole==='admin'?'customer':'admin';
if(newRole==='admin'&&!confirm('Grant admin access to this user?'))return;
var{error}=await sb.from('profiles').update({role:newRole}).eq('id',userId);
if(error){alert('Error updating role: '+error.message);return}
await loadUsers();
}

async function loadLeads(){
var{data:leads,error}=await sb.from('email_leads').select('*').order('created_at',{ascending:false});
var tbody=document.getElementById('leadsTableBody');
if(error||!leads){tbody.innerHTML='<tr><td colspan="3" class="empty-state">Error loading leads</td></tr>';return}
document.getElementById('leadCount').textContent=leads.length+' leads';
if(!leads.length){tbody.innerHTML='<tr><td colspan="3" class="empty-state">No email leads yet</td></tr>';return}
var html='';
leads.forEach(function(l){
var d=l.created_at?new Date(l.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'Unknown';
html+='<tr><td>'+escHtml(l.email)+'</td><td>'+(l.source||'N/A')+'</td><td>'+d+'</td></tr>';
});
tbody.innerHTML=html;
}

function escHtml(str){
if(!str)return '';
var d=document.createElement('div');
d.textContent=str;
return d.innerHTML;
}

function handleLogout(){
sb.auth.signOut().then(function(){window.location.href='/'});
}

init();


// === Phase 5: Banner Management ===
async function loadBannerAdmin() {
  const { data } = await sb.from("site_banners").select("*").order("created_at", { ascending: false }).limit(1);
  const preview = document.getElementById("bannerPreview");
  if (data && data.length && data[0].is_active) {
    const b = data[0];
    const colors = { info: "#c99532", warning: "#e67e22", success: "#3a6633", error: "#c24b3b" };
    preview.innerHTML = '<div style="background:' + (b.bg_color || colors[b.type] || "#c99532") + ';color:' + (b.text_color || "#fff") + ';padding:12px 20px;border-radius:8px;font-size:14px"><strong>LIVE:</strong> ' + b.message + '</div>';
    document.getElementById("bannerMsg").value = b.message || "";
    document.getElementById("bannerType").value = b.type || "info";
    document.getElementById("bannerLink").value = b.link_url || "";
    document.getElementById("bannerLinkText").value = b.link_text || "";
    document.getElementById("bannerDismissible").checked = b.is_dismissible !== false;
  } else {
    preview.innerHTML = '<div style="background:#f0f0f0;padding:12px 20px;border-radius:8px;font-size:14px;color:#888;text-align:center">No active banner</div>';
  }
}

async function publishBanner() {
  const msg = document.getElementById("bannerMsg").value.trim();
  if (!msg) { alert("Enter a banner message"); return; }
  const type = document.getElementById("bannerType").value;
  const colors = { info: "#c99532", warning: "#e67e22", success: "#3a6633", error: "#c24b3b" };
  await sb.from("site_banners").update({ is_active: false }).eq("is_active", true);
  const { error } = await sb.from("site_banners").insert({ message: msg, type: type, bg_color: colors[type], text_color: "#ffffff", link_url: document.getElementById("bannerLink").value || null, link_text: document.getElementById("bannerLinkText").value || null, is_dismissible: document.getElementById("bannerDismissible").checked, is_active: true, created_by: currentUser.id });
  if (error) { alert("Error: " + error.message); return; }
  alert("Banner published!");
  loadBannerAdmin();
}

async function deactivateBanner() {
  await sb.from("site_banners").update({ is_active: false }).eq("is_active", true);
  alert("Banner removed!");
  loadBannerAdmin();
}

// === Phase 5: Admin Messaging ===
async function loadUserListForMessaging() {
  const { data } = await sb.from("profiles").select("id, email, display_name").order("email");
  const select = document.getElementById("msgRecipient");
  if (data) {
    data.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = (u.display_name || "No name") + " (" + u.email + ")";
      select.appendChild(opt);
    });
  }
}

async function sendAdminMessage() {
  const recipient = document.getElementById("msgRecipient").value;
  const subject = document.getElementById("msgSubject").value.trim();
  const body = document.getElementById("msgBody").value.trim();
  if (!subject || !body) { alert("Subject and body required"); return; }
  if (recipient === "broadcast") {
    const { data: users } = await sb.from("profiles").select("id");
    if (users) {
      const msgs = users.map(u => ({ sender_id: currentUser.id, recipient_id: u.id, subject, body, is_broadcast: true }));
      const { error } = await sb.from("messages").insert(msgs);
      if (error) { alert("Error: " + error.message); return; }
      alert("Broadcast sent to " + users.length + " users!");
    }
  } else {
    const { error } = await sb.from("messages").insert({ sender_id: currentUser.id, recipient_id: recipient, subject, body });
    if (error) { alert("Error: " + error.message); return; }
    alert("Message sent!");
  }
  document.getElementById("msgSubject").value = "";
  document.getElementById("msgBody").value = "";
  loadAdminMessages();
}

async function loadAdminMessages() {
  const { data } = await sb.from("messages").select("*").eq("sender_id", currentUser.id).order("created_at", { ascending: false }).limit(20);
  const el = document.getElementById("adminMsgList");
  if (!data || !data.length) { el.innerHTML = '<p style="color:#8a7f76;text-align:center;padding:20px">No messages sent yet</p>'; return; }
  el.innerHTML = data.map(m => {
    const date = new Date(m.created_at).toLocaleDateString();
    return '<div style="padding:10px 12px;border-bottom:1px solid #e8ddd4;font-size:13px"><strong>' + m.subject + '</strong>' + (m.is_broadcast ? ' <span style="background:#c99532;color:#fff;font-size:10px;padding:1px 6px;border-radius:8px">Broadcast</span>' : '') + '<div style="color:#8a7f76;margin-top:2px">' + date + ' - ' + m.body.substring(0, 80) + (m.body.length > 80 ? "..." : "") + '</div></div>';
  }).join("");
}

// Call these after admin loads
setTimeout(function() { if (typeof loadBannerAdmin === "function") { loadBannerAdmin(); loadUserListForMessaging(); loadAdminMessages(); } }, 1000);
</script>
</body>
</html>
