<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Dashboard | DraftMyForms</title>
<meta name="robots" content="noindex,nofollow">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--gold:#c99532;--gold-light:#e8b94a;--gold-dark:#a67a28;--gold-bg:#fef8ee;--paper:#faf7f5;--white:#ffffff;--text:#1a1a1a;--text-secondary:#555;--text-muted:#888;--border:#e5e0db;--border-light:#f0ebe6;--success:#3a6633;--danger:#c24b3b;--info:#2563eb;--font-heading:'Playfair Display',Georgia,serif;--font-body:'DM Sans',-apple-system,sans-serif}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:#f5f3f0;color:var(--text);min-height:100vh}
.navbar{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-light);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between}
.nav-brand{display:flex;align-items:center;gap:10px;font-family:var(--font-heading);font-weight:700;font-size:20px;color:var(--text);text-decoration:none}
.nav-brand .star{color:var(--gold);font-size:22px}
.nav-badge{background:var(--danger);color:#fff;font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600;font-family:var(--font-body)}
.nav-actions{display:flex;align-items:center;gap:12px}
.nav-actions a{color:var(--text-secondary);text-decoration:none;font-size:14px;padding:8px 12px;border-radius:8px;transition:all .2s}
.nav-actions a:hover{background:var(--gold-bg);color:var(--gold-dark)}

.container{max-width:1200px;margin:0 auto;padding:88px 24px 40px}

.loading-state{display:flex;justify-content:center;align-items:center;min-height:60vh;font-size:18px;color:var(--text-muted)}
.access-denied{display:none;text-align:center;padding:120px 24px}
.access-denied h2{font-family:var(--font-heading);font-size:32px;margin-bottom:12px;color:var(--danger)}
.access-denied p{color:var(--text-secondary);margin-bottom:24px}

.admin-content{display:none}
.page-header{margin-bottom:32px}
.page-header h1{font-family:var(--font-heading);font-size:28px;margin-bottom:4px}
.page-header p{color:var(--text-muted);font-size:14px}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:#fff;border-radius:12px;padding:20px 24px;border:1px solid var(--border-light)}
.stat-card .value{font-family:var(--font-heading);font-size:28px;color:var(--gold);font-weight:700}
.stat-card .label{font-size:13px;color:var(--text-muted);margin-top:4px}

.section{background:#fff;border-radius:12px;border:1px solid var(--border-light);margin-bottom:24px;overflow:hidden}
.section-header{padding:20px 24px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center}
.section-header h2{font-family:var(--font-heading);font-size:20px}
.section-body{padding:0}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px 24px;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;background:#faf9f7;border-bottom:1px solid var(--border-light)}
td{padding:14px 24px;font-size:14px;border-bottom:1px solid var(--border-light)}
tr:last-child td{border-bottom:none}
tr:hover td{background:#faf9f7}

.plan-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;text-transform:capitalize}
.plan-free{background:#f0f0f0;color:#666}
.plan-pro{background:#e8f4fd;color:#1a73e8}
.plan-business{background:var(--gold-bg);color:var(--gold-dark)}

.role-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;text-transform:capitalize}
.role-admin{background:#fce4ec;color:#c62828}
.role-customer{background:#e8f5e9;color:#2e7d32}

.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer;font-family:var(--font-body);transition:all .2s}
.btn-sm:hover{background:var(--gold-bg);border-color:var(--gold)}
.btn-danger{color:var(--danger);border-color:var(--danger)}
.btn-danger:hover{background:#fce4ec}

.search-bar{padding:16px 24px;border-bottom:1px solid var(--border-light)}
.search-bar input{width:100%;padding:10px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font-body);outline:none;transition:border .2s}
.search-bar input:focus{border-color:var(--gold)}

.empty-state{padding:40px;text-align:center;color:var(--text-muted)}
.quick-actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:32px}
.quick-actions a{display:flex;align-items:center;gap:8px;padding:10px 20px;background:#fff;border:1px solid var(--border-light);border-radius:10px;text-decoration:none;color:var(--text);font-size:14px;transition:all .2s}
.quick-actions a:hover{border-color:var(--gold);background:var(--gold-bg)}
.quick-actions a i{color:var(--gold)}

footer{text-align:center;padding:24px;color:var(--text-muted);font-size:13px}
footer strong{color:var(--gold-dark)}

select.plan-select{padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:var(--font-body);cursor:pointer;background:#fff}

/* Plan Change Modal */
.plan-modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; display:none; align-items:center; justify-content:center; }
.plan-modal-overlay.active { display:flex; }
.plan-modal { background:#fff; border-radius:12px; padding:30px; max-width:500px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
.plan-modal h3 { margin:0 0 20px; font-size:1.3em; }
.plan-modal label { display:block; margin:10px 0 4px; font-weight:600; font-size:0.9em; color:#555; }
.plan-modal select, .plan-modal input[type=text] { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:0.95em; }
.plan-modal .trial-options { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
.plan-modal .trial-btn { padding:6px 14px; border:1px solid #ddd; border-radius:20px; background:#f9f9f9; cursor:pointer; font-size:0.85em; transition:all 0.2s; }
.plan-modal .trial-btn:hover, .plan-modal .trial-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }
.plan-modal .notify-check { display:flex; align-items:center; gap:8px; margin:12px 0; font-size:0.9em; }
.plan-modal .modal-actions { display:flex; gap:10px; margin-top:20px; justify-content:flex-end; }
.plan-modal .modal-actions button { padding:10px 24px; border-radius:8px; font-size:0.95em; cursor:pointer; border:none; }
.plan-modal .btn-cancel { background:#f0f0f0; color:#333; }
.plan-modal .btn-confirm { background:var(--primary); color:#fff; font-weight:600; }
.plan-modal .btn-confirm:hover { opacity:0.9; }
.plan-modal .current-info { background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9em; }
.plan-modal .current-info strong { color:var(--primary); }
.plan-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:0.75em; margin-left:6px; }
.plan-badge.trial { background:#fff3cd; color:#856404; }
.plan-badge.override { background:#d4edda; color:#155724; }
.plan-badge.expired { background:#f8d7da; color:#721c24; }
/* Referrals Section */
.referral-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; margin:15px 0; }
.ref-stat { background:#f8f9fa; padding:15px; border-radius:10px; text-align:center; }
.ref-stat .num { font-size:1.8em; font-weight:700; color:var(--primary); }
.ref-stat .label { font-size:0.85em; color:#666; }

</style>
</head>
<body>

<nav class="navbar">
<a href="/" class="nav-brand"><span class="star">&#10022;</span> DraftMyForms <span class="nav-badge">ADMIN</span></a>
<div class="nav-actions">
<a href="/dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
<a href="/editor.html"><i class="fas fa-edit"></i> Editor</a>
<a href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>
</nav>

<div class="container">
<div id="loadingState" class="loading-state">
<div><i class="fas fa-shield-alt" style="font-size:24px;color:var(--gold);margin-right:10px"></i> Verifying admin access...</div>
</div>

<div id="accessDenied" class="access-denied">
<i class="fas fa-lock" style="font-size:48px;color:var(--danger);margin-bottom:16px"></i>
<h2>Access Denied</h2>
<p>You do not have admin privileges to view this page.</p>
<a href="/dashboard.html" style="color:var(--gold);text-decoration:underline">Return to Dashboard</a>
</div>

<div id="adminContent" class="admin-content">
<div class="page-header">
<h1>&#9881; Admin Dashboard</h1>
<p>Platform overview and user management for DraftMyForms</p>
</div>

<div class="quick-actions">
<a href="/"><i class="fas fa-globe"></i> View Live Site</a>
<a href="/editor.html"><i class="fas fa-edit"></i> Open Editor</a>
<a href="/dashboard.html"><i class="fas fa-tachometer-alt"></i> User Dashboard</a>
<a href="https://supabase.com/dashboard" target="_blank"><i class="fas fa-database"></i> Supabase</a>
<a href="https://vercel.com" target="_blank"><i class="fas fa-server"></i> Vercel</a>
<a href="https://dashboard.stripe.com" target="_blank"><i class="fas fa-credit-card"></i> Stripe</a>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="value" id="statTotalUsers">-</div><div class="label">Total Users</div></div>
<div class="stat-card"><div class="value" id="statFreeUsers">-</div><div class="label">Free Plan</div></div>
<div class="stat-card"><div class="value" id="statProUsers">-</div><div class="label">Pro Plan</div></div>
<div class="stat-card"><div class="value" id="statBizUsers">-</div><div class="label">Business Plan</div></div>
<div class="stat-card"><div class="value" id="statEmailLeads">-</div><div class="label">Email Leads</div></div>
<div class="stat-card"><div class="value" id="statDocs">-</div><div class="label">Saved Documents</div></div>
</div>

<div class="section">
<div class="section-header">
<h2><i class="fas fa-users" style="color:var(--gold);margin-right:8px"></i> User Management</h2>
<span id="userCount" style="color:var(--text-muted);font-size:13px"></span>
</div>
<div class="search-bar">
<input type="text" id="userSearch" placeholder="Search by email or name..." oninput="filterUsers()">
</div>
<div class="section-body">
<table>
<thead><tr><th>Email</th><th>Display Name</th><th>Role</th><th>Plan</th><th>Referral Code</th><th>Actions</th></tr></thead>
<tbody id="usersTableBody"><tr><td colspan="5" class="empty-state">Loading users...</td></tr></tbody>
</table>
</div>
</div>

<div class="section">
<div class="section-header">
<h2><i class="fas fa-envelope" style="color:var(--gold);margin-right:8px"></i> Email Leads</h2>
<span id="leadCount" style="color:var(--text-muted);font-size:13px"></span>
</div>
<div class="section-body">
<table>
<thead><tr><th>Email</th><th>Source</th><th>Date</th></tr></thead>
<tbody id="leadsTableBody"><tr><td colspan="3" class="empty-state">Loading...</td></tr></tbody>
</table>
</div>
</div>

</div>
</div>



<!-- Banner Management -->
<div class="admin-section" style="background:#fff;border:1px solid #e8ddd4;border-radius:12px;padding:30px;margin:30px 0">
<h2 style="font-family:Playfair Display,serif;margin-bottom:5px">üì¢ Site Banner</h2>
<p style="color:#8a7f76;margin-bottom:20px">Control the global banner shown across all user pages</p>
<div id="bannerPreview" style="margin-bottom:16px;border-radius:8px;overflow:hidden"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Banner Message</label>
  <input type="text" id="bannerMsg" placeholder="e.g. Maintenance tonight at 11 PM EST" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Type</label>
  <select id="bannerType" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"><option value="info">Info (Gold)</option><option value="warning">Warning (Orange)</option><option value="success">Success (Green)</option><option value="error">Error (Red)</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Link URL (optional)</label>
  <input type="text" id="bannerLink" placeholder="https://..." style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Link Text</label>
  <input type="text" id="bannerLinkText" placeholder="Learn more" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
  <div style="display:flex;align-items:end;gap:8px">
    <label style="font-size:13px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="bannerDismissible" checked> Dismissible</label>
  </div>
</div>
<div style="display:flex;gap:10px">
  <button onclick="publishBanner()" style="background:#c99532;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600">Publish Banner</button>
  <button onclick="deactivateBanner()" style="background:#c24b3b;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600">Remove Banner</button>
</div>
</div>

<!-- Admin Messaging -->
<div class="admin-section" style="background:#fff;border:1px solid #e8ddd4;border-radius:12px;padding:30px;margin:30px 0">
<h2 style="font-family:Playfair Display,serif;margin-bottom:5px">‚úâÔ∏è Messages</h2>
<p style="color:#8a7f76;margin-bottom:20px">Send messages to individual users or broadcast to all</p>
<div style="background:var(--paper,#f9f4f3);border-radius:10px;padding:20px;margin-bottom:20px">
<h3 style="font-size:16px;margin-bottom:12px">Send New Message</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">To</label>
  <select id="msgRecipient" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"><option value="broadcast">üì£ Broadcast to All Users</option></select></div>
  <div><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Subject</label>
  <input type="text" id="msgSubject" placeholder="Message subject" style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px"></div>
</div>
<div style="margin-bottom:12px"><label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">Message Body</label>
<textarea id="msgBody" rows="4" placeholder="Write your message..." style="width:100%;padding:10px;border:1px solid #e8ddd4;border-radius:8px;font-size:14px;font-family:inherit;resize:vertical"></textarea></div>
<button onclick="sendAdminMessage()" style="background:#c99532;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600"><i class="fas fa-paper-plane"></i> Send Message</button>
</div>
<h3 style="font-size:16px;margin-bottom:12px">Recent Messages</h3>
<div id="adminMsgList" style="max-height:300px;overflow-y:auto"><p style="color:#8a7f76;text-align:center;padding:20px">Loading...</p></div>
</div>


<!-- Referrals Section -->
<section class="admin-card" id="referralsSection" style="margin:30px auto;max-width:1200px;padding:30px;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;"><span style="margin-right:8px;">&#x1F517;</span> Referral System</h2>
    <span id="referralCount" style="color:var(--primary);font-weight:600;"></span>
  </div>
  <div class="referral-stats" id="referralStats"></div>
  <div style="margin-top:15px;">
    <h4 style="margin:0 0 10px;">Recent Referrals</h4>
    <div id="referralsList" style="max-height:300px;overflow-y:auto;"></div>
  </div>
</section>

<footer>A product of <strong>WMK Speciality Services L.L.C.</strong></footer>

<script>
var SUPABASE_URL='https://mupeqeuuwdmkndvtbhzb.supabase.co';
var SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk';
var sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    var currentUser = null;
var allUsers=[];

async function init(){
try{
var{data:{session}}=await sb.auth.getSession();
if(!session){window.location.href='/';return}
var{data:profile}=await sb.from('profiles').select('role').eq('id',session.user.id).single();
if(!profile||profile.role!=='admin'){
document.getElementById('loadingState').style.display='none';
document.getElementById('accessDenied').style.display='block';
return;
}
    currentUser = session.user;
document.getElementById('loadingState').style.display='none';
document.getElementById('adminContent').style.display='block';
await loadStats();
await loadUsers();
await loadLeads();
    await loadReferrals();
    await checkExpiredTrials();
    if(typeof loadBannerAdmin === "function") await loadBannerAdmin();
    if(typeof loadUserListForMessaging === "function") loadUserListForMessaging();
    if(typeof loadAdminMessages === "function") await loadAdminMessages();
}catch(e){
console.error('Admin init error:',e);
document.getElementById('loadingState').innerHTML='<div style="color:var(--danger)">Error loading admin dashboard. <a href="/">Go home</a></div>';
}
}

async function loadStats(){
var{data:profiles}=await sb.from('profiles').select('plan');
var{data:leads}=await sb.from('email_leads').select('id');
var{data:docs}=await sb.from('saved_documents').select('id');
var total=profiles?profiles.length:0;
var free=profiles?profiles.filter(function(p){return p.plan==='free'||!p.plan}).length:0;
var pro=profiles?profiles.filter(function(p){return p.plan==='pro'}).length:0;
var biz=profiles?profiles.filter(function(p){return p.plan==='business'}).length:0;
document.getElementById('statTotalUsers').textContent=total;
document.getElementById('statFreeUsers').textContent=free;
document.getElementById('statProUsers').textContent=pro;
document.getElementById('statBizUsers').textContent=biz;
document.getElementById('statEmailLeads').textContent=leads?leads.length:0;
document.getElementById('statDocs').textContent=docs?docs.length:0;
}

async function loadUsers(){
  const {data,error}=await sb.from('profiles').select('id,email,display_name,role,plan,plan_override,plan_override_expires_at,plan_override_reason,referral_code,ai_credits_used,ai_credits_reset_at').order('created_at',{ascending:true});
  if(error){console.error(error);return;}
  window.__allUsers=data||[];
  document.getElementById('userCount').textContent=data?data.length+' users':'0 users';
  renderUsers(data||[]);
}

function renderUsers(users){
  const container=document.getElementById('userTableBody');
  if(!container){return;}
  if(!users||users.length===0){container.innerHTML='<tr><td colspan="6">No users found</td></tr>';return;}
  container.innerHTML=users.map(u=>{
    const planDisplay=u.plan_override||u.plan||'free';
    const isOverride=!!u.plan_override;
    const isTrial=!!u.plan_override_expires_at;
    let badge='';
    if(isTrial){
      const exp=new Date(u.plan_override_expires_at);
      const now=new Date();
      const daysLeft=Math.ceil((exp-now)/(1000*60*60*24));
      if(daysLeft>0){badge='<span class="plan-badge trial">Trial: '+daysLeft+'d left</span>';}
      else{badge='<span class="plan-badge expired">Trial expired</span>';}
    } else if(isOverride){
      badge='<span class="plan-badge override">Override</span>';
    }
    const isAdmin=u.role==='admin';
    return '<tr>'+
      '<td style="font-weight:500">'+escHtml(u.email||'')+'</td>'+
      '<td>'+(u.display_name?escHtml(u.display_name):'<span style="color:var(--text-muted)">Not set</span>')+'</td>'+
      '<td><span class="role-badge role-'+u.role+'">'+(u.role||'customer')+'</span></td>'+
      '<td>'+
        '<span style="font-weight:600;text-transform:capitalize">'+planDisplay+'</span>'+badge+
        (!isAdmin?' <button onclick="openPlanModal(\''+u.id+'\',\''+escHtml(u.email||'')+'\',\''+planDisplay+'\',\''+(u.plan_override_expires_at||'')+'\',\''+(u.plan_override_reason||'')+'\')" style="margin-left:8px;padding:2px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:0.8em;">Change</button>':'')+
      '</td>'+
      '<td>'+(u.referral_code?'<code style="background:#f0f0f0;padding:2px 6px;border-radius:4px;font-size:0.8em;">'+u.referral_code+'</code>':'<span style="color:#999">None</span>')+'</td>'+
      '<td>'+(!isAdmin?'<button class="action-btn" onclick="toggleRole(\''+u.id+'\',\''+u.role+'\')">Toggle Admin</button>':'')+'</td>'+
    '</tr>';
  }).join('');
}
function filterUsers(){
  const q=document.getElementById('userSearch')?.value?.toLowerCase()||'';
  if(!q){renderUsers(window.__allUsers||[]);return;}
  const filtered=(window.__allUsers||[]).filter(u=>(u.email||'').toLowerCase().includes(q)||(u.display_name||'').toLowerCase().includes(q));
  renderUsers(filtered);
}
function openPlanModal(userId,email,currentPlan,expiresAt,reason){
  document.getElementById('planModalUserId').value=userId;
  document.getElementById('planModalUserEmail').value=email;
  document.getElementById('planModalInfo').innerHTML='<strong>'+escHtml(email)+'</strong><br>Current plan: <strong>'+currentPlan+'</strong>'+(expiresAt?' (expires: '+new Date(expiresAt).toLocaleDateString()+')':'')+(reason?' &mdash; '+escHtml(reason):'');
  document.getElementById('planModalPlan').value=currentPlan.replace(/Trial.*/i,'').trim()||'free';
  document.getElementById('planModalDays').value='0';
  document.getElementById('planModalReason').value='';
  document.querySelectorAll('.trial-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.trial-btn')?.classList.add('active');
  document.getElementById('planModalNotify').checked=true;
  document.getElementById('planModalOverlay').classList.add('active');
}
function closePlanModal(){
  document.getElementById('planModalOverlay').classList.remove('active');
}
function setTrialDays(days){
  document.getElementById('planModalDays').value=days;
  document.querySelectorAll('.trial-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
}
async function confirmPlanChange(){
  const userId=document.getElementById('planModalUserId').value;
  const userEmail=document.getElementById('planModalUserEmail').value;
  const newPlan=document.getElementById('planModalPlan').value;
  const days=parseInt(document.getElementById('planModalDays').value)||0;
  const reason=document.getElementById('planModalReason').value;
  const notify=document.getElementById('planModalNotify').checked;
  const expiresAt=days>0?new Date(Date.now()+days*24*60*60*1000).toISOString():null;
  const updateData={
    plan: days>0?newPlan:newPlan,
    plan_override: days>0?newPlan:null,
    plan_override_expires_at: expiresAt,
    plan_override_reason: reason||null,
    plan_changed_by: currentUser.id,
    plan_changed_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };
  const {error}=await sb.from('profiles').update(updateData).eq('id',userId);
  if(error){alert('Error changing plan: '+error.message);return;}
  await sb.from('plan_change_log').insert({user_id:userId,old_plan:null,new_plan:newPlan,override_type:days>0?days+' day trial':'permanent',override_expires_at:expiresAt,reason:reason,changed_by:currentUser.id});
  if(notify){
    const durText=days>0?days+' day trial':'permanent';
    const msgBody='Your plan has been updated to '+newPlan.toUpperCase()+(days>0?' for '+days+' days':'')+'. '+(reason?'Reason: '+reason:'')+'\n\nIf you have questions, reply to this message.';
    await sb.from('messages').insert({sender_id:currentUser.id,recipient_id:userId,subject:'Plan Updated to '+newPlan.charAt(0).toUpperCase()+newPlan.slice(1),body:msgBody,is_broadcast:false,is_read:false});
  }
  closePlanModal();
  alert('Plan updated successfully!'+(notify?' User has been notified via inbox.':''));
  loadUsers();
}
async function changePlan(selectEl,userId){
  openPlanModal(userId,'','',selectEl.value,'','');
}

async function toggleRole(userId,currentRole){
var newRole=currentRole==='admin'?'customer':'admin';
if(newRole==='admin'&&!confirm('Grant admin access to this user?'))return;
var{error}=await sb.from('profiles').update({role:newRole}).eq('id',userId);
if(error){alert('Error updating role: '+error.message);return}
await loadUsers();
}

async function loadLeads(){
var{data:leads,error}=await sb.from('email_leads').select('*').order('created_at',{ascending:false});
var tbody=document.getElementById('leadsTableBody');
if(error||!leads){tbody.innerHTML='<tr><td colspan="3" class="empty-state">Error loading leads</td></tr>';return}
document.getElementById('leadCount').textContent=leads.length+' leads';
if(!leads.length){tbody.innerHTML='<tr><td colspan="3" class="empty-state">No email leads yet</td></tr>';return}
var html='';
leads.forEach(function(l){
var d=l.created_at?new Date(l.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'Unknown';
html+='<tr><td>'+escHtml(l.email)+'</td><td>'+(l.source||'N/A')+'</td><td>'+d+'</td></tr>';
});
tbody.innerHTML=html;
}

function escHtml(str){
if(!str)return '';
var d=document.createElement('div');
d.textContent=str;
return d.innerHTML;
}

function handleLogout(){
sb.auth.signOut().then(function(){window.location.href='/'});
}

init();


// === Phase 5: Banner Management ===
async function loadBannerAdmin() {
  const { data } = await sb.from("site_banners").select("*").order("created_at", { ascending: false }).limit(1);
  const preview = document.getElementById("bannerPreview");
  if (data && data.length && data[0].is_active) {
    const b = data[0];
    const colors = { info: "#c99532", warning: "#e67e22", success: "#3a6633", error: "#c24b3b" };
    preview.innerHTML = '<div style="background:' + (b.bg_color || colors[b.type] || "#c99532") + ';color:' + (b.text_color || "#fff") + ';padding:12px 20px;border-radius:8px;font-size:14px"><strong>LIVE:</strong> ' + b.message + '</div>';
    document.getElementById("bannerMsg").value = b.message || "";
    document.getElementById("bannerType").value = b.type || "info";
    document.getElementById("bannerLink").value = b.link_url || "";
    document.getElementById("bannerLinkText").value = b.link_text || "";
    document.getElementById("bannerDismissible").checked = b.is_dismissible !== false;
  } else {
    preview.innerHTML = '<div style="background:#f0f0f0;padding:12px 20px;border-radius:8px;font-size:14px;color:#888;text-align:center">No active banner</div>';
  }
}

async function publishBanner() {
  const msg = document.getElementById("bannerMsg").value.trim();
  if (!msg) { alert("Enter a banner message"); return; }
  const type = document.getElementById("bannerType").value;
  const colors = { info: "#c99532", warning: "#e67e22", success: "#3a6633", error: "#c24b3b" };
  await sb.from("site_banners").update({ is_active: false }).eq("is_active", true);
  const { error } = await sb.from("site_banners").insert({ message: msg, type: type, bg_color: colors[type], text_color: "#ffffff", link_url: document.getElementById("bannerLink").value || null, link_text: document.getElementById("bannerLinkText").value || null, is_dismissible: document.getElementById("bannerDismissible").checked, is_active: true, created_by: currentUser.id });
  if (error) { alert("Error: " + error.message); return; }
  alert("Banner published!");
  loadBannerAdmin();
}

async function deactivateBanner() {
  await sb.from("site_banners").update({ is_active: false }).eq("is_active", true);
  alert("Banner removed!");
  loadBannerAdmin();
}

// === Phase 5: Admin Messaging ===
async function loadUserListForMessaging() {
  const { data } = await sb.from("profiles").select("id, email, display_name").order("email");
  const select = document.getElementById("msgRecipient");
  if (data) {
    data.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = (u.display_name || "No name") + " (" + u.email + ")";
      select.appendChild(opt);
    });
  }
}

async function sendAdminMessage() {
  const recipient = document.getElementById("msgRecipient").value;
  const subject = document.getElementById("msgSubject").value.trim();
  const body = document.getElementById("msgBody").value.trim();
  if (!subject || !body) { alert("Subject and body required"); return; }
  if (recipient === "broadcast") {
    const { data: users } = await sb.from("profiles").select("id");
    if (users) {
      const msgs = users.map(u => ({ sender_id: currentUser.id, recipient_id: u.id, subject, body, is_broadcast: true }));
      const { error } = await sb.from("messages").insert(msgs);
      if (error) { alert("Error: " + error.message); return; }
      alert("Broadcast sent to " + users.length + " users!");
    }
  } else {
    const { error } = await sb.from("messages").insert({ sender_id: currentUser.id, recipient_id: recipient, subject, body });
    if (error) { alert("Error: " + error.message); return; }
    alert("Message sent!");
  }
  document.getElementById("msgSubject").value = "";
  document.getElementById("msgBody").value = "";
  loadAdminMessages();
}

  async function loadAdminMessages() {
    const { data } = await sb.from('messages').select('*').eq('sender_id', currentUser.id).order('created_at', { ascending: false }).limit(20);
    const el = document.getElementById('adminMsgList');
    if (!data || !data.length) { el.innerHTML = '<p style="color:#8a7f76;text-align:center;padding:16px">No messages sent yet</p>'; return; }
    var recipientIds = [...new Set(data.filter(function(m){ return m.recipient_id; }).map(function(m){ return m.recipient_id; }))];
    var profileMap = {};
    if (recipientIds.length > 0) {
      var pResult = await sb.from('profiles').select('id,email,display_name').in('id', recipientIds);
      if (pResult.data) { pResult.data.forEach(function(p){ profileMap[p.id] = p.display_name || p.email || 'Unknown'; }); }
    }
    el.innerHTML = data.map(function(m) {
      var date = new Date(m.created_at).toLocaleDateString();
      var toLabel = m.is_broadcast ? '<span style="background:#c99532;color:#fff;font-size:11px;padding:2px 8px;border-radius:10px">Broadcast</span>' : '<span style="color:#8a7f76;font-size:12px">To: ' + (profileMap[m.recipient_id] || 'Unknown user') + '</span>';
      return '<div style="padding:10px 0;border-bottom:1px solid #e8ddd4;font-size:14px"><strong>' + m.subject + '</strong> ' + toLabel + '<div style="color:#8a7f76;margin-top:4px;font-size:12px">' + date + ' \u2013 ' + (m.body || '').substring(0, 80) + (m.body && m.body.length > 80 ? '...' : '') + '</div></div>';
    }).join('');
  }

// Call these after admin loads
setTimeout(function() { if (typeof loadBannerAdmin === "function") { loadBannerAdmin(); loadUserListForMessaging(); loadAdminMessages(); } }, 1000);


// Referral System Functions
async function loadReferrals() {
  const statsEl = document.getElementById('referralStats');
  const listEl = document.getElementById('referralsList');
  const countEl = document.getElementById('referralCount');
  if (!statsEl) return;
  
  const {data: referrals, error} = await sb.from('referrals').select('*').order('created_at', {ascending: false}).limit(50);
  if (error) { console.error(error); return; }
  
  const total = referrals ? referrals.length : 0;
  const completed = referrals ? referrals.filter(r => r.status === 'completed' || r.status === 'rewarded').length : 0;
  const pending = referrals ? referrals.filter(r => r.status === 'pending').length : 0;
  
  countEl.textContent = total + ' referrals';
  statsEl.innerHTML = '<div class="ref-stat"><div class="num">' + total + '</div><div class="label">Total Referrals</div></div>' +
    '<div class="ref-stat"><div class="num">' + completed + '</div><div class="label">Completed</div></div>' +
    '<div class="ref-stat"><div class="num">' + pending + '</div><div class="label">Pending</div></div>';
  
  if (!referrals || referrals.length === 0) {
    listEl.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No referrals yet</p>';
    return;
  }
  
  const userIds = [...new Set(referrals.map(r => r.referrer_id).concat(referrals.map(r => r.referred_id)))];
  const {data: profiles} = await sb.from('profiles').select('id,email').in('id', userIds);
  const emailMap = {};
  (profiles || []).forEach(p => { emailMap[p.id] = p.email; });
  
  listEl.innerHTML = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f8f9fa;"><th style="padding:8px;text-align:left;">Referrer</th><th style="padding:8px;text-align:left;">Referred</th><th style="padding:8px;text-align:left;">Code</th><th style="padding:8px;text-align:left;">Status</th><th style="padding:8px;text-align:left;">Date</th></tr></thead><tbody>' +
    referrals.map(r => '<tr style="border-bottom:1px solid #eee;"><td style="padding:8px;">' + escHtml(emailMap[r.referrer_id] || 'Unknown') + '</td><td style="padding:8px;">' + escHtml(emailMap[r.referred_id] || 'Unknown') + '</td><td style="padding:8px;"><code>' + escHtml(r.referral_code || '') + '</code></td><td style="padding:8px;"><span style="padding:2px 8px;border-radius:10px;font-size:0.8em;background:' + (r.status === 'completed' || r.status === 'rewarded' ? '#d4edda' : r.status === 'pending' ? '#fff3cd' : '#f8d7da') + ';">' + (r.status || 'pending') + '</span></td><td style="padding:8px;">' + new Date(r.created_at).toLocaleDateString() + '</td></tr>').join('') +
    '</tbody></table>';
}

// Check and expire overdue trials
async function checkExpiredTrials() {
  const {data, error} = await sb.from('profiles').select('id,email,plan,plan_override,plan_override_expires_at').not('plan_override_expires_at', 'is', null);
  if (error || !data) return;
  const now = new Date();
  for (const user of data) {
    if (user.plan_override_expires_at && new Date(user.plan_override_expires_at) < now) {
      await sb.from('profiles').update({
        plan: 'free',
        plan_override: null,
        plan_override_expires_at: null,
        plan_override_reason: null,
        updated_at: new Date().toISOString()
      }).eq('id', user.id);
      await sb.from('plan_change_log').insert({
        user_id: user.id,
        old_plan: user.plan_override || user.plan,
        new_plan: 'free',
        override_type: 'trial_expired',
        reason: 'Trial period ended automatically',
        changed_by: currentUser.id
      });
    }
  }
}

</script>

<!-- Plan Change Modal -->
<div class="plan-modal-overlay" id="planModalOverlay">
  <div class="plan-modal">
    <h3>&#x2699;&#xFE0F; Change User Plan</h3>
    <div class="current-info" id="planModalInfo"></div>
    <input type="hidden" id="planModalUserId">
    <input type="hidden" id="planModalUserEmail">
    <label>New Plan</label>
    <select id="planModalPlan">
      <option value="free">Free</option>
      <option value="pro">Pro</option>
      <option value="business">Business</option>
    </select>
    <label>Override Duration (optional trial)</label>
    <div class="trial-options">
      <span class="trial-btn" onclick="setTrialDays(0)">Permanent</span>
      <span class="trial-btn" onclick="setTrialDays(7)">7 Days</span>
      <span class="trial-btn" onclick="setTrialDays(15)">15 Days</span>
      <span class="trial-btn" onclick="setTrialDays(30)">30 Days</span>
      <span class="trial-btn" onclick="setTrialDays(60)">60 Days</span>
      <span class="trial-btn" onclick="setTrialDays(90)">90 Days</span>
    </div>
    <input type="hidden" id="planModalDays" value="0">
    <label>Reason (optional)</label>
    <input type="text" id="planModalReason" placeholder="e.g. Beta tester, loyalty reward...">
    <div class="notify-check">
      <input type="checkbox" id="planModalNotify" checked>
      <span>Notify user via inbox message</span>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closePlanModal()">Cancel</button>
      <button class="btn-confirm" onclick="confirmPlanChange()">Confirm Change</button>
    </div>
  </div>
</div>

</body>
</html>
