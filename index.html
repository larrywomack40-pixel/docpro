<!DOCTYPE html>
<!-- v2 -->
<html lang="en">
<head>
<meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%232563eb'/%3E%3Ctext x='50' y='68' font-size='52' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'%3EDF%3C/text%3E%3C/svg%3E">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DraftMyForms - Free Document Generator | Invoices, Contracts, Legal Forms</title>
<meta name="description" content="Generate professional documents instantly. 10,000+ templates for invoices, contracts, legal forms, pay stubs, and more. Download as PDF free.">
<meta name="keywords" content="free invoice template, contract template, legal forms, pay stub generator, document generator, fillable PDF">
<meta property="og:title" content="DraftMyForms - Free Document Generator">
<meta property="og:description" content="10,000+ professional document templates. Create invoices, contracts, legal forms instantly.">
<meta property="og:type" content="website">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">
    <meta property="og:url" content="https://draftmyforms.com/">
    <meta property="og:image" content="https://draftmyforms.com/og-image.png">
    <meta property="og:site_name" content="DraftMyForms">
    <meta property="og:locale" content="en_US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="DraftMyForms - Free Document Generator">
    <meta name="twitter:description" content="Generate professional documents instantly. 10,000+ templates.">
    <meta name="author" content="Wmk Speciality Services L.L.C.">
<link rel="canonical" href="https://draftmyforms.com/">
    <meta name="google-site-verification" content="KBCx2c_AORe0Cw3cP2vDBCpMBlomwWaxvXUSpqQg8DM" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://js.stripe.com/v3/"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
footer{position:fixed!important;bottom:0;left:var(--sidebar-w);right:0;text-align:center;padding:6px 12px;font-size:11px;z-index:10;margin:0!important}
@media(max-width:768px){footer{left:0}}
:root{--pri:#2563eb;--pri-d:#1d4ed8;--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--success:#22c55e;--warn:#f59e0b;--danger:#ef4444;--sidebar-w:320px;--doc-bg:#fff;--doc-text:#1e293b;--hover-bg:#f1f5f9}
[data-theme="dark"]{--bg:#0f172a;--card:#1e293b;--text:#e2e8f0;--muted:#94a3b8;--border:#334155;--doc-bg:#1e293b;--doc-text:#e2e8f0;--hover-bg:#334155}
[data-theme="dark"] #docPreview{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
[data-theme="dark"] .welcome{background:linear-gradient(135deg,#1e293b 0%,#0f172a 50%,#1e1b4b 100%)!important;border-color:var(--border)!important}
[data-theme="dark"] .welcome .categories span{background:var(--card);border-color:var(--border);color:var(--muted)}
[data-theme="dark"] .modal{background:var(--card);color:var(--text)}
[data-theme="dark"] .modal input{background:var(--bg);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .price-card{background:var(--card);border-color:var(--border);color:var(--text)}
[data-theme="dark"] .price-card ul{color:var(--muted)}
[data-theme="dark"] .search-box{background:var(--bg);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .cat-btn{background:var(--card);border-color:var(--border);color:var(--muted)}
[data-theme="dark"] .tier-btn{background:var(--card);border-color:var(--border);color:var(--muted)}
[data-theme="dark"] .sort-select{background:var(--card);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .toolbar select{background:var(--card);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .seo-context{background:var(--bg);border-color:var(--border)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}
.sidebar{width:var(--sidebar-w);background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow:hidden}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-size:20px;color:var(--pri);display:flex;align-items:center;gap:8px}
.sidebar-header h1 span{font-size:10px;background:var(--pri);color:#fff;padding:2px 6px;border-radius:4px;font-weight:400}
.sidebar-header p{font-size:11px;color:var(--muted);margin-top:2px}
.search-box{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;margin-top:8px}
.search-box:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.sidebar-content{flex:1;overflow-y:auto;padding:8px}
.cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:8px}
.cat-btn{padding:6px 4px;font-size:10px;text-align:center;border:1px solid var(--border);border-radius:4px;cursor:pointer;background:var(--card);transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cat-btn:hover{border-color:var(--pri);color:var(--pri)}
.cat-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.filter-row{display:flex;gap:4px;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.tier-btn{padding:3px 10px;font-size:11px;border-radius:12px;cursor:pointer;border:1px solid var(--border);background:var(--card);transition:.2s}
.tier-btn:hover,.tier-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.sort-select{padding:3px 6px;font-size:11px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer}
.doc-list{list-style:none}
.doc-item{padding:8px 12px;cursor:pointer;border-radius:6px;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:.15s}
.doc-item:hover{background:var(--hover-bg)}
.doc-item.active{background:#eff6ff;color:var(--pri);font-weight:600}
[data-theme="dark"] .doc-item.active{background:#1e3a5f}
.doc-tier{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;text-transform:capitalize}
.doc-tier.free{background:#dcfce7;color:#16a34a}
.doc-tier.pro{background:#fef3c7;color:#d97706}
.doc-tier.business{background:#fee2e2;color:#dc2626}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:10px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--card)}
.main-header h2{font-size:17px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.header-actions{display:flex;gap:6px;align-items:center}
.btn{padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;border:1px solid var(--border);background:var(--card);color:var(--text);transition:.2s;white-space:nowrap}
.btn:hover{border-color:var(--pri)}
.btn-pri{background:var(--pri);color:#fff;border-color:var(--pri)}
.btn-pri:hover{background:var(--pri-d)}
.btn-sm{padding:4px 10px;font-size:11px}
.btn-ghost{border:none;background:none;color:var(--muted);padding:4px 8px}
.btn-ghost:hover{color:var(--pri)}
.badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;margin-left:8px}
.badge-free{background:#dcfce7;color:#16a34a}
.badge-pro{background:#fef3c7;color:#d97706}
.badge-biz{background:#dbeafe;color:#2563eb}
.main-content{flex:1;overflow-y:auto;padding:24px;display:flex;gap:24px}
.form-panel{width:45%;max-width:460px}
.form-panel h3{font-size:14px;color:var(--pri);margin-bottom:10px}
.form-row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.form-row label{font-size:11px;color:var(--muted);display:block;margin-bottom:2px}
.form-row input,.form-row textarea,.form-row select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:12px;background:var(--card);color:var(--text)}
.form-row textarea{min-height:60px;resize:vertical}
.form-field{flex:1;min-width:120px}
.preview-panel{flex:1;min-width:300px}
#docPreview{background:#fff;border:1px solid var(--border);border-radius:8px;padding:40px;min-height:500px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.toolbar{display:flex;gap:6px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
.toolbar select{padding:5px 8px;border-radius:4px;border:1px solid var(--border);font-size:11px;cursor:pointer;background:var(--card)}
.toolbar-secondary{display:flex;gap:4px;margin-left:auto;align-items:center}
/* Welcome */
.welcome{text-align:center;padding:80px 40px;background:linear-gradient(135deg,#f0f4ff 0%,#e8f0fe 50%,#f5f3ff 100%);border-radius:12px;border:1px solid var(--border)}
.welcome h2{font-size:26px;color:var(--text);font-weight:700;margin-bottom:8px}
.welcome p{color:var(--muted);font-size:14px;margin-bottom:6px}
.welcome .stat{font-size:36px;font-weight:800;color:var(--pri);margin:16px 0 4px}
.welcome .categories{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-top:16px}
.welcome .categories span{background:#fff;border:1px solid var(--border);padding:4px 12px;border-radius:20px;font-size:11px;color:var(--muted)}
.welcome .cta-row{margin-top:24px;display:flex;gap:12px;justify-content:center}
/* Theme toggle */
.theme-toggle{display:flex;align-items:center;gap:2px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:2px;margin-right:4px}
.theme-toggle button{width:28px;height:28px;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;background:transparent;transition:.2s;color:var(--muted)}
.theme-toggle button.active{background:var(--pri);color:#fff}
.theme-toggle button:hover:not(.active){background:var(--hover-bg)}
/* Modal */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:12px;padding:32px;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;position:relative}
.modal h2{margin-bottom:16px;font-size:20px}
.modal-close{position:absolute;top:12px;right:16px;background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);line-height:1}
.modal input[type="text"],.modal input[type="email"],.modal input[type="password"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;font-size:14px;background:var(--bg);color:var(--text)}
.modal .btn{width:100%;padding:12px;font-size:14px;margin-top:8px}
.tab-btns{display:flex;gap:0;margin-bottom:16px}
.tab-btns button{flex:1;padding:10px;border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:13px;transition:.2s;color:var(--text)}
.tab-btns button.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.pricing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.price-card{border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
.price-card:hover,.price-card.popular{border-color:var(--pri)}
.price-card .price{font-size:28px;font-weight:800;color:var(--pri);margin:8px 0}
.price-card .price span{font-size:14px;color:var(--muted)}
.price-card ul{list-style:none;text-align:left;margin:12px 0;font-size:12px}
.price-card li{padding:4px 0;border-bottom:1px solid var(--bg)}
.price-card li::before{content:"\2713 ";color:var(--success)}
.logo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.logo-grid img{width:100%;height:80px;object-fit:contain;border:1px solid var(--border);border-radius:4px;cursor:pointer;padding:4px}
.logo-grid img:hover{border-color:var(--pri)}
.avatar{width:32px;height:32px;border-radius:50%;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;cursor:pointer}
.user-menu{position:relative}
.user-dropdown{position:absolute;top:40px;right:0;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;min-width:200px;display:none;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.user-dropdown.show{display:block}
.user-dropdown a{display:block;padding:8px 12px;font-size:13px;color:var(--text);text-decoration:none;border-radius:4px}
.user-dropdown a:hover{background:var(--hover-bg)}
.user-dropdown .divider{border-top:1px solid var(--border);margin:4px 0}
.load-more-btn{width:100%;padding:8px;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;color:var(--muted)}
.load-more-btn:hover{border-color:var(--pri);color:var(--pri)}
.doc-count{font-size:11px;color:var(--muted);padding:4px 12px}
/* Email capture banner */
.email-banner{background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;padding:12px 16px;border-radius:8px;margin:8px 0;text-align:center}
.email-banner h4{font-size:13px;margin-bottom:4px}
.email-banner p{font-size:11px;opacity:.85;margin-bottom:8px}
.email-banner form{display:flex;gap:4px}
.email-banner input{flex:1;padding:6px 10px;border:none;border-radius:4px;font-size:12px}
.email-banner button{padding:6px 12px;border:none;border-radius:4px;background:#fff;color:var(--pri);font-weight:700;font-size:12px;cursor:pointer}
/* SEO landing page */
.seo-context{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px 20px;margin-top:16px;font-size:13px;line-height:1.7;color:var(--muted)}
.seo-context h4{color:var(--text);font-size:14px;margin-bottom:6px}
/* Saved docs */
.saved-docs-list{margin-top:8px}
.saved-doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:6px;margin-bottom:6px;font-size:12px;background:var(--card);cursor:pointer;transition:.15s}
.saved-doc-item:hover{border-color:var(--pri)}
.saved-doc-item .saved-meta{color:var(--muted);font-size:10px}
.saved-doc-item .delete-saved{color:var(--danger);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px}
.saved-doc-item .delete-saved:hover{background:#fee2e2}
.save-indicator{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--success);margin-left:8px;opacity:0;transition:opacity .3s}
.save-indicator.show{opacity:1}
@media print{.sidebar,.main-header,.toolbar,.form-panel,.modal-overlay,.email-banner,.seo-context{display:none!important}.main-content{padding:0!important}#docPreview{border:none!important;box-shadow:none!important;padding:20px!important}}
</style>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"DraftMyForms","url":"https://draftmyforms.com","description":"Generate professional documents instantly. 10,000+ templates for invoices, contracts, legal forms, pay stubs and more.","applicationCategory":"BusinessApplication","operatingSystem":"Web","offers":{"@type":"AggregateOffer","lowPrice":"0","highPrice":"24.99","priceCurrency":"USD"},"creator":{"@type":"Organization","name":"Wmk Speciality Services L.L.C."}}</script>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
<div class="sidebar-header">
<h1>DraftMyForms <span>11.3K+</span></h1>
<p>Free Professional Document Generator</p>
<input class="search-box" id="searchBox" placeholder="Search invoices, contracts, forms..." oninput="filterDocs()">
</div>
<div class="sidebar-content">
<div class="cat-grid" id="catGrid"></div>
<div class="filter-row">
<span class="tier-btn active" onclick="setTier('all')">All</span>
<span class="tier-btn" onclick="setTier('free')">Free</span>
<span class="tier-btn" onclick="setTier('pro')">Pro</span>
<span class="tier-btn" onclick="setTier('business')">Biz</span>
<select class="sort-select" id="sortSelect" onchange="renderDocList()">
<option value="popular">Popular</option>
<option value="alpha">A-Z</option>
<option value="free-first">Free First</option>
<option value="newest">Newest</option>
</select>
</div>
<div class="doc-count" id="docCount"></div>
<ul class="doc-list" id="docList"></ul>
<button class="load-more-btn" id="loadMoreBtn" style="display:none" onclick="loadMoreDocs()">Load More Templates</button>
<div class="email-banner" id="emailBanner">
<h4>Unlock 3 Free Pro Templates</h4>
<p>Enter your email to get instant access</p>
<form onsubmit="captureEmail(event)">
<input type="email" id="captureEmailInput" placeholder="you@email.com" required>
<button type="submit">Get Free</button>
</form>
</div>
</div>
</div>
<!-- Main -->
<div class="main">
<div class="main-header">
<div style="display:flex;align-items:center">
<h2 id="docTitle">Select a Document</h2>
<span class="badge badge-free" id="planBadge">FREE PLAN</span>
<span class="save-indicator" id="saveIndicator">✓ Saved</span>
</div>
<div class="header-actions">
<div class="theme-toggle" id="themeToggle">
<button onclick="setColorTheme('light')" title="Light" id="themeLight">☀</button>
<button onclick="setColorTheme('dark')" title="Dark" id="themeDark">☾</button>
<button onclick="setColorTheme('system')" title="System" id="themeSystem" class="active">⚙</button>
</div>
<button class="btn-ghost btn-sm" onclick="openLogo()" title="Add Logo">Logo</button>
<button class="btn-ghost btn-sm" onclick="openUpload()" title="Upload Document">Upload</button>
<button class="btn btn-sm" onclick="openPricing()">Upgrade</button>
<div class="user-menu" id="userMenu">
<button class="btn btn-sm" id="authBtn" onclick="openAuth()">Sign In</button>
</div>
</div>
</div>
<div class="main-content" id="mainContent">
<div class="form-panel" id="formPanel" style="display:none">
<div class="toolbar">
<select id="themeSelect" onchange="applyTheme()">
<option value="modern">Modern</option>
<option value="classic">Classic</option>
<option value="elegant">Elegant</option>
<option value="corporate">Corporate</option>
<option value="minimal">Minimal</option>
<option value="bold">Bold</option>
</select>
<button class="btn btn-pri" onclick="generatePDF()">Download PDF</button>
<button class="btn btn-sm" onclick="saveDocument()" id="saveDocBtn" style="display:none">Save</button>
<div class="toolbar-secondary">
<button class="btn-ghost btn-sm" onclick="printDoc()">Print</button>
<button class="btn-ghost btn-sm" onclick="resetForm()">Reset</button>
</div>
</div>
<div id="formFields"></div>
<div class="seo-context" id="seoContext"></div>
</div>
<div class="preview-panel">
<div id="docPreview">
<div class="welcome">
<h2>Create Professional Documents in Seconds</h2>
<p>No sign-up required for free templates</p>
<div class="stat" id="templateCount">10,000+</div>
<p>templates ready to customize and download</p>
<div class="categories" id="welcomeCats"></div>
<div class="cta-row">
<button class="btn btn-pri" onclick="document.getElementById('searchBox').focus()">Browse Templates</button>
<button class="btn" onclick="setTier('free')">View Free Templates</button>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Modals -->
<div class="modal-overlay" id="authModal">
<div class="modal">
<button class="modal-close" onclick="closeModal('authModal')">&times;</button>
<h2 id="authTitle">Sign In</h2>
<div class="tab-btns"><button class="active" onclick="switchAuthTab('login')">Login</button><button onclick="switchAuthTab('register')">Register</button></div>
<div id="loginForm"><input type="email" id="loginEmail" placeholder="Email"><input type="password" id="loginPass" placeholder="Password"><button class="btn btn-pri" onclick="doLogin()">Sign In</button></div>
<div id="registerForm" style="display:none"><input type="text" id="regName" placeholder="Full Name"><input type="email" id="regEmail" placeholder="Email"><input type="password" id="regPass" placeholder="Password (min 6 chars)"><button class="btn btn-pri" onclick="doRegister()">Create Account</button></div>
<p id="authMsg" style="margin-top:8px;font-size:12px;color:var(--danger)"></p>
</div>
</div>
<div class="modal-overlay" id="pricingModal">
<div class="modal" style="max-width:700px">
<button class="modal-close" onclick="closeModal('pricingModal')">&times;</button>
<h2>Choose Your Plan</h2>
<p style="color:var(--muted);margin-bottom:16px">Unlock premium templates and features</p>
<div class="pricing-grid">
<div class="price-card" onclick="selectPlan('free')"><h3>Free</h3><div class="price">$0<span>/mo</span></div><ul><li>Basic templates</li><li>Invoices & receipts</li><li>Letters & memos</li><li>PDF download</li><li>6 themes</li></ul><button class="btn" style="width:100%">Current Plan</button></div>
<div class="price-card popular" onclick="selectPlan('pro')"><h3>Pro</h3><div class="price">$9.99<span>/mo</span></div><ul><li>All Free templates</li><li>Contracts & agreements</li><li>Tax & financial</li><li>Real estate</li><li>Priority support</li></ul><button class="btn btn-pri" style="width:100%">Upgrade to Pro</button></div>
<div class="price-card" onclick="selectPlan('business')"><h3>Business</h3><div class="price">$24.99<span>/mo</span></div><ul><li>All Pro templates</li><li>Legal & government</li><li>Healthcare & medical</li><li>Insurance & claims</li><li>Custom branding</li></ul><button class="btn btn-pri" style="width:100%">Go Business</button></div>
</div>
</div>
</div>
<div class="modal-overlay" id="logoModal">
<div class="modal">
<button class="modal-close" onclick="closeModal('logoModal')">&times;</button>
<h2>Logo Studio</h2>
<input type="text" id="logoSearch" placeholder="Search company logos..." oninput="searchLogos(<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DraftMyForms - Free Document Generator | Invoices, Contracts, Legal Forms</title>
<meta name="description" content="Generate professional documents instantly. 10,000+ templates for invoices, contracts, legal forms, pay stubs, and more. Download as PDF free.">
<meta name="keywords" content="free invoice template, contract template, legal forms, pay stub generator, document generator, fillable PDF">
<meta property="og:title" content="DraftMyForms - Free Document Generator">
<meta property="og:description" content="10,000+ professional document templates. Create invoices, contracts, legal forms instantly.">
<meta property="og:type" content="website">
<link rel="canonical" href="https://draftmyforms.com/">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--pri:#2563eb;--pri-d:#1d4ed8;--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--success:#22c55e;--warn:#f59e0b;--danger:#ef4444;--sidebar-w:320px;--doc-bg:#fff;--doc-text:#1e293b;--hover-bg:#f1f5f9}
[data-theme="dark"]{--bg:#0f172a;--card:#1e293b;--text:#e2e8f0;--muted:#94a3b8;--border:#334155;--doc-bg:#1e293b;--doc-text:#e2e8f0;--hover-bg:#334155}
[data-theme="dark"] #docPreview{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
[data-theme="dark"] .welcome{background:linear-gradient(135deg,#1e293b 0%,#0f172a 50%,#1e1b4b 100%)!important;border-color:var(--border)!important}
[data-theme="dark"] .welcome .categories span{background:var(--card);border-color:var(--border);color:var(--muted)}
[data-theme="dark"] .modal{background:var(--card);color:var(--text)}
[data-theme="dark"] .modal input{background:var(--bg);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .price-card{background:var(--card);border-color:var(--border);color:var(--text)}
[data-theme="dark"] .price-card ul{color:var(--muted)}
[data-theme="dark"] .search-box{background:var(--bg);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .cat-btn{background:var(--card);border-color:var(--border);color:var(--muted)}
[data-theme="dark"] .tier-btn{background:var(--card);border-color:var(--border);color:var(--muted)}
[data-theme="dark"] .sort-select{background:var(--card);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .toolbar select{background:var(--card);color:var(--text);border-color:var(--border)}
[data-theme="dark"] .seo-context{background:var(--bg);border-color:var(--border)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}
.sidebar{width:var(--sidebar-w);background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow:hidden}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-size:20px;color:var(--pri);display:flex;align-items:center;gap:8px}
.sidebar-header h1 span{font-size:10px;background:var(--pri);color:#fff;padding:2px 6px;border-radius:4px;font-weight:400}
.sidebar-header p{font-size:11px;color:var(--muted);margin-top:2px}
.search-box{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;margin-top:8px}
.search-box:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.sidebar-content{flex:1;overflow-y:auto;padding:8px}
.cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:8px}
.cat-btn{padding:6px 4px;font-size:10px;text-align:center;border:1px solid var(--border);border-radius:4px;cursor:pointer;background:var(--card);transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cat-btn:hover{border-color:var(--pri);color:var(--pri)}
.cat-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.filter-row{display:flex;gap:4px;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.tier-btn{padding:3px 10px;font-size:11px;border-radius:12px;cursor:pointer;border:1px solid var(--border);background:var(--card);transition:.2s}
.tier-btn:hover,.tier-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.sort-select{padding:3px 6px;font-size:11px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer}
.doc-list{list-style:none}
.doc-item{padding:8px 12px;cursor:pointer;border-radius:6px;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:.15s}
.doc-item:hover{background:var(--hover-bg)}
.doc-item.active{background:#eff6ff;color:var(--pri);font-weight:600}
[data-theme="dark"] .doc-item.active{background:#1e3a5f}
.doc-tier{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;text-transform:capitalize}
.doc-tier.free{background:#dcfce7;color:#16a34a}
.doc-tier.pro{background:#fef3c7;color:#d97706}
.doc-tier.business{background:#fee2e2;color:#dc2626}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:10px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--card)}
.main-header h2{font-size:17px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.header-actions{display:flex;gap:6px;align-items:center}
.btn{padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;border:1px solid var(--border);background:var(--card);color:var(--text);transition:.2s;white-space:nowrap}
.btn:hover{border-color:var(--pri)}
.btn-pri{background:var(--pri);color:#fff;border-color:var(--pri)}
.btn-pri:hover{background:var(--pri-d)}
.btn-sm{padding:4px 10px;font-size:11px}
.btn-ghost{border:none;background:none;color:var(--muted);padding:4px 8px}
.btn-ghost:hover{color:var(--pri)}
.badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;margin-left:8px}
.badge-free{background:#dcfce7;color:#16a34a}
.badge-pro{background:#fef3c7;color:#d97706}
.badge-biz{background:#dbeafe;color:#2563eb}
.main-content{flex:1;overflow-y:auto;padding:24px;display:flex;gap:24px}
.form-panel{width:45%;max-width:460px}
.form-panel h3{font-size:14px;color:var(--pri);margin-bottom:10px}
.form-row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.form-row label{font-size:11px;color:var(--muted);display:block;margin-bottom:2px}
.form-row input,.form-row textarea,.form-row select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:12px;background:var(--card);color:var(--text)}
.form-row textarea{min-height:60px;resize:vertical}
.form-field{flex:1;min-width:120px}
.preview-panel{flex:1;min-width:300px}
#docPreview{background:#fff;border:1px solid var(--border);border-radius:8px;padding:40px;min-height:500px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.toolbar{display:flex;gap:6px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
.toolbar select{padding:5px 8px;border-radius:4px;border:1px solid var(--border);font-size:11px;cursor:pointer;background:var(--card)}
.toolbar-secondary{display:flex;gap:4px;margin-left:auto;align-items:center}
/* Welcome */
.welcome{text-align:center;padding:80px 40px;background:linear-gradient(135deg,#f0f4ff 0%,#e8f0fe 50%,#f5f3ff 100%);border-radius:12px;border:1px solid var(--border)}
.welcome h2{font-size:26px;color:var(--text);font-weight:700;margin-bottom:8px}
.welcome p{color:var(--muted);font-size:14px;margin-bottom:6px}
.welcome .stat{font-size:36px;font-weight:800;color:var(--pri);margin:16px 0 4px}
.welcome .categories{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-top:16px}
.welcome .categories span{background:#fff;border:1px solid var(--border);padding:4px 12px;border-radius:20px;font-size:11px;color:var(--muted)}
.welcome .cta-row{margin-top:24px;display:flex;gap:12px;justify-content:center}
/* Theme toggle */
.theme-toggle{display:flex;align-items:center;gap:2px;background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:2px;margin-right:4px}
.theme-toggle button{width:28px;height:28px;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;background:transparent;transition:.2s;color:var(--muted)}
.theme-toggle button.active{background:var(--pri);color:#fff}
.theme-toggle button:hover:not(.active){background:var(--hover-bg)}
/* Modal */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:12px;padding:32px;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;position:relative}
.modal h2{margin-bottom:16px;font-size:20px}
.modal-close{position:absolute;top:12px;right:16px;background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);line-height:1}
.modal input[type="text"],.modal input[type="email"],.modal input[type="password"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;font-size:14px;background:var(--bg);color:var(--text)}
.modal .btn{width:100%;padding:12px;font-size:14px;margin-top:8px}
.tab-btns{display:flex;gap:0;margin-bottom:16px}
.tab-btns button{flex:1;padding:10px;border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:13px;transition:.2s;color:var(--text)}
.tab-btns button.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.pricing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.price-card{border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
.price-card:hover,.price-card.popular{border-color:var(--pri)}
.price-card .price{font-size:28px;font-weight:800;color:var(--pri);margin:8px 0}
.price-card .price span{font-size:14px;color:var(--muted)}
.price-card ul{list-style:none;text-align:left;margin:12px 0;font-size:12px}
.price-card li{padding:4px 0;border-bottom:1px solid var(--bg)}
.price-card li::before{content:"\2713 ";color:var(--success)}
.logo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.logo-grid img{width:100%;height:80px;object-fit:contain;border:1px solid var(--border);border-radius:4px;cursor:pointer;padding:4px}
.logo-grid img:hover{border-color:var(--pri)}
.avatar{width:32px;height:32px;border-radius:50%;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;cursor:pointer}
.user-menu{position:relative}
.user-dropdown{position:absolute;top:40px;right:0;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;min-width:200px;display:none;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.user-dropdown.show{display:block}
.user-dropdown a{display:block;padding:8px 12px;font-size:13px;color:var(--text);text-decoration:none;border-radius:4px}
.user-dropdown a:hover{background:var(--hover-bg)}
.user-dropdown .divider{border-top:1px solid var(--border);margin:4px 0}
.load-more-btn{width:100%;padding:8px;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;color:var(--muted)}
.load-more-btn:hover{border-color:var(--pri);color:var(--pri)}
.doc-count{font-size:11px;color:var(--muted);padding:4px 12px}
/* Email capture banner */
.email-banner{background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;padding:12px 16px;border-radius:8px;margin:8px 0;text-align:center}
.email-banner h4{font-size:13px;margin-bottom:4px}
.email-banner p{font-size:11px;opacity:.85;margin-bottom:8px}
.email-banner form{display:flex;gap:4px}
.email-banner input{flex:1;padding:6px 10px;border:none;border-radius:4px;font-size:12px}
.email-banner button{padding:6px 12px;border:none;border-radius:4px;background:#fff;color:var(--pri);font-weight:700;font-size:12px;cursor:pointer}
/* SEO landing page */
.seo-context{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px 20px;margin-top:16px;font-size:13px;line-height:1.7;color:var(--muted)}
.seo-context h4{color:var(--text);font-size:14px;margin-bottom:6px}
/* Saved docs */
.saved-docs-list{margin-top:8px}
.saved-doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:6px;margin-bottom:6px;font-size:12px;background:var(--card);cursor:pointer;transition:.15s}
.saved-doc-item:hover{border-color:var(--pri)}
.saved-doc-item .saved-meta{color:var(--muted);font-size:10px}
.saved-doc-item .delete-saved{color:var(--danger);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px}
.saved-doc-item .delete-saved:hover{background:#fee2e2}
.save-indicator{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--success);margin-left:8px;opacity:0;transition:opacity .3s}
.save-indicator.show{opacity:1}
@media print{.sidebar,.main-header,.toolbar,.form-panel,.modal-overlay,.email-banner,.seo-context{display:none!important}.main-content{padding:0!important}#docPreview{border:none!important;box-shadow:none!important;padding:20px!important}}
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
<div class="sidebar-header">
<h1>DraftMyForms <span>11K+</span></h1>
<p>Free Professional Document Generator</p>
<input class="search-box" id="searchBox" placeholder="Search invoices, contracts, forms..." oninput="filterDocs()">
</div>
<div class="sidebar-content">
<div class="cat-grid" id="catGrid"></div>
<div class="filter-row">
<span class="tier-btn active" onclick="setTier('all')">All</span>
<span class="tier-btn" onclick="setTier('free')">Free</span>
<span class="tier-btn" onclick="setTier('pro')">Pro</span>
<span class="tier-btn" onclick="setTier('business')">Biz</span>
<select class="sort-select" id="sortSelect" onchange="renderDocList()">
<option value="popular">Popular</option>
<option value="alpha">A-Z</option>
<option value="free-first">Free First</option>
<option value="newest">Newest</option>
</select>
</div>
<div class="doc-count" id="docCount"></div>
<ul class="doc-list" id="docList"></ul>
<button class="load-more-btn" id="loadMoreBtn" style="display:none" onclick="loadMoreDocs()">Load More Templates</button>
<div class="email-banner" id="emailBanner">
<h4>Unlock 3 Free Pro Templates</h4>
<p>Enter your email to get instant access</p>
<form onsubmit="captureEmail(event)">
<input type="email" id="captureEmailInput" placeholder="you@email.com" required>
<button type="submit">Get Free</button>
</form>
</div>
</div>
</div>
<!-- Main -->
<div class="main">
<div class="main-header">
<div style="display:flex;align-items:center">
<h2 id="docTitle">Select a Document</h2>
<span class="badge badge-free" id="planBadge">FREE PLAN</span>
<span class="save-indicator" id="saveIndicator">✓ Saved</span>
</div>
<div class="header-actions">
<div class="theme-toggle" id="themeToggle">
<button onclick="setColorTheme('light')" title="Light" id="themeLight">☀</button>
<button onclick="setColorTheme('dark')" title="Dark" id="themeDark">☾</button>
<button onclick="setColorTheme('system')" title="System" id="themeSystem" class="active">⚙</button>
</div>
<button class="btn-ghost btn-sm" onclick="openLogo()" title="Add Logo">Logo</button>
<button class="btn-ghost btn-sm" onclick="openUpload()" title="Upload Document">Upload</button>
<button class="btn btn-sm" onclick="openPricing()">Upgrade</button>
<div class="user-menu" id="userMenu">
<button class="btn btn-sm" id="authBtn" onclick="openAuth()">Sign In</button>
</div>
</div>
</div>
<div class="main-content" id="mainContent">
<div class="form-panel" id="formPanel" style="display:none">
<div class="toolbar">
<select id="themeSelect" onchange="applyTheme()">
<option value="modern">Modern</option>
<option value="classic">Classic</option>
<option value="elegant">Elegant</option>
<option value="corporate">Corporate</option>
<option value="minimal">Minimal</option>
<option value="bold">Bold</option>
</select>
<button class="btn btn-pri" onclick="generatePDF()">Download PDF</button>
<button class="btn btn-sm" onclick="saveDocument()" id="saveDocBtn" style="display:none">Save</button>
<div class="toolbar-secondary">
<button class="btn-ghost btn-sm" onclick="printDoc()">Print</button>
<button class="btn-ghost btn-sm" onclick="resetForm()">Reset</button>
</div>
</div>
<div id="formFields"></div>
<div class="seo-context" id="seoContext"></div>
</div>
<div class="preview-panel">
<div id="docPreview">
<div class="welcome">
<h2>Create Professional Documents in Seconds</h2>
<p>No sign-up required for free templates</p>
<div class="stat" id="templateCount">10,000+</div>
<p>templates ready to customize and download</p>
<div class="categories" id="welcomeCats"></div>
<div class="cta-row">
<button class="btn btn-pri" onclick="document.getElementById('searchBox').focus()">Browse Templates</button>
<button class="btn" onclick="setTier('free')">View Free Templates</button>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Modals -->
<div class="modal-overlay" id="authModal">
<div class="modal">
<button class="modal-close" onclick="closeModal('authModal')">&times;</button>
<h2 id="authTitle">Sign In</h2>
<div class="tab-btns"><button class="active" onclick="switchAuthTab('login')">Login</button><button onclick="switchAuthTab('register')">Register</button></div>
<div id="loginForm"><input type="email" id="loginEmail" placeholder="Email"><input type="password" id="loginPass" placeholder="Password"><button class="btn btn-pri" onclick="doLogin()">Sign In</button></div>
<div id="registerForm" style="display:none"><input type="text" id="regName" placeholder="Full Name"><input type="email" id="regEmail" placeholder="Email"><input type="password" id="regPass" placeholder="Password (min 6 chars)"><button class="btn btn-pri" onclick="doRegister()">Create Account</button></div>
<p id="authMsg" style="margin-top:8px;font-size:12px;color:var(--danger)"></p>
</div>
</div>
<div class="modal-overlay" id="pricingModal">
<div class="modal" style="max-width:700px">
<button class="modal-close" onclick="closeModal('pricingModal')">&times;</button>
<h2>Choose Your Plan</h2>
<p style="color:var(--muted);margin-bottom:16px">Unlock premium templates and features</p>
<div class="pricing-grid">
<div class="price-card" onclick="selectPlan('free')"><h3>Free</h3><div class="price">$0<span>/mo</span></div><ul><li>Basic templates</li><li>Invoices & receipts</li><li>Letters & memos</li><li>PDF download</li><li>6 themes</li></ul><button class="btn" style="width:100%">Current Plan</button></div>
<div class="price-card popular" onclick="selectPlan('pro')"><h3>Pro</h3><div class="price">$9.99<span>/mo</span></div><ul><li>All Free templates</li><li>Contracts & agreements</li><li>Tax & financial</li><li>Real estate</li><li>Priority support</li></ul><button class="btn btn-pri" style="width:100%">Upgrade to Pro</button></div>
<div class="price-card" onclick="selectPlan('business')"><h3>Business</h3><div class="price">$24.99<span>/mo</span></div><ul><li>All Pro templates</li><li>Legal & government</li><li>Healthcare & medical</li><li>Insurance & claims</li><li>Custom branding</li></ul><button class="btn btn-pri" style="width:100%">Go Business</button></div>
</div>
</div>
</div>
<div class="modal-overlay" id="logoModal">
<div class="modal">
<button class="modal-close" onclick="closeModal('logoModal')">&times;</button>
<h2>Logo Studio</h2>
<input type="text" id="logoSearch" placeholder="Search company logos..." oninput="searchLogos()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;background:var(--bg);color:var(--text)">
<div class="logo-grid" id="logoGrid"></div>
<hr style="margin:16px 0"><h3 style="font-size:14px;margin-bottom:8px">Create Custom Logo</h3>
<input type="text" id="logoText" placeholder="Company Name" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;margin-bottom:8px;background:var(--bg);color:var(--text)">
<div style="display:flex;gap:8px;margin-bottom:8px">
<input type="color" id="logoColor" value="#2563eb" style="width:40px;height:36px;border:none;cursor:pointer">
<select id="logoShape" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--text)"><option value="circle">Circle</option><option value="square">Square</option><option value="rounded">Rounded</option><option value="text-only">Text Only</option></select>
<button class="btn btn-pri" onclick="createLogo()">Create</button>
</div>
<div id="logoPreview" style="text-align:center;padding:16px"></div>
</div>
</div>
<div class="modal-overlay" id="uploadModal">
<div class="modal">
<button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
<h2>Upload Document</h2>
<p style="color:var(--muted);margin-bottom:16px;font-size:13px">Upload JSON, CSV, or TXT files</p>
<div style="border:2px dashed var(--border);border-radius:8px;padding:40px;text-align:center;cursor:pointer" onclick="document.getElementById('fileInput').click()">
<p style="color:var(--muted)">Click to upload or drag & drop</p>
<p style="font-size:11px;color:var(--muted);margin-top:4px">JSON, CSV, TXT</p>
</div>
<input type="file" id="fileInput" accept=".json,.csv,.txt" style="display:none" onchange="handleUpload(event)">
<div id="uploadResult" style="margin-top:12px"></div>
</div>
</div>
<div class="modal-overlay" id="savedDocsModal">
<div class="modal" style="max-width:560px">
<button class="modal-close" onclick="closeModal('savedDocsModal')">&times;</button>
<h2>My Saved Documents</h2>
<p style="color:var(--muted);margin-bottom:16px;font-size:13px">Your saved documents are stored securely in the cloud.</p>
<div id="savedDocsList" class="saved-docs-list"><p style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Loading...</p></div>
</div>
</div>
<script>
const SUPA_URL='https://mupeqeuuwdmkndvtbhzb.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
const POPULAR_NAMES=['Standard Invoice','Commercial Invoice','Freelance Invoice','Sales Receipt','Payment Receipt','Cover Letter','Resignation Letter','Recommendation Letter','Professional Resume','Employment Contract','Non-Disclosure Agreement','Service Agreement','Lease Agreement','W-9 Form','1099-NEC Form','Profit and Loss Statement','Power of Attorney','Last Will and Testament','Living Will','Purchase Agreement','Rental Application','Patient Intake Form','HIPAA Authorization','Auto Insurance Claim','Certificate of Completion','Business Plan','Bank Statement','Bill of Lading','Software Requirements Document','Offer Letter','Job Description','Performance Review'];
const SEO_CTX={'invoice':'An invoice is a commercial document sent by a seller to a buyer, detailing products or services provided and the amount owed. Use this template to create professional invoices for your business.','receipt':'A receipt is a written acknowledgment that payment has been received. This template helps you create professional receipts for any transaction.','letter':'A formal letter follows standard business formatting conventions. Use this template to create professional correspondence for any purpose.','memo':'A memorandum (memo) is an internal document used to communicate policies, procedures, or updates within an organization.','resume':'A resume is a document summarizing your professional experience, education, and skills. This template helps you create a polished resume that stands out.','contract':'A contract is a legally binding agreement between two or more parties. This template provides a professional framework for your agreement.','agreement':'An agreement outlines the terms and conditions accepted by all parties. Use this template to formalize any business arrangement.','tax':'Tax forms are official documents used to report income, calculate tax liability, and file returns with federal and state agencies.','legal':'Legal documents are formal papers used in court proceedings, estate planning, and official government matters.','real estate':'Real estate documents facilitate property transactions including buying, selling, leasing, and property management.','medical':'Medical documents are used in healthcare settings for patient care, record-keeping, and regulatory compliance.','insurance':'Insurance documents are used to file claims, apply for coverage, and manage policies across all types of insurance.','education':'Educational documents support teaching, learning, and academic administration from K-12 through higher education.','business':'Business documents support operations, planning, and management across all departments and functions.','banking':'Banking documents facilitate financial transactions, account management, and loan applications.','transport':'Transportation and logistics documents manage the movement of goods, including shipping, customs, and fleet management.','tech':'Technology documents support software development, IT operations, and technical project management.'};
let CATS=[];let currentCat=null;let currentTier='all';let currentDoc=null;let currentDocCat=null;let currentUser=null;let userPlan='free';let docPageSize=50;let docOffset=0;let totalFilteredDocs=0;let customLogo=null;let updatePreviewFn=null;

/* ========== COLOR THEME SYSTEM ========== */
function initTheme(){
  const saved=localStorage.getItem('docpro_theme')||'system';
  applyColorTheme(saved);
  updateThemeButtons(saved);
}
function setColorTheme(mode){
  localStorage.setItem('docpro_theme',mode);
  applyColorTheme(mode);
  updateThemeButtons(mode);
  // Save to profile if logged in
  if(currentUser){
    sb.from('profiles').update({theme_preference:mode}).eq('id',currentUser.id).then(()=>{});
  }
}
function applyColorTheme(mode){
  if(mode==='system'){
    const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme',prefersDark?'dark':'light');
  }else{
    document.documentElement.setAttribute('data-theme',mode);
  }
}
function updateThemeButtons(mode){
  document.getElementById('themeLight').classList.toggle('active',mode==='light');
  document.getElementById('themeDark').classList.toggle('active',mode==='dark');
  document.getElementById('themeSystem').classList.toggle('active',mode==='system');
}
// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{
  if(localStorage.getItem('docpro_theme')==='system')applyColorTheme('system');
});

/* ========== SAVE DOCUMENT SYSTEM ========== */
async function saveDocument(){
  if(!currentUser){openAuth();return;}
  if(!currentDoc){alert('Select a document first');return;}
  const fields={};
  document.querySelectorAll('#formFields input,#formFields textarea').forEach(el=>{
    if(el.id&&el.id.startsWith('field_'))fields[el.id.replace('field_','')]=el.value;
  });
  const theme=document.getElementById('themeSelect').value;
  try{
    // Check if already saved (upsert)
    const{data:existing}=await sb.from('saved_documents').select('id').eq('user_id',currentUser.id).eq('template_name',currentDoc.name).limit(1);
    if(existing&&existing.length>0){
      await sb.from('saved_documents').update({form_data:fields,theme,template_category:currentDocCat,updated_at:new Date().toISOString()}).eq('id',existing[0].id);
    }else{
      await sb.from('saved_documents').insert({user_id:currentUser.id,template_name:currentDoc.name,template_category:currentDocCat,form_data:fields,theme});
    }
    const ind=document.getElementById('saveIndicator');
    ind.classList.add('show');
    setTimeout(()=>ind.classList.remove('show'),2000);
  }catch(e){console.error('Save error:',e);alert('Failed to save. Try again.');}
}
async function loadSavedDocs(){
  if(!currentUser){document.getElementById('savedDocsList').innerHTML='<p style="color:var(--muted);text-align:center;padding:20px">Sign in to see your saved documents.</p>';return;}
  try{
    const{data,error}=await sb.from('saved_documents').select('*').eq('user_id',currentUser.id).order('updated_at',{ascending:false});
    const el=document.getElementById('savedDocsList');
    if(error||!data||data.length===0){el.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px">No saved documents yet. Open a template and click Save to get started.</p>';return;}
    el.innerHTML=data.map(d=>'<div class="saved-doc-item" onclick="openSavedDoc('+d.id+',\''+d.template_name.replace(/'/g,"\\\'")+'\',\''+d.template_category.replace(/'/g,"\\\'")+'\')"><div><strong>'+d.template_name+'</strong><div class="saved-meta">'+d.template_category+' • '+new Date(d.updated_at).toLocaleDateString()+'</div></div><span class="delete-saved" onclick="event.stopPropagation();deleteSavedDoc('+d.id+')" title="Delete">✕</span></div>').join('');
  }catch(e){console.error(e);document.getElementById('savedDocsList').innerHTML='<p style="color:var(--danger);text-align:center;padding:20px">Error loading documents.</p>';}
}
async function openSavedDoc(id,name,catName){
  closeModal('savedDocsModal');
  // Find template in CATS
  for(let ci=0;ci<CATS.length;ci++){
    for(let di=0;di<CATS[ci].docs.length;di++){
      if(CATS[ci].docs[di].name===name){
        currentDoc=CATS[ci].docs[di];currentDocCat=CATS[ci].n;
        document.getElementById('docTitle').textContent=name;
        document.getElementById('formPanel').style.display='block';
        history.replaceState(null,'','#'+slugify(name));
        document.title=name+' Template - Free Download | DraftMyForms';
        renderDoc(name,catName);
        // Load saved form data
        try{
          const{data}=await sb.from('saved_documents').select('form_data,theme').eq('id',id).single();
          if(data&&data.form_data){
            Object.entries(data.form_data).forEach(([k,v])=>{const el=document.getElementById('field_'+k);if(el)el.value=v;});
            if(data.theme){document.getElementById('themeSelect').value=data.theme;applyTheme();}
            else if(updatePreviewFn)updatePreviewFn();
          }
        }catch(e){console.error(e);}
        return;
      }
    }
  }
  alert('Template not found: '+name);
}
async function deleteSavedDoc(id){
  if(!confirm('Delete this saved document?'))return;
  try{await sb.from('saved_documents').delete().eq('id',id);loadSavedDocs();}catch(e){console.error(e);}
}
function openSavedDocsModal(){document.getElementById('savedDocsModal').classList.add('show');loadSavedDocs();}
/* ========== INIT & DATA ========== */
async function init(){
  initTheme();
  try{
    const all=await fetchAllTemplates();
    if(all.length>0){
      const catMap={};
      all.forEach(t=>{if(!catMap[t.category])catMap[t.category]={n:t.category,docs:[]};catMap[t.category].docs.push({name:t.name,tier:t.tier,fields:t.fields});});
      CATS=Object.values(catMap).sort((a,b)=>a.n.localeCompare(b.n));
      console.log('Loaded '+all.length+' templates in '+CATS.length+' categories');
      document.getElementById('templateCount').textContent=all.length.toLocaleString()+'+';
    }
  }catch(e){console.error(e);useFallback();}
  renderSidebar();buildWelcomeCats();handleHashRoute();
}
async function fetchAllTemplates(){
  let all=[],from=0;
  while(true){
    const{data,error}=await sb.from('templates').select('name,category,tier,fields').range(from,from+999).order('category').order('name');
    if(error||!data||data.length===0)break;
    all=all.concat(data);if(data.length<1000)break;from+=1000;
  }
  return all;
}
function useFallback(){
  const cats=['Invoices & Receipts','Letters & Memos','Resumes & Employment','Contracts & Agreements','Tax & Financial','Legal & Government','Real Estate & Property','Healthcare & Medical','Insurance & Claims','Education & Academic','Business Operations','Banking & Financial','Transportation & Logistics','Technology & IT'];
  const tiers=['free','free','free','pro','pro','business','pro','business','business','free','pro','pro','pro','pro'];
  CATS=cats.map((n,i)=>{const docs=[];for(let j=1;j<=8;j++)docs.push({name:n.split('&')[0].trim()+' Template '+j,tier:tiers[i]});return{n,docs};});
}
function buildWelcomeCats(){const el=document.getElementById('welcomeCats');if(el)el.innerHTML=CATS.map(c=>'<span>'+c.n+'</span>').join('');}
function handleHashRoute(){
  const h=window.location.hash;if(!h||h==='#')return;
  const slug=decodeURIComponent(h.substring(1));
  for(let ci=0;ci<CATS.length;ci++){for(let di=0;di<CATS[ci].docs.length;di++){
    if(slugify(CATS[ci].docs[di].name)===slug||CATS[ci].docs[di].name===slug){
      currentDoc=CATS[ci].docs[di];currentDocCat=CATS[ci].n;
      document.getElementById('docTitle').textContent=currentDoc.name;
      document.getElementById('formPanel').style.display='block';
      document.title=currentDoc.name+' Template - Free Download | DraftMyForms';
      const meta=document.querySelector('meta[name="description"]');
      if(meta)meta.content='Free '+currentDoc.name+' template. Fill out, customize, and download as PDF instantly. Professional '+CATS[ci].n.toLowerCase()+' document generator.';
      renderDoc(currentDoc.name,currentDocCat);return;
    }
  }}
}
function slugify(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');}
window.addEventListener('hashchange',handleHashRoute);

/* ========== SIDEBAR ========== */
function renderSidebar(){
  const grid=document.getElementById('catGrid');
  grid.innerHTML=CATS.map((c,i)=>'<div class="cat-btn'+(currentCat===i?' active':'')+'" onclick="selectCat('+i+')">'+c.n.split('&')[0].trim()+'</div>').join('');
  docOffset=0;renderDocList();
}
function selectCat(i){currentCat=currentCat===i?null:i;document.querySelectorAll('.cat-btn').forEach((b,idx)=>b.classList.toggle('active',idx===i&&currentCat!==null));if(currentCat===null)document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));docOffset=0;renderDocList();}
function setTier(t){currentTier=t;document.querySelectorAll('.tier-btn').forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase()===t||b.textContent.toLowerCase()==='biz'&&t==='business'));docOffset=0;renderDocList();}
function getFilteredDocs(){
  const q=document.getElementById('searchBox').value.toLowerCase();let docs=[];
  CATS.forEach((c,ci)=>{if(currentCat!==null&&currentCat!==ci)return;
    c.docs.forEach(d=>{if(currentTier!=='all'&&d.tier!==currentTier)return;if(q&&!d.name.toLowerCase().includes(q)&&!c.n.toLowerCase().includes(q))return;docs.push({...d,catIdx:ci,catName:c.n});});
  });return docs;
}
function sortDocs(docs){
  const mode=document.getElementById('sortSelect').value;
  if(mode==='popular'){const popSet=new Set(POPULAR_NAMES.map(n=>n.toLowerCase()));docs.sort((a,b)=>{const ap=popSet.has(a.name.toLowerCase())?0:1;const bp=popSet.has(b.name.toLowerCase())?0:1;if(ap!==bp)return ap-bp;if(ap===0&&bp===0){const ai=POPULAR_NAMES.findIndex(p=>p.toLowerCase()===a.name.toLowerCase());const bi=POPULAR_NAMES.findIndex(p=>p.toLowerCase()===b.name.toLowerCase());return ai-bi;}return a.name.localeCompare(b.name);});}
  else if(mode==='free-first'){const tierOrder={free:0,pro:1,business:2};docs.sort((a,b)=>(tierOrder[a.tier]||0)-(tierOrder[b.tier]||0)||a.name.localeCompare(b.name));}
  else if(mode==='newest'){docs.reverse();}
  else{docs.sort((a,b)=>a.name.localeCompare(b.name));}
  return docs;
}
function renderDocList(){
  let docs=sortDocs(getFilteredDocs());totalFilteredDocs=docs.length;
  const page=docs.slice(0,docOffset+docPageSize);
  const list=document.getElementById('docList');
  list.innerHTML=page.map((d,i)=>'<li class="doc-item'+(currentDoc&&d.name===currentDoc.name?' active':'')+'" onclick="openDoc('+i+')" data-idx="'+i+'"><span>'+d.name+'</span><span class="doc-tier '+d.tier+'">'+d.tier+'</span></li>').join('');
  document.getElementById('docCount').textContent=totalFilteredDocs.toLocaleString()+' templates';
  document.getElementById('loadMoreBtn').style.display=page.length<totalFilteredDocs?'block':'none';
}
function loadMoreDocs(){docOffset+=docPageSize;renderDocList();}
function filterDocs(){docOffset=0;renderDocList();}

/* ========== DOC OPEN ========== */
function openDoc(listIdx){
  const docs=sortDocs(getFilteredDocs());const d=docs[listIdx];if(!d)return;
  if(!canAccess(d.tier)){openPricing();return;}
  currentDoc=d;currentDocCat=d.catName;
  document.getElementById('docTitle').textContent=d.name;
  document.getElementById('formPanel').style.display='block';
  // Show save button if logged in
  document.getElementById('saveDocBtn').style.display=currentUser?'inline-block':'none';
  document.querySelectorAll('.doc-item').forEach((el,i)=>el.classList.toggle('active',i===listIdx));
  history.replaceState(null,'','#'+slugify(d.name));
  document.title=d.name+' Template - Free Download | DraftMyForms';
  renderDoc(d.name,d.catName);showSeoContext(d.name,d.catName);
}
function showSeoContext(name,catName){
  const el=document.getElementById('seoContext');const nm=name.toLowerCase();const cn=catName.toLowerCase();let ctx='';
  for(const[key,val]of Object.entries(SEO_CTX)){if(nm.includes(key)||cn.includes(key)){ctx=val;break;}}
  if(ctx){el.innerHTML='<h4>About This '+name+' Template</h4><p>'+ctx+' Customize the fields on the left, choose from 6 professional themes, and download your completed document as a PDF. All free templates require no sign-up.</p>';el.style.display='block';}else{el.style.display='none';}
}
function canAccess(tier){if(isAdmin())return true;if(tier==='free')return true;if(tier==='pro'){if(userPlan==='pro'||userPlan==='business')return true;var fpt=JSON.parse(localStorage.getItem('docpro_free_pro_templates')||'[]');if(currentDoc&&fpt.indexOf(currentDoc.name)>-1)return true;}if(tier==='business'&&userPlan==='business')return true;return false;}
function isAdmin(){return currentUser&&currentUser.email&&(currentUser.email==='admin@docpro.com'||currentUser.email==='larrywomack40@gmail.com'||currentUser.role==='admin');}
function captureEmail(e){e.preventDefault();const email=document.getElementById('captureEmailInput').value;if(!email)return;try{sb.from('email_leads').insert({email,source:'sidebar_banner'});}catch(ex){}localStorage.setItem('docpro_email',email);localStorage.setItem('docpro_free_pro_templates',JSON.stringify(['1099-B Form V11','1099-B Form V13','1099-B Form V15']));const banners=document.querySelectorAll('.email-banner');banners.forEach(function(eb){eb.innerHTML='<h4 style="margin:0">3 Pro Templates Unlocked!</h4><p style="margin:4px 0 0;opacity:.85">1099-B V11, V13 & V15 are now free for you.</p>';});setTimeout(function(){openAuth();},1500);}
/* ========== RENDERERS ========== */
function renderDoc(name,catName){
  const cn=catName.toLowerCase();const nm=name.toLowerCase();let r;
  if(cn.includes('invoice')||cn.includes('receipt'))r=renderInvoiceReceipt;
  else if(cn.includes('letter')||cn.includes('memo'))r=renderLetterMemo;
  else if(cn.includes('resume')||cn.includes('employment'))r=renderResumeEmployment;
  else if(cn.includes('contract')||cn.includes('agreement'))r=renderContract;
  else if(cn.includes('tax')||cn.includes('financial')&&!cn.includes('bank'))r=renderTaxFinancial;
  else if(cn.includes('legal')||cn.includes('government'))r=renderLegalGov;
  else if(cn.includes('real estate')||cn.includes('property'))r=renderRealEstate;
  else if(cn.includes('health')||cn.includes('medical'))r=renderHealthcare;
  else if(cn.includes('insurance')||cn.includes('claim'))r=renderInsurance;
  else if(cn.includes('education')||cn.includes('academic'))r=renderEducation;
  else if(cn.includes('business')||cn.includes('operation'))r=renderBusiness;
  else if(cn.includes('banking'))r=renderBanking;
  else if(cn.includes('transport')||cn.includes('logistics'))r=renderTransport;
  else if(cn.includes('tech')||cn.includes(' it'))r=renderTechIT;
  else{if(nm.includes('invoice')||nm.includes('receipt'))r=renderInvoiceReceipt;else if(nm.includes('letter')||nm.includes('memo'))r=renderLetterMemo;else if(nm.includes('resume'))r=renderResumeEmployment;else if(nm.includes('contract')||nm.includes('agreement'))r=renderContract;else r=renderGenericDoc;}
  r(name);
}
function getThemeStyles(){
  const t=document.getElementById('themeSelect').value;
  const themes={modern:{primary:'#2563eb',font:'system-ui,sans-serif',border:'2px solid #2563eb',headerBg:'#2563eb',headerColor:'#fff',radius:'8px'},classic:{primary:'#1a1a1a',font:'Georgia,serif',border:'1px solid #333',headerBg:'#1a1a1a',headerColor:'#fff',radius:'0'},elegant:{primary:'#7c3aed',font:"'Palatino Linotype',serif",border:'1px solid #7c3aed',headerBg:'linear-gradient(135deg,#7c3aed,#a855f7)',headerColor:'#fff',radius:'12px'},corporate:{primary:'#0f172a',font:"'Segoe UI',sans-serif",border:'2px solid #0f172a',headerBg:'#0f172a',headerColor:'#f8fafc',radius:'4px'},minimal:{primary:'#64748b',font:'Inter,sans-serif',border:'1px solid #e2e8f0',headerBg:'#f8fafc',headerColor:'#1e293b',radius:'6px'},bold:{primary:'#dc2626',font:'Impact,sans-serif',border:'3px solid #dc2626',headerBg:'#dc2626',headerColor:'#fff',radius:'0'}};
  return themes[t]||themes.modern;
}
function applyTheme(){if(currentDoc)renderDoc(currentDoc.name,currentDocCat);}
function logoHTML(){return customLogo?'<img src="'+customLogo+'" style="max-height:50px;max-width:150px" alt="Logo">':'';}
function renderInvoiceReceipt(name){
  const s=getThemeStyles();const isR=name.toLowerCase().includes('receipt');
  const fields=isR?[{id:'from',label:'From',ph:'Your Company'},{id:'to',label:'To',ph:'Client'},{id:'rnum',label:'Receipt #',ph:'R-001'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'amount',label:'Amount',ph:'$0.00'},{id:'method',label:'Payment Method',ph:'Cash/Card'},{id:'desc',label:'Description',ph:'Payment for...'},{id:'notes',label:'Notes',ph:'Notes...',type:'textarea'}]:[{id:'company',label:'Company',ph:'Your Co.'},{id:'client',label:'Client',ph:'Client Co.'},{id:'invnum',label:'Invoice #',ph:'INV-001'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'due',label:'Due Date',ph:'MM/DD/YYYY'},{id:'item1',label:'Item 1',ph:'Service'},{id:'qty1',label:'Qty',ph:'1'},{id:'rate1',label:'Rate',ph:'$0'},{id:'item2',label:'Item 2',ph:''},{id:'qty2',label:'Qty',ph:'1'},{id:'rate2',label:'Rate',ph:'$0'},{id:'tax',label:'Tax %',ph:'0'},{id:'notes',label:'Notes',ph:'Terms...',type:'textarea'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);const logo=logoHTML();
  if(isR){document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto"><div style="display:flex;justify-content:space-between;margin-bottom:20px"><div>'+logo+'<h1 style="color:'+s.primary+';font-size:28px;margin-top:8px">RECEIPT</h1><p style="color:#64748b;font-size:12px">'+name+'</p></div><div style="text-align:right"><strong>#'+(v.rnum||'___')+'</strong><br><span style="color:#64748b;font-size:12px">'+(v.date||'___')+'</span></div></div><div style="display:flex;justify-content:space-between;border-top:'+s.border+';padding-top:16px;margin-bottom:16px"><div><strong>From:</strong> '+(v.from||'___')+'</div><div><strong>To:</strong> '+(v.to||'___')+'</div></div><table style="width:100%;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Description</th><th style="padding:10px;text-align:right">Method</th><th style="padding:10px;text-align:right">Amount</th></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+(v.desc||'Payment')+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">'+(v.method||'—')+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;font-weight:700">'+(v.amount||'$0.00')+'</td></tr></table><div style="text-align:right;font-size:20px;font-weight:800;color:'+s.primary+';margin:16px 0">Total: '+(v.amount||'$0.00')+'</div>'+(v.notes?'<div style="background:#f8fafc;padding:12px;border-radius:6px;font-size:12px;color:#64748b"><strong>Notes:</strong> '+v.notes+'</div>':'')+'</div>';}
  else{const q1=parseFloat(v.qty1)||1,r1=parseFloat(v.rate1)||0,q2=parseFloat(v.qty2)||0,r2=parseFloat(v.rate2)||0;const sub=q1*r1+q2*r2,tax=sub*(parseFloat(v.tax)||0)/100,total=sub+tax;document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto"><div style="display:flex;justify-content:space-between;margin-bottom:24px"><div>'+logo+'<h1 style="color:'+s.primary+';font-size:30px;margin-top:8px">INVOICE</h1><p style="color:#64748b;font-size:12px">'+name+'</p></div><div style="text-align:right"><strong>'+(v.company||'Company')+'</strong><br><span style="color:#64748b;font-size:12px">#'+(v.invnum||'___')+' | '+(v.date||'_/_/_')+'</span></div></div><hr style="border:none;border-top:'+s.border+'"><div style="display:flex;justify-content:space-between;margin:20px 0"><div><strong>BILL TO</strong><br>'+(v.client||'___')+'</div><div style="text-align:right"><strong>DUE</strong><br>'+(v.due||'___')+'</div></div><table style="width:100%;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Description</th><th style="padding:10px;text-align:center">Qty</th><th style="padding:10px;text-align:right">Rate</th><th style="padding:10px;text-align:right">Amount</th></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+(v.item1||'Service')+'</td><td style="padding:10px;text-align:center;border-bottom:1px solid #e2e8f0">'+q1+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+r1.toFixed(2)+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+(q1*r1).toFixed(2)+'</td></tr>'+(v.item2?'<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+v.item2+'</td><td style="padding:10px;text-align:center;border-bottom:1px solid #e2e8f0">'+q2+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+r2.toFixed(2)+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+(q2*r2).toFixed(2)+'</td></tr>':'')+'</table><div style="text-align:right;margin-top:16px"><p>Subtotal: $'+sub.toFixed(2)+'</p><p>Tax: $'+tax.toFixed(2)+'</p><p style="font-size:22px;font-weight:800;color:'+s.primary+';margin-top:8px">Total: $'+total.toFixed(2)+'</p></div>'+(v.notes?'<div style="background:#f8fafc;padding:12px;border-radius:6px;font-size:12px;color:#64748b;margin-top:16px"><strong>Notes:</strong> '+v.notes+'</div>':'')+'</div>';}
  };updatePreviewFn();
  }
function renderLetterMemo(name){
  const s=getThemeStyles();const isM=name.toLowerCase().includes('memo');
  const fields=isM?[{id:'from',label:'From',ph:'Your Name'},{id:'to',label:'To',ph:'Recipient'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'subject',label:'Subject',ph:'Subject'},{id:'body',label:'Body',ph:'Content...',type:'textarea'},{id:'actions',label:'Action Items',ph:'Actions...',type:'textarea'}]:[{id:'from',label:'From',ph:'Your Name'},{id:'address',label:'Address',ph:'123 Main St'},{id:'to',label:'To',ph:'Recipient'},{id:'toaddr',label:'To Address',ph:'456 Oak Ave'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'subject',label:'Subject',ph:'Re: Subject'},{id:'body',label:'Body',ph:'Dear...',type:'textarea'},{id:'closing',label:'Closing',ph:'Sincerely'},{id:'sig',label:'Signature',ph:'Your Name'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);const logo=logoHTML();
  if(isM){document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logo+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+' '+s.radius+' 0 0;margin-top:12px"><h1 style="font-size:20px">MEMORANDUM</h1></div><div style="border:'+s.border+';border-top:none;padding:20px;border-radius:0 0 '+s.radius+' '+s.radius+'"><table style="width:100%;font-size:13px;margin-bottom:16px"><tr><td style="padding:4px 0;width:70px;font-weight:700">TO:</td><td>'+(v.to||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">FROM:</td><td>'+(v.from||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">DATE:</td><td>'+(v.date||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">RE:</td><td style="font-weight:700">'+(v.subject||'_____')+'</td></tr></table><hr style="border:none;border-top:2px solid '+s.primary+';margin:16px 0"><div style="font-size:14px;line-height:1.6;white-space:pre-wrap">'+(v.body||'Content...')+'</div>'+(v.actions?'<div style="margin-top:20px;background:#f8fafc;padding:12px;border-radius:6px;border-left:4px solid '+s.primary+'"><strong>Action Items:</strong><div style="margin-top:6px;font-size:13px;white-space:pre-wrap">'+v.actions+'</div></div>':'')+'</div></div>';}
  else{document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logo+'<div style="margin:12px 0 24px"><strong>'+(v.from||'Your Name')+'</strong><br><span style="color:#64748b;font-size:13px">'+(v.address||'Address')+'</span></div><div style="margin-bottom:24px;color:#64748b;font-size:13px">'+(v.date||'Date')+'</div><div style="margin-bottom:24px"><strong>'+(v.to||'Recipient')+'</strong><br><span style="color:#64748b;font-size:13px">'+(v.toaddr||'Address')+'</span></div><div style="margin-bottom:16px"><strong>Re: '+(v.subject||'Subject')+'</strong></div><div style="font-size:14px;line-height:1.8;white-space:pre-wrap">'+(v.body||'Dear Sir/Madam,\n\nI am writing to...')+'</div><div style="margin-top:32px"><p>'+(v.closing||'Sincerely')+'</p><p style="margin-top:24px;font-weight:700;border-top:1px solid #333;display:inline-block;padding-top:4px">'+(v.sig||'Signature')+'</p></div></div>';}
  };updatePreviewFn();
}
function renderResumeEmployment(name){
  const s=getThemeStyles();const isR=name.toLowerCase().includes('resume')||name.toLowerCase().includes('cv');
  const fields=isR?[{id:'name',label:'Full Name',ph:'John Smith'},{id:'email',label:'Email',ph:'john@email.com'},{id:'phone',label:'Phone',ph:'(555)123-4567'},{id:'loc',label:'Location',ph:'City, State'},{id:'summary',label:'Summary',ph:'Experienced...',type:'textarea'},{id:'exp',label:'Experience',ph:'Company - Title\nDetails...',type:'textarea'},{id:'edu',label:'Education',ph:'Degree - School',type:'textarea'},{id:'skills',label:'Skills',ph:'Skill 1, Skill 2'}]:[{id:'emp',label:'Employee',ph:'John Smith'},{id:'co',label:'Company',ph:'Acme Corp'},{id:'pos',label:'Position',ph:'Engineer'},{id:'dept',label:'Department',ph:'Engineering'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'mgr',label:'Manager',ph:'Jane Doe'},{id:'details',label:'Details',ph:'Details...',type:'textarea'},{id:'sig',label:'Signature',ph:'Authorized'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);
  if(isR){document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto"><div style="text-align:center;padding:20px;background:'+s.headerBg+';color:'+s.headerColor+';border-radius:'+s.radius+'"><h1 style="font-size:26px;letter-spacing:2px">'+(v.name||'YOUR NAME')+'</h1><p style="margin-top:6px;font-size:13px;opacity:.9">'+(v.email||'')+' | '+(v.phone||'')+' | '+(v.loc||'')+'</p></div>'+(v.summary?'<div style="margin:20px 0"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">SUMMARY</h3><p style="font-size:13px;line-height:1.6">'+v.summary+'</p></div>':'')+(v.exp?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">EXPERIENCE</h3><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+v.exp+'</div></div>':'')+(v.edu?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">EDUCATION</h3><div style="font-size:13px;white-space:pre-wrap">'+v.edu+'</div></div>':'')+(v.skills?'<div><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">SKILLS</h3><div style="display:flex;flex-wrap:wrap;gap:6px">'+v.skills.split(',').map(sk=>'<span style="background:#eff6ff;color:'+s.primary+';padding:4px 10px;border-radius:12px;font-size:12px">'+sk.trim()+'</span>').join('')+'</div></div>':'')+'</div>';}
  else{document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logoHTML()+'<h1 style="color:'+s.primary+';font-size:20px;text-align:center;margin:12px 0 4px">'+name+'</h1><p style="text-align:center;color:#64748b;font-size:12px;margin-bottom:20px">'+(v.co||'Company')+'</p><table style="width:100%;font-size:13px;border-collapse:collapse"><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:35%">Employee</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.emp||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Position</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.pos||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Department</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.dept||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Manager</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.mgr||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Date</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.date||'_____')+'</td></tr></table><div style="font-size:14px;line-height:1.6;white-space:pre-wrap;margin:20px 0">'+(v.details||'Details...')+'</div><div style="margin-top:30px;display:flex;justify-content:space-between"><div style="text-align:center;border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.sig||'Signature')+'</div><div style="text-align:center;border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">Employee</div></div></div>';}
  };updatePreviewFn();
}
function renderContract(name){
  const s=getThemeStyles();
  const fields=[{id:'a',label:'Party A',ph:'Company A'},{id:'b',label:'Party B',ph:'Company B'},{id:'date',label:'Effective Date',ph:'MM/DD/YYYY'},{id:'term',label:'Term',ph:'12 months'},{id:'scope',label:'Scope',ph:'This covers...',type:'textarea'},{id:'pay',label:'Payment Terms',ph:'$X/month',type:'textarea'},{id:'end',label:'Termination',ph:'Either party may...',type:'textarea'},{id:'law',label:'Governing Law',ph:'State of...'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto">'+logoHTML()+'<h1 style="text-align:center;color:'+s.primary+';font-size:22px;margin:16px 0 4px">'+name.toUpperCase()+'</h1><p style="text-align:center;color:#64748b;font-size:12px;margin-bottom:24px">Effective: '+(v.date||'_____')+'</p><div style="font-size:13px;line-height:1.8"><p>This Agreement is entered into by:</p><div style="background:#f8fafc;padding:12px;border-radius:6px;margin:12px 0;border-left:4px solid '+s.primary+'"><strong>Party A:</strong> '+(v.a||'_____')+'<br><strong>Party B:</strong> '+(v.b||'_____')+'</div><h3 style="color:'+s.primary+';margin-top:20px">1. TERM</h3><p>Period: <strong>'+(v.term||'_____')+'</strong></p><h3 style="color:'+s.primary+';margin-top:16px">2. SCOPE</h3><p style="white-space:pre-wrap">'+(v.scope||'...')+'</p><h3 style="color:'+s.primary+';margin-top:16px">3. PAYMENT</h3><p style="white-space:pre-wrap">'+(v.pay||'...')+'</p><h3 style="color:'+s.primary+';margin-top:16px">4. TERMINATION</h3><p style="white-space:pre-wrap">'+(v.end||'...')+'</p><h3 style="color:'+s.primary+';margin-top:16px">5. GOVERNING LAW</h3><p>Governed by laws of <strong>'+(v.law||'_____')+'</strong></p><div style="margin-top:40px;display:flex;justify-content:space-between"><div><strong>Party A:</strong><br><br><div style="border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.a||'Signature')+'</div></div><div><strong>Party B:</strong><br><br><div style="border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.b||'Signature')+'</div></div></div></div></div>';};updatePreviewFn();
  }
function renderTaxFinancial(name){const s=getThemeStyles();const fields=[{id:'n',label:'Taxpayer/Company',ph:'Full Name'},{id:'ein',label:'SSN/EIN',ph:'XX-XXXXXXX'},{id:'year',label:'Year',ph:'2025'},{id:'status',label:'Status',ph:'Single/Married'},{id:'inc',label:'Income',ph:'$0.00'},{id:'ded',label:'Deductions',ph:'$0.00'},{id:'cred',label:'Credits',ph:'$0.00'},{id:'due',label:'Tax Due',ph:'$0.00'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'sig',label:'Signature',ph:'Taxpayer'}];renderFormFields(fields);updatePreviewFn=()=>{const v=getFieldValues(fields);document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto">'+logoHTML()+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+';margin-top:12px;text-align:center"><h1 style="font-size:18px">'+name.toUpperCase()+'</h1><p style="font-size:11px;opacity:.8">Tax Year: '+(v.year||'____')+'</p></div><div style="padding:20px;border:'+s.border+';border-top:none;border-radius:0 0 '+s.radius+' '+s.radius+'"><table style="width:100%;font-size:13px;border-collapse:collapse;margin-bottom:20px"><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:40%">Name</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.n||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">SSN/EIN</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.ein||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Status</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.status||'_____')+'</td></tr></table><table style="width:100%;font-size:13px;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Item</th><th style="padding:10px;text-align:right">Amount</th></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Income</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">'+(v.inc||'$0')+'</td></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Deductions</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;color:#dc2626">-'+(v.ded||'$0')+'</td></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Credits</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;color:#16a34a">-'+(v.cred||'$0')+'</td></tr><tr style="font-weight:700"><td style="padding:10px;border-top:2px solid '+s.primary+'">Tax Due</td><td style="padding:10px;text-align:right;border-top:2px solid '+s.primary+';color:'+s.primary+';font-size:18px">'+(v.due||'$0')+'</td></tr></table><div style="margin-top:30px;display:flex;justify-content:space-between"><div style="font-size:12px;color:#64748b">Date: '+(v.date||'_____')+'</div><div style="text-align:center;border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.sig||'Signature')+'</div></div></div></div>';};updatePreviewFn();}
function renderGenericDoc(name){const s=getThemeStyles();const fields=[{id:'title',label:'Title',ph:name},{id:'from',label:'From',ph:'Name'},{id:'to',label:'To',ph:'Recipient'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'ref',label:'Ref #',ph:'REF-001'},{id:'body',label:'Content',ph:'...',type:'textarea'},{id:'sig',label:'Signature',ph:'Authorized'}];renderFormFields(fields);updatePreviewFn=()=>{const v=getFieldValues(fields);document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logoHTML()+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px;border-radius:'+s.radius+';margin-top:12px;text-align:center"><h1 style="font-size:18px">'+(v.title||name).toUpperCase()+'</h1></div><div style="padding:20px;border:'+s.border+';border-top:none;border-radius:0 0 '+s.radius+' '+s.radius+'"><div style="display:flex;justify-content:space-between;margin-bottom:16px;font-size:13px"><div><strong>From:</strong> '+(v.from||'_____')+'</div><div><strong>To:</strong> '+(v.to||'_____')+'</div></div><div style="display:flex;justify-content:space-between;margin-bottom:20px;font-size:13px"><div><strong>Date:</strong> '+(v.date||'_____')+'</div><div><strong>Ref:</strong> '+(v.ref||'_____')+'</div></div><hr style="margin-bottom:20px;border-color:#e2e8f0"><div style="font-size:14px;line-height:1.8;white-space:pre-wrap">'+(v.body||'...')+'</div><div style="margin-top:40px;text-align:right;border-top:1px solid #333;display:inline-block;width:180px;padding-top:4px;font-size:11px;float:right">'+(v.sig||'Signature')+'</div></div></div>';};updatePreviewFn();}
/* Category renderers */
function renderLegalGov(n){renderCatDoc(n,'LEGAL DOCUMENT','Case #','Court','State','Jurisdiction','Filed By','Description','Terms','Witness/Notary');}
function renderRealEstate(n){renderCatDoc(n,'REAL ESTATE','Property Address','Buyer','Seller','Price','Agent','Description','Terms','Closing Date');}
function renderHealthcare(n){renderCatDoc(n,'MEDICAL DOCUMENT','Patient Name','DOB','MRN','Provider','Facility','Diagnosis','Treatment','Follow-Up');}
function renderInsurance(n){renderCatDoc(n,'INSURANCE','Policy #','Insured Name','Date of Loss','Claim #','Adjuster','Description','Amount','Status');}
function renderEducation(n){renderCatDoc(n,'ACADEMIC','School','Student','Teacher','Grade','Subject','Date','Description','Score');}
function renderBusiness(n){renderCatDoc(n,'BUSINESS','Company','Department','Author','Date','Version','Description','Status','Approver');}
function renderBanking(n){renderCatDoc(n,'BANKING','Account Holder','Account #','Bank','Date','Amount','Description','Reference','Branch');}
function renderTransport(n){renderCatDoc(n,'SHIPPING/LOGISTICS','Shipper','Consignee','Carrier','Origin','Destination','Date','Weight','Tracking #');}
function renderTechIT(n){renderCatDoc(n,'TECHNICAL','Project','Author','Version','Date','Status','Description','Reviewer','Approval');}
function renderCatDoc(name,header,l1,l2,l3,l4,l5,l6,l7,l8){const s=getThemeStyles();const fields=[{id:'f1',label:l1,ph:l1},{id:'f2',label:l2,ph:l2},{id:'f3',label:l3,ph:l3},{id:'f4',label:l4,ph:l4},{id:'f5',label:l5,ph:l5},{id:'f6',label:l6,ph:l6,type:'textarea'},{id:'f7',label:l7,ph:l7,type:'textarea'},{id:'f8',label:l8,ph:l8}];renderFormFields(fields);updatePreviewFn=()=>{const v=getFieldValues(fields);let rows=fields.map(f=>'<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:35%">'+f.label+'</td><td style="padding:8px;border:1px solid #e2e8f0;white-space:pre-wrap">'+(v[f.id]||'_____')+'</td></tr>').join('');document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto">'+logoHTML()+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px;border-radius:'+s.radius+';margin:12px 0;text-align:center"><h1 style="font-size:16px">'+header+'</h1><p style="font-size:11px;opacity:.8">'+name+'</p></div><table style="width:100%;font-size:13px;border-collapse:collapse">'+rows+'</table><div style="margin-top:30px;display:flex;justify-content:space-between"><div style="text-align:center;border-top:1px solid #333;width:170px;padding-top:4px;font-size:11px">Authorized Signature</div><div style="text-align:center;border-top:1px solid #333;width:170px;padding-top:4px;font-size:11px">Date</div></div></div>';};updatePreviewFn();}
/* Form helpers */
function renderFormFields(fields){const fp=document.getElementById('formFields');let h='<h3>'+((currentDoc&&currentDoc.name)||'Document')+'</h3>';for(let i=0;i<fields.length;i+=2){h+='<div class="form-row">'+fieldHTML(fields[i]);if(fields[i+1])h+=fieldHTML(fields[i+1]);h+='</div>';}fp.innerHTML=h;fp.querySelectorAll('input,textarea').forEach(el=>el.addEventListener('input',()=>{if(updatePreviewFn)updatePreviewFn();}));}
function fieldHTML(f){return f.type==='textarea'?'<div class="form-field"><label>'+f.label+'</label><textarea id="field_'+f.id+'" placeholder="'+f.ph+'"></textarea></div>':'<div class="form-field"><label>'+f.label+'</label><input id="field_'+f.id+'" placeholder="'+f.ph+'"></div>';}
function getFieldValues(fields){const v={};fields.forEach(f=>{const el=document.getElementById('field_'+f.id);v[f.id]=el?el.value:'';});return v;}
function resetForm(){document.querySelectorAll('#formFields input,#formFields textarea').forEach(el=>el.value='');if(updatePreviewFn)updatePreviewFn();}

/* PDF & Print */
function generatePDF(){const el=document.getElementById('docPreview');if(!el||!el.innerHTML.trim()||el.querySelector('.welcome')){alert('Select a document first');return;}const name=(currentDoc?currentDoc.name:'Document')+'_DraftMyForms';html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#fff'}).then(canvas=>{const{jsPDF}=window.jspdf;const pdf=new jsPDF('p','mm','a4');const iw=pdf.internal.pageSize.getWidth()-20;const ih=canvas.height*iw/canvas.width;let ph=pdf.internal.pageSize.getHeight()-20;if(ih<=ph){pdf.addImage(canvas.toDataURL('image/png'),'PNG',10,10,iw,ih);}else{let srcY=0;const srcH=canvas.width*(ph/iw);while(srcY<canvas.height){const pc=document.createElement('canvas');pc.width=canvas.width;pc.height=Math.min(srcH,canvas.height-srcY);pc.getContext('2d').drawImage(canvas,0,srcY,canvas.width,pc.height,0,0,pc.width,pc.height);if(srcY>0)pdf.addPage();pdf.addImage(pc.toDataURL('image/png'),'PNG',10,10,iw,pc.height*iw/pc.width);srcY+=srcH;}}pdf.save(name+'.pdf');}).catch(err=>{console.error(err);alert('PDF failed. Try again.');});}
function printDoc(){const el=document.getElementById('docPreview');if(!el)return;const w=window.open('','_blank');w.document.write('<html><head><title>Print</title></head><body style="font-family:system-ui;padding:20px">'+el.innerHTML+'</body></html>');w.document.close();w.focus();w.print();}

/* Auth */
function openAuth(){document.getElementById('authModal').classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function switchAuthTab(tab){const b=document.querySelectorAll('.tab-btns button');b.forEach(x=>x.classList.remove('active'));if(tab==='login'){b[0].classList.add('active');document.getElementById('loginForm').style.display='block';document.getElementById('registerForm').style.display='none';document.getElementById('authTitle').textContent='Sign In';}else{b[1].classList.add('active');document.getElementById('loginForm').style.display='none';document.getElementById('registerForm').style.display='block';document.getElementById('authTitle').textContent='Create Account';}}
async function doLogin(){const email=document.getElementById('loginEmail').value;const pass=document.getElementById('loginPass').value;const msg=document.getElementById('authMsg');if(!email||!pass){msg.textContent='Fill in all fields';return;}msg.textContent='Signing in...';msg.style.color='var(--pri)';const{error}=await sb.auth.signInWithPassword({email,password:pass});if(error){msg.textContent=error.message;msg.style.color='var(--danger)';return;}msg.textContent='Success!';msg.style.color='var(--success)';setTimeout(()=>closeModal('authModal'),500);}
async function doRegister(){const name=document.getElementById('regName').value;const email=document.getElementById('regEmail').value;const pass=document.getElementById('regPass').value;const msg=document.getElementById('authMsg');if(!name||!email||!pass){msg.textContent='Fill in all fields';return;}if(pass.length<6){msg.textContent='Password min 6 chars';return;}msg.textContent='Creating...';msg.style.color='var(--pri)';const{error}=await sb.auth.signUp({email,password:pass,options:{data:{full_name:name}}});if(error){msg.textContent=error.message;msg.style.color='var(--danger)';return;}msg.textContent='Account created!';msg.style.color='var(--success)';setTimeout(()=>closeModal('authModal'),500);}
sb.auth.onAuthStateChange((ev,session)=>{
  if(session&&session.user){
    currentUser=session.user;const meta=currentUser.user_metadata||{};const ini=(meta.full_name||currentUser.email||'U').substring(0,2).toUpperCase();
    document.getElementById('userMenu').innerHTML='<div class="avatar" onclick="toggleUserMenu()">'+ini+'</div><div class="user-dropdown" id="userDropdown"><a href="#" style="font-weight:700;color:var(--pri)">'+(meta.full_name||currentUser.email)+'</a>'+(isAdmin()?'<a href="#" style="color:var(--success)">★ Admin Access</a>':'<a href="#" onclick="openPricing()">Plan: '+userPlan.toUpperCase()+'</a>')+'<div class="divider"></div><a href="#" onclick="openSavedDocsModal()">📄 My Documents</a><a href="#" onclick="openPricing()">💳 Manage Plan</a><div class="divider"></div><a href="#" onclick="doLogout()">Sign Out</a></div>';
    if(isAdmin()){userPlan='business';}else{loadUserPlan();document.querySelectorAll('.email-banner').forEach(function(e){e.style.display='none';});}
    updatePlanBadge();
    document.getElementById('saveDocBtn').style.display=currentDoc?'inline-block':'none';
    // Load theme preference from profile
    sb.from('profiles').select('theme_preference').eq('id',currentUser.id).single().then(({data})=>{
      if(data&&data.theme_preference&&data.theme_preference!=='system'){
        localStorage.setItem('docpro_theme',data.theme_preference);
        applyColorTheme(data.theme_preference);
        updateThemeButtons(data.theme_preference);
      }
    });
  }else{
    currentUser=null;userPlan='free';
    document.getElementById('userMenu').innerHTML='<button class="btn btn-sm" onclick="openAuth()">Sign In</button>';
    updatePlanBadge();
    document.getElementById('saveDocBtn').style.display='none';
  }
});
function toggleUserMenu(){const d=document.getElementById('userDropdown');if(d)d.classList.toggle('show');}
document.addEventListener('click',e=>{const d=document.getElementById('userDropdown');if(d&&!e.target.closest('.user-menu'))d.classList.remove('show');});
async function doLogout(){await sb.auth.signOut();}
async function loadUserPlan(){if(!currentUser)return;try{const{data}=await sb.from('profiles').select('plan,role').eq('id',currentUser.id).single();if(data){userPlan=data.plan||'free';if(data.role==='admin'){currentUser.role='admin';userPlan='business';}}}catch(e){}updatePlanBadge();}
function updatePlanBadge(){const b=document.getElementById('planBadge');if(isAdmin()){b.textContent='ADMIN';b.className='badge badge-biz';}else if(userPlan==='business'){b.textContent='BUSINESS';b.className='badge badge-biz';}else if(userPlan==='pro'){b.textContent='PRO';b.className='badge badge-pro';}else{b.textContent='FREE PLAN';b.className='badge badge-free';}}
/* Pricing, Logo, Upload */
function openPricing(){document.getElementById('pricingModal').classList.add('show');}
async function selectPlan(plan){if(plan==='free'){closeModal('pricingModal');return;}if(!currentUser){closeModal('pricingModal');openAuth();return;}closeModal('pricingModal');try{const res=await fetch('/api/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan:plan,userId:currentUser.id,userEmail:currentUser.email})});const data=await res.json();if(data.url){window.location.href=data.url;}else{alert('Error creating checkout session. Please try again.');}}catch(err){console.error('Checkout error:',err);alert('Error connecting to payment service. Please try again.');}}
function openLogo(){document.getElementById('logoModal').classList.add('show');}
function searchLogos(){const q=document.getElementById('logoSearch').value.trim();const g=document.getElementById('logoGrid');if(!q){g.innerHTML='<p style="grid-column:span 3;text-align:center;color:var(--muted);font-size:12px">Type a company name</p>';return;}const urls=['https://logo.clearbit.com/'+q.toLowerCase().replace(/\s+/g,'')+'.com','https://logo.clearbit.com/'+q.toLowerCase().split(' ')[0]+'.com'];g.innerHTML=urls.map(u=>'<img src="'+u+'" onerror="this.style.display=\'none\'" onclick="selectLogo(\''+u+'\')">').join('')+'<p style="grid-column:span 3;font-size:11px;color:var(--muted);text-align:center">Click to use or create below</p>';}
function selectLogo(url){customLogo=url;if(updatePreviewFn)updatePreviewFn();closeModal('logoModal');}
function createLogo(){const text=document.getElementById('logoText').value||'Logo';const color=document.getElementById('logoColor').value;const shape=document.getElementById('logoShape').value;const c=document.createElement('canvas');c.width=200;c.height=80;const ctx=c.getContext('2d');const ini=text.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();if(shape==='text-only'){ctx.fillStyle=color;ctx.font='bold 36px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,100,40);}else{const r=shape==='circle'?30:shape==='rounded'?8:0;ctx.fillStyle=color;if(shape==='circle'){ctx.beginPath();ctx.arc(40,40,30,0,Math.PI*2);ctx.fill();}else{ctx.beginPath();ctx.roundRect(10,10,60,60,r);ctx.fill();}ctx.fillStyle='#fff';ctx.font='bold 24px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(ini,40,42);ctx.fillStyle=color;ctx.font='bold 18px system-ui';ctx.textAlign='left';ctx.textBaseline='middle';ctx.fillText(text,80,40);}customLogo=c.toDataURL();document.getElementById('logoPreview').innerHTML='<img src="'+customLogo+'" style="max-height:60px"><p style="font-size:11px;color:var(--success);margin-top:4px">Logo created!</p>';if(updatePreviewFn)updatePreviewFn();}
function openUpload(){document.getElementById('uploadModal').classList.add('show');}
function handleUpload(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(ev){const t=ev.target.result;const res=document.getElementById('uploadResult');try{if(f.name.endsWith('.json')){const d=JSON.parse(t);res.innerHTML='<p style="color:var(--success)">JSON parsed!</p><pre style="background:#f8fafc;padding:8px;border-radius:4px;font-size:11px;max-height:200px;overflow:auto">'+JSON.stringify(d,null,2).substring(0,500)+'</pre>';}else if(f.name.endsWith('.csv')){const l=t.split('\n').filter(x=>x.trim());res.innerHTML='<p style="color:var(--success)">CSV: '+l.length+' rows</p>';}else{res.innerHTML='<p style="color:var(--success)">Loaded: '+f.name+'</p>';}}catch(err){res.innerHTML='<p style="color:var(--danger)">Error: '+err.message+'</p>';}};r.readAsText(f);}
/* Hide email banner if already captured */
if(localStorage.getItem('docpro_email')){const ebs=document.querySelectorAll('.email-banner');ebs.forEach(function(eb){eb.innerHTML='<h4 style="margin:0">3 Pro Templates Unlocked!</h4><p style="margin:4px 0 0;opacity:.85">1099-B V11, V13 & V15 are now free. <a href="#" onclick="openAuth();return false" style="color:var(--pri)">Sign up</a> to keep them.</p>';});}
init();
</script>
<footer style="text-align:center;padding:18px 12px 14px;font-size:12px;color:var(--muted);border-top:1px solid var(--border);margin-top:32px;background:var(--bg)"><span style="opacity:.7">A product of <strong>Wmk Speciality Services L.L.C.</strong></span></footer>
</body>
</html>

<div class="logo-grid" id="logoGrid"></div>
<hr style="margin:16px 0"><h3 style="font-size:14px;margin-bottom:8px">Create Custom Logo</h3>
<input type="text" id="logoText" placeholder="Company Name" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;margin-bottom:8px;background:var(--bg);color:var(--text)">
<div style="display:flex;gap:8px;margin-bottom:8px">
<input type="color" id="logoColor" value="#2563eb" style="width:40px;height:36px;border:none;cursor:pointer">
<select id="logoShape" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--card);color:var(--text)"><option value="circle">Circle</option><option value="square">Square</option><option value="rounded">Rounded</option><option value="text-only">Text Only</option></select>
<button class="btn btn-pri" onclick="createLogo()">Create</button>
</div>
<div id="logoPreview" style="text-align:center;padding:16px"></div>
</div>
</div>
<div class="modal-overlay" id="uploadModal">
<div class="modal">
<button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
<h2>Upload Document</h2>
<p style="color:var(--muted);margin-bottom:16px;font-size:13px">Upload JSON, CSV, or TXT files</p>
<div style="border:2px dashed var(--border);border-radius:8px;padding:40px;text-align:center;cursor:pointer" onclick="document.getElementById('fileInput').click()">
<p style="color:var(--muted)">Click to upload or drag & drop</p>
<p style="font-size:11px;color:var(--muted);margin-top:4px">JSON, CSV, TXT</p>
</div>
<input type="file" id="fileInput" accept=".json,.csv,.txt" style="display:none" onchange="handleUpload(event)">
<div id="uploadResult" style="margin-top:12px"></div>
</div>
</div>
<div class="modal-overlay" id="savedDocsModal">
<div class="modal" style="max-width:560px">
<button class="modal-close" onclick="closeModal('savedDocsModal')">&times;</button>
<h2>My Saved Documents</h2>
<p style="color:var(--muted);margin-bottom:16px;font-size:13px">Your saved documents are stored securely in the cloud.</p>
<div id="savedDocsList" class="saved-docs-list"><p style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Loading...</p></div>
</div>
</div>
<script>
const SUPA_URL='https://mupeqeuuwdmkndvtbhzb.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
const POPULAR_NAMES=['Standard Invoice','Commercial Invoice','Freelance Invoice','Sales Receipt','Payment Receipt','Cover Letter','Resignation Letter','Recommendation Letter','Professional Resume','Employment Contract','Non-Disclosure Agreement','Service Agreement','Lease Agreement','W-9 Form','1099-NEC Form','Profit and Loss Statement','Power of Attorney','Last Will and Testament','Living Will','Purchase Agreement','Rental Application','Patient Intake Form','HIPAA Authorization','Auto Insurance Claim','Certificate of Completion','Business Plan','Bank Statement','Bill of Lading','Software Requirements Document','Offer Letter','Job Description','Performance Review'];
const SEO_CTX={'invoice':'An invoice is a commercial document sent by a seller to a buyer, detailing products or services provided and the amount owed. Use this template to create professional invoices for your business.','receipt':'A receipt is a written acknowledgment that payment has been received. This template helps you create professional receipts for any transaction.','letter':'A formal letter follows standard business formatting conventions. Use this template to create professional correspondence for any purpose.','memo':'A memorandum (memo) is an internal document used to communicate policies, procedures, or updates within an organization.','resume':'A resume is a document summarizing your professional experience, education, and skills. This template helps you create a polished resume that stands out.','contract':'A contract is a legally binding agreement between two or more parties. This template provides a professional framework for your agreement.','agreement':'An agreement outlines the terms and conditions accepted by all parties. Use this template to formalize any business arrangement.','tax':'Tax forms are official documents used to report income, calculate tax liability, and file returns with federal and state agencies.','legal':'Legal documents are formal papers used in court proceedings, estate planning, and official government matters.','real estate':'Real estate documents facilitate property transactions including buying, selling, leasing, and property management.','medical':'Medical documents are used in healthcare settings for patient care, record-keeping, and regulatory compliance.','insurance':'Insurance documents are used to file claims, apply for coverage, and manage policies across all types of insurance.','education':'Educational documents support teaching, learning, and academic administration from K-12 through higher education.','business':'Business documents support operations, planning, and management across all departments and functions.','banking':'Banking documents facilitate financial transactions, account management, and loan applications.','transport':'Transportation and logistics documents manage the movement of goods, including shipping, customs, and fleet management.','tech':'Technology documents support software development, IT operations, and technical project management.'};
let CATS=[];let currentCat=null;let currentTier='all';let currentDoc=null;let currentDocCat=null;let currentUser=null;let userPlan='free';let docPageSize=50;let docOffset=0;let totalFilteredDocs=0;let customLogo=null;let updatePreviewFn=null;

/* ========== COLOR THEME SYSTEM ========== */
function initTheme(){
  const saved=localStorage.getItem('docpro_theme')||'system';
  applyColorTheme(saved);
  updateThemeButtons(saved);
}
function setColorTheme(mode){
  localStorage.setItem('docpro_theme',mode);
  applyColorTheme(mode);
  updateThemeButtons(mode);
  // Save to profile if logged in
  if(currentUser){
    sb.from('profiles').update({theme_preference:mode}).eq('id',currentUser.id).then(()=>{});
  }
}
function applyColorTheme(mode){
  if(mode==='system'){
    const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme',prefersDark?'dark':'light');
  }else{
    document.documentElement.setAttribute('data-theme',mode);
  }
}
function updateThemeButtons(mode){
  document.getElementById('themeLight').classList.toggle('active',mode==='light');
  document.getElementById('themeDark').classList.toggle('active',mode==='dark');
  document.getElementById('themeSystem').classList.toggle('active',mode==='system');
}
// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{
  if(localStorage.getItem('docpro_theme')==='system')applyColorTheme('system');
});

/* ========== SAVE DOCUMENT SYSTEM ========== */
async function saveDocument(){
  if(!currentUser){openAuth();return;}
  if(!currentDoc){alert('Select a document first');return;}
  const fields={};
  document.querySelectorAll('#formFields input,#formFields textarea').forEach(el=>{
    if(el.id&&el.id.startsWith('field_'))fields[el.id.replace('field_','')]=el.value;
  });
  const theme=document.getElementById('themeSelect').value;
  try{
    // Check if already saved (upsert)
    const{data:existing}=await sb.from('saved_documents').select('id').eq('user_id',currentUser.id).eq('template_name',currentDoc.name).limit(1);
    if(existing&&existing.length>0){
      await sb.from('saved_documents').update({form_data:fields,theme,template_category:currentDocCat,updated_at:new Date().toISOString()}).eq('id',existing[0].id);
    }else{
      await sb.from('saved_documents').insert({user_id:currentUser.id,template_name:currentDoc.name,template_category:currentDocCat,form_data:fields,theme});
    }
    const ind=document.getElementById('saveIndicator');
    ind.classList.add('show');
    setTimeout(()=>ind.classList.remove('show'),2000);
  }catch(e){console.error('Save error:',e);alert('Failed to save. Try again.');}
}
async function loadSavedDocs(){
  if(!currentUser){document.getElementById('savedDocsList').innerHTML='<p style="color:var(--muted);text-align:center;padding:20px">Sign in to see your saved documents.</p>';return;}
  try{
    const{data,error}=await sb.from('saved_documents').select('*').eq('user_id',currentUser.id).order('updated_at',{ascending:false});
    const el=document.getElementById('savedDocsList');
    if(error||!data||data.length===0){el.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px">No saved documents yet. Open a template and click Save to get started.</p>';return;}
    el.innerHTML=data.map(d=>'<div class="saved-doc-item" onclick="openSavedDoc('+d.id+',\''+d.template_name.replace(/'/g,"\\\'")+'\',\''+d.template_category.replace(/'/g,"\\\'")+'\')"><div><strong>'+d.template_name+'</strong><div class="saved-meta">'+d.template_category+' • '+new Date(d.updated_at).toLocaleDateString()+'</div></div><span class="delete-saved" onclick="event.stopPropagation();deleteSavedDoc('+d.id+')" title="Delete">✕</span></div>').join('');
  }catch(e){console.error(e);document.getElementById('savedDocsList').innerHTML='<p style="color:var(--danger);text-align:center;padding:20px">Error loading documents.</p>';}
}
async function openSavedDoc(id,name,catName){
  closeModal('savedDocsModal');
  // Find template in CATS
  for(let ci=0;ci<CATS.length;ci++){
    for(let di=0;di<CATS[ci].docs.length;di++){
      if(CATS[ci].docs[di].name===name){
        currentDoc=CATS[ci].docs[di];currentDocCat=CATS[ci].n;
        document.getElementById('docTitle').textContent=name;
        document.getElementById('formPanel').style.display='block';
        history.replaceState(null,'','#'+slugify(name));
        document.title=name+' Template - Free Download | DraftMyForms';
        renderDoc(name,catName);
        // Load saved form data
        try{
          const{data}=await sb.from('saved_documents').select('form_data,theme').eq('id',id).single();
          if(data&&data.form_data){
            Object.entries(data.form_data).forEach(([k,v])=>{const el=document.getElementById('field_'+k);if(el)el.value=v;});
            if(data.theme){document.getElementById('themeSelect').value=data.theme;applyTheme();}
            else if(updatePreviewFn)updatePreviewFn();
          }
        }catch(e){console.error(e);}
        return;
      }
    }
  }
  alert('Template not found: '+name);
}
async function deleteSavedDoc(id){
  if(!confirm('Delete this saved document?'))return;
  try{await sb.from('saved_documents').delete().eq('id',id);loadSavedDocs();}catch(e){console.error(e);}
}
function openSavedDocsModal(){document.getElementById('savedDocsModal').classList.add('show');loadSavedDocs();}
/* ========== INIT & DATA ========== */
async function init(){
  initTheme();
  try{
    const all=await fetchAllTemplates();
    if(all.length>0){
      const catMap={};
      all.forEach(t=>{if(!catMap[t.category])catMap[t.category]={n:t.category,docs:[]};catMap[t.category].docs.push({name:t.name,tier:t.tier,fields:t.fields});});
      CATS=Object.values(catMap).sort((a,b)=>a.n.localeCompare(b.n));
      console.log('Loaded '+all.length+' templates in '+CATS.length+' categories');
      document.getElementById('templateCount').textContent=all.length.toLocaleString()+'+';
    }
  }catch(e){console.error(e);useFallback();}
  renderSidebar();buildWelcomeCats();handleHashRoute();
}
async function fetchAllTemplates(){
  let all=[],from=0;
  while(true){
    const{data,error}=await sb.from('templates').select('name,category,tier,fields').range(from,from+999).order('category').order('name');
    if(error||!data||data.length===0)break;
    all=all.concat(data);if(data.length<1000)break;from+=1000;
  }
  return all;
}
function useFallback(){
  const cats=['Invoices & Receipts','Letters & Memos','Resumes & Employment','Contracts & Agreements','Tax & Financial','Legal & Government','Real Estate & Property','Healthcare & Medical','Insurance & Claims','Education & Academic','Business Operations','Banking & Financial','Transportation & Logistics','Technology & IT'];
  const tiers=['free','free','free','pro','pro','business','pro','business','business','free','pro','pro','pro','pro'];
  CATS=cats.map((n,i)=>{const docs=[];for(let j=1;j<=8;j++)docs.push({name:n.split('&')[0].trim()+' Template '+j,tier:tiers[i]});return{n,docs};});
}
function buildWelcomeCats(){const el=document.getElementById('welcomeCats');if(el)el.innerHTML=CATS.map(c=>'<span>'+c.n+'</span>').join('');}
function handleHashRoute(){
  const h=window.location.hash;if(!h||h==='#')return;
  const slug=decodeURIComponent(h.substring(1));
  for(let ci=0;ci<CATS.length;ci++){for(let di=0;di<CATS[ci].docs.length;di++){
    if(slugify(CATS[ci].docs[di].name)===slug||CATS[ci].docs[di].name===slug){
      currentDoc=CATS[ci].docs[di];currentDocCat=CATS[ci].n;
      document.getElementById('docTitle').textContent=currentDoc.name;
      document.getElementById('formPanel').style.display='block';
      document.title=currentDoc.name+' Template - Free Download | DraftMyForms';
      const meta=document.querySelector('meta[name="description"]');
      if(meta)meta.content='Free '+currentDoc.name+' template. Fill out, customize, and download as PDF instantly. Professional '+CATS[ci].n.toLowerCase()+' document generator.';
      renderDoc(currentDoc.name,currentDocCat);return;
    }
  }}
}
function slugify(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');}
window.addEventListener('hashchange',handleHashRoute);

/* ========== SIDEBAR ========== */
function renderSidebar(){
  const grid=document.getElementById('catGrid');
  grid.innerHTML=CATS.map((c,i)=>'<div class="cat-btn'+(currentCat===i?' active':'')+'" onclick="selectCat('+i+')">'+c.n.split('&')[0].trim()+'</div>').join('');
  docOffset=0;renderDocList();
}
function selectCat(i){currentCat=currentCat===i?null:i;document.querySelectorAll('.cat-btn').forEach((b,idx)=>b.classList.toggle('active',idx===i&&currentCat!==null));if(currentCat===null)document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));docOffset=0;renderDocList();}
function setTier(t){currentTier=t;document.querySelectorAll('.tier-btn').forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase()===t||b.textContent.toLowerCase()==='biz'&&t==='business'));docOffset=0;renderDocList();}
function getFilteredDocs(){
  const q=document.getElementById('searchBox').value.toLowerCase();let docs=[];
  CATS.forEach((c,ci)=>{if(currentCat!==null&&currentCat!==ci)return;
    c.docs.forEach(d=>{if(currentTier!=='all'&&d.tier!==currentTier)return;if(q&&!d.name.toLowerCase().includes(q)&&!c.n.toLowerCase().includes(q))return;docs.push({...d,catIdx:ci,catName:c.n});});
  });return docs;
}
function sortDocs(docs){
  const mode=document.getElementById('sortSelect').value;
  if(mode==='popular'){const popSet=new Set(POPULAR_NAMES.map(n=>n.toLowerCase()));docs.sort((a,b)=>{const ap=popSet.has(a.name.toLowerCase())?0:1;const bp=popSet.has(b.name.toLowerCase())?0:1;if(ap!==bp)return ap-bp;if(ap===0&&bp===0){const ai=POPULAR_NAMES.findIndex(p=>p.toLowerCase()===a.name.toLowerCase());const bi=POPULAR_NAMES.findIndex(p=>p.toLowerCase()===b.name.toLowerCase());return ai-bi;}return a.name.localeCompare(b.name);});}
  else if(mode==='free-first'){const tierOrder={free:0,pro:1,business:2};docs.sort((a,b)=>(tierOrder[a.tier]||0)-(tierOrder[b.tier]||0)||a.name.localeCompare(b.name));}
  else if(mode==='newest'){docs.reverse();}
  else{docs.sort((a,b)=>a.name.localeCompare(b.name));}
  return docs;
}
function renderDocList(){
  let docs=sortDocs(getFilteredDocs());totalFilteredDocs=docs.length;
  const page=docs.slice(0,docOffset+docPageSize);
  const list=document.getElementById('docList');
  list.innerHTML=page.map((d,i)=>'<li class="doc-item'+(currentDoc&&d.name===currentDoc.name?' active':'')+'" onclick="openDoc('+i+')" data-idx="'+i+'"><span>'+d.name+'</span><span class="doc-tier '+d.tier+'">'+d.tier+'</span></li>').join('');
  document.getElementById('docCount').textContent=totalFilteredDocs.toLocaleString()+' templates';
  document.getElementById('loadMoreBtn').style.display=page.length<totalFilteredDocs?'block':'none';
}
function loadMoreDocs(){docOffset+=docPageSize;renderDocList();}
function filterDocs(){docOffset=0;renderDocList();}

/* ========== DOC OPEN ========== */
function openDoc(listIdx){
  const docs=sortDocs(getFilteredDocs());const d=docs[listIdx];if(!d)return;
  if(!canAccess(d.tier)){openPricing();return;}
  currentDoc=d;currentDocCat=d.catName;
  document.getElementById('docTitle').textContent=d.name;
  document.getElementById('formPanel').style.display='block';
  // Show save button if logged in
  document.getElementById('saveDocBtn').style.display=currentUser?'inline-block':'none';
  document.querySelectorAll('.doc-item').forEach((el,i)=>el.classList.toggle('active',i===listIdx));
  history.replaceState(null,'','#'+slugify(d.name));
  document.title=d.name+' Template - Free Download | DraftMyForms';
  renderDoc(d.name,d.catName);showSeoContext(d.name,d.catName);
}
function showSeoContext(name,catName){
  const el=document.getElementById('seoContext');const nm=name.toLowerCase();const cn=catName.toLowerCase();let ctx='';
  for(const[key,val]of Object.entries(SEO_CTX)){if(nm.includes(key)||cn.includes(key)){ctx=val;break;}}
  if(ctx){el.innerHTML='<h4>About This '+name+' Template</h4><p>'+ctx+' Customize the fields on the left, choose from 6 professional themes, and download your completed document as a PDF. All free templates require no sign-up.</p>';el.style.display='block';}else{el.style.display='none';}
}
function canAccess(tier){if(isAdmin())return true;if(tier==='free')return true;if(tier==='pro'){if(userPlan==='pro'||userPlan==='business')return true;var fpt=JSON.parse(localStorage.getItem('docpro_free_pro_templates')||'[]');if(currentDoc&&fpt.indexOf(currentDoc.name)>-1)return true;}if(tier==='business'&&userPlan==='business')return true;return false;}
function isAdmin(){return currentUser&&currentUser.email&&(currentUser.email==='admin@docpro.com'||currentUser.email==='larrywomack40@gmail.com'||currentUser.role==='admin');}
function captureEmail(e){e.preventDefault();const email=document.getElementById('captureEmailInput').value;if(!email)return;try{sb.from('email_leads').insert({email,source:'sidebar_banner'});}catch(ex){}localStorage.setItem('docpro_email',email);localStorage.setItem('docpro_free_pro_templates',JSON.stringify(['1099-B Form V11','1099-B Form V13','1099-B Form V15']));const banners=document.querySelectorAll('.email-banner');banners.forEach(function(eb){eb.innerHTML='<h4 style="margin:0">3 Pro Templates Unlocked!</h4><p style="margin:4px 0 0;opacity:.85">1099-B V11, V13 & V15 are now free for you.</p>';});setTimeout(function(){openAuth();},1500);}
/* ========== RENDERERS ========== */
function renderDoc(name,catName){
  const cn=catName.toLowerCase();const nm=name.toLowerCase();let r;
  if(cn.includes('invoice')||cn.includes('receipt'))r=renderInvoiceReceipt;
  else if(cn.includes('letter')||cn.includes('memo'))r=renderLetterMemo;
  else if(cn.includes('resume')||cn.includes('employment'))r=renderResumeEmployment;
  else if(cn.includes('contract')||cn.includes('agreement'))r=renderContract;
  else if(cn.includes('tax')||cn.includes('financial')&&!cn.includes('bank'))r=renderTaxFinancial;
  else if(cn.includes('legal')||cn.includes('government'))r=renderLegalGov;
  else if(cn.includes('real estate')||cn.includes('property'))r=renderRealEstate;
  else if(cn.includes('health')||cn.includes('medical'))r=renderHealthcare;
  else if(cn.includes('insurance')||cn.includes('claim'))r=renderInsurance;
  else if(cn.includes('education')||cn.includes('academic'))r=renderEducation;
  else if(cn.includes('business')||cn.includes('operation'))r=renderBusiness;
  else if(cn.includes('banking'))r=renderBanking;
  else if(cn.includes('transport')||cn.includes('logistics'))r=renderTransport;
  else if(cn.includes('tech')||cn.includes(' it'))r=renderTechIT;
  else{if(nm.includes('invoice')||nm.includes('receipt'))r=renderInvoiceReceipt;else if(nm.includes('letter')||nm.includes('memo'))r=renderLetterMemo;else if(nm.includes('resume'))r=renderResumeEmployment;else if(nm.includes('contract')||nm.includes('agreement'))r=renderContract;else r=renderGenericDoc;}
  r(name);
}
function getThemeStyles(){
  const t=document.getElementById('themeSelect').value;
  const themes={modern:{primary:'#2563eb',font:'system-ui,sans-serif',border:'2px solid #2563eb',headerBg:'#2563eb',headerColor:'#fff',radius:'8px'},classic:{primary:'#1a1a1a',font:'Georgia,serif',border:'1px solid #333',headerBg:'#1a1a1a',headerColor:'#fff',radius:'0'},elegant:{primary:'#7c3aed',font:"'Palatino Linotype',serif",border:'1px solid #7c3aed',headerBg:'linear-gradient(135deg,#7c3aed,#a855f7)',headerColor:'#fff',radius:'12px'},corporate:{primary:'#0f172a',font:"'Segoe UI',sans-serif",border:'2px solid #0f172a',headerBg:'#0f172a',headerColor:'#f8fafc',radius:'4px'},minimal:{primary:'#64748b',font:'Inter,sans-serif',border:'1px solid #e2e8f0',headerBg:'#f8fafc',headerColor:'#1e293b',radius:'6px'},bold:{primary:'#dc2626',font:'Impact,sans-serif',border:'3px solid #dc2626',headerBg:'#dc2626',headerColor:'#fff',radius:'0'}};
  return themes[t]||themes.modern;
}
function applyTheme(){if(currentDoc)renderDoc(currentDoc.name,currentDocCat);}
function logoHTML(){return customLogo?'<img src="'+customLogo+'" style="max-height:50px;max-width:150px" alt="Logo">':'';}
function renderInvoiceReceipt(name){
  const s=getThemeStyles();const isR=name.toLowerCase().includes('receipt');
  const fields=isR?[{id:'from',label:'From',ph:'Your Company'},{id:'to',label:'To',ph:'Client'},{id:'rnum',label:'Receipt #',ph:'R-001'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'amount',label:'Amount',ph:'$0.00'},{id:'method',label:'Payment Method',ph:'Cash/Card'},{id:'desc',label:'Description',ph:'Payment for...'},{id:'notes',label:'Notes',ph:'Notes...',type:'textarea'}]:[{id:'company',label:'Company',ph:'Your Co.'},{id:'client',label:'Client',ph:'Client Co.'},{id:'invnum',label:'Invoice #',ph:'INV-001'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'due',label:'Due Date',ph:'MM/DD/YYYY'},{id:'item1',label:'Item 1',ph:'Service'},{id:'qty1',label:'Qty',ph:'1'},{id:'rate1',label:'Rate',ph:'$0'},{id:'item2',label:'Item 2',ph:''},{id:'qty2',label:'Qty',ph:'1'},{id:'rate2',label:'Rate',ph:'$0'},{id:'tax',label:'Tax %',ph:'0'},{id:'notes',label:'Notes',ph:'Terms...',type:'textarea'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);const logo=logoHTML();
  if(isR){document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto"><div style="display:flex;justify-content:space-between;margin-bottom:20px"><div>'+logo+'<h1 style="color:'+s.primary+';font-size:28px;margin-top:8px">RECEIPT</h1><p style="color:#64748b;font-size:12px">'+name+'</p></div><div style="text-align:right"><strong>#'+(v.rnum||'___')+'</strong><br><span style="color:#64748b;font-size:12px">'+(v.date||'___')+'</span></div></div><div style="display:flex;justify-content:space-between;border-top:'+s.border+';padding-top:16px;margin-bottom:16px"><div><strong>From:</strong> '+(v.from||'___')+'</div><div><strong>To:</strong> '+(v.to||'___')+'</div></div><table style="width:100%;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Description</th><th style="padding:10px;text-align:right">Method</th><th style="padding:10px;text-align:right">Amount</th></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+(v.desc||'Payment')+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">'+(v.method||'—')+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;font-weight:700">'+(v.amount||'$0.00')+'</td></tr></table><div style="text-align:right;font-size:20px;font-weight:800;color:'+s.primary+';margin:16px 0">Total: '+(v.amount||'$0.00')+'</div>'+(v.notes?'<div style="background:#f8fafc;padding:12px;border-radius:6px;font-size:12px;color:#64748b"><strong>Notes:</strong> '+v.notes+'</div>':'')+'</div>';}
  else{const q1=parseFloat(v.qty1)||1,r1=parseFloat(v.rate1)||0,q2=parseFloat(v.qty2)||0,r2=parseFloat(v.rate2)||0;const sub=q1*r1+q2*r2,tax=sub*(parseFloat(v.tax)||0)/100,total=sub+tax;document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto"><div style="display:flex;justify-content:space-between;margin-bottom:24px"><div>'+logo+'<h1 style="color:'+s.primary+';font-size:30px;margin-top:8px">INVOICE</h1><p style="color:#64748b;font-size:12px">'+name+'</p></div><div style="text-align:right"><strong>'+(v.company||'Company')+'</strong><br><span style="color:#64748b;font-size:12px">#'+(v.invnum||'___')+' | '+(v.date||'_/_/_')+'</span></div></div><hr style="border:none;border-top:'+s.border+'"><div style="display:flex;justify-content:space-between;margin:20px 0"><div><strong>BILL TO</strong><br>'+(v.client||'___')+'</div><div style="text-align:right"><strong>DUE</strong><br>'+(v.due||'___')+'</div></div><table style="width:100%;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Description</th><th style="padding:10px;text-align:center">Qty</th><th style="padding:10px;text-align:right">Rate</th><th style="padding:10px;text-align:right">Amount</th></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+(v.item1||'Service')+'</td><td style="padding:10px;text-align:center;border-bottom:1px solid #e2e8f0">'+q1+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+r1.toFixed(2)+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+(q1*r1).toFixed(2)+'</td></tr>'+(v.item2?'<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+v.item2+'</td><td style="padding:10px;text-align:center;border-bottom:1px solid #e2e8f0">'+q2+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+r2.toFixed(2)+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+(q2*r2).toFixed(2)+'</td></tr>':'')+'</table><div style="text-align:right;margin-top:16px"><p>Subtotal: $'+sub.toFixed(2)+'</p><p>Tax: $'+tax.toFixed(2)+'</p><p style="font-size:22px;font-weight:800;color:'+s.primary+';margin-top:8px">Total: $'+total.toFixed(2)+'</p></div>'+(v.notes?'<div style="background:#f8fafc;padding:12px;border-radius:6px;font-size:12px;color:#64748b;margin-top:16px"><strong>Notes:</strong> '+v.notes+'</div>':'')+'</div>';}
  };updatePreviewFn();
  }
function renderLetterMemo(name){
  const s=getThemeStyles();const isM=name.toLowerCase().includes('memo');
  const fields=isM?[{id:'from',label:'From',ph:'Your Name'},{id:'to',label:'To',ph:'Recipient'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'subject',label:'Subject',ph:'Subject'},{id:'body',label:'Body',ph:'Content...',type:'textarea'},{id:'actions',label:'Action Items',ph:'Actions...',type:'textarea'}]:[{id:'from',label:'From',ph:'Your Name'},{id:'address',label:'Address',ph:'123 Main St'},{id:'to',label:'To',ph:'Recipient'},{id:'toaddr',label:'To Address',ph:'456 Oak Ave'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'subject',label:'Subject',ph:'Re: Subject'},{id:'body',label:'Body',ph:'Dear...',type:'textarea'},{id:'closing',label:'Closing',ph:'Sincerely'},{id:'sig',label:'Signature',ph:'Your Name'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);const logo=logoHTML();
  if(isM){document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logo+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+' '+s.radius+' 0 0;margin-top:12px"><h1 style="font-size:20px">MEMORANDUM</h1></div><div style="border:'+s.border+';border-top:none;padding:20px;border-radius:0 0 '+s.radius+' '+s.radius+'"><table style="width:100%;font-size:13px;margin-bottom:16px"><tr><td style="padding:4px 0;width:70px;font-weight:700">TO:</td><td>'+(v.to||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">FROM:</td><td>'+(v.from||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">DATE:</td><td>'+(v.date||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">RE:</td><td style="font-weight:700">'+(v.subject||'_____')+'</td></tr></table><hr style="border:none;border-top:2px solid '+s.primary+';margin:16px 0"><div style="font-size:14px;line-height:1.6;white-space:pre-wrap">'+(v.body||'Content...')+'</div>'+(v.actions?'<div style="margin-top:20px;background:#f8fafc;padding:12px;border-radius:6px;border-left:4px solid '+s.primary+'"><strong>Action Items:</strong><div style="margin-top:6px;font-size:13px;white-space:pre-wrap">'+v.actions+'</div></div>':'')+'</div></div>';}
  else{document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logo+'<div style="margin:12px 0 24px"><strong>'+(v.from||'Your Name')+'</strong><br><span style="color:#64748b;font-size:13px">'+(v.address||'Address')+'</span></div><div style="margin-bottom:24px;color:#64748b;font-size:13px">'+(v.date||'Date')+'</div><div style="margin-bottom:24px"><strong>'+(v.to||'Recipient')+'</strong><br><span style="color:#64748b;font-size:13px">'+(v.toaddr||'Address')+'</span></div><div style="margin-bottom:16px"><strong>Re: '+(v.subject||'Subject')+'</strong></div><div style="font-size:14px;line-height:1.8;white-space:pre-wrap">'+(v.body||'Dear Sir/Madam,\n\nI am writing to...')+'</div><div style="margin-top:32px"><p>'+(v.closing||'Sincerely')+'</p><p style="margin-top:24px;font-weight:700;border-top:1px solid #333;display:inline-block;padding-top:4px">'+(v.sig||'Signature')+'</p></div></div>';}
  };updatePreviewFn();
}
function renderResumeEmployment(name){
  const s=getThemeStyles();const isR=name.toLowerCase().includes('resume')||name.toLowerCase().includes('cv');
  const fields=isR?[{id:'name',label:'Full Name',ph:'John Smith'},{id:'email',label:'Email',ph:'john@email.com'},{id:'phone',label:'Phone',ph:'(555)123-4567'},{id:'loc',label:'Location',ph:'City, State'},{id:'summary',label:'Summary',ph:'Experienced...',type:'textarea'},{id:'exp',label:'Experience',ph:'Company - Title\nDetails...',type:'textarea'},{id:'edu',label:'Education',ph:'Degree - School',type:'textarea'},{id:'skills',label:'Skills',ph:'Skill 1, Skill 2'}]:[{id:'emp',label:'Employee',ph:'John Smith'},{id:'co',label:'Company',ph:'Acme Corp'},{id:'pos',label:'Position',ph:'Engineer'},{id:'dept',label:'Department',ph:'Engineering'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'mgr',label:'Manager',ph:'Jane Doe'},{id:'details',label:'Details',ph:'Details...',type:'textarea'},{id:'sig',label:'Signature',ph:'Authorized'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);
  if(isR){document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto"><div style="text-align:center;padding:20px;background:'+s.headerBg+';color:'+s.headerColor+';border-radius:'+s.radius+'"><h1 style="font-size:26px;letter-spacing:2px">'+(v.name||'YOUR NAME')+'</h1><p style="margin-top:6px;font-size:13px;opacity:.9">'+(v.email||'')+' | '+(v.phone||'')+' | '+(v.loc||'')+'</p></div>'+(v.summary?'<div style="margin:20px 0"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">SUMMARY</h3><p style="font-size:13px;line-height:1.6">'+v.summary+'</p></div>':'')+(v.exp?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">EXPERIENCE</h3><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+v.exp+'</div></div>':'')+(v.edu?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">EDUCATION</h3><div style="font-size:13px;white-space:pre-wrap">'+v.edu+'</div></div>':'')+(v.skills?'<div><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">SKILLS</h3><div style="display:flex;flex-wrap:wrap;gap:6px">'+v.skills.split(',').map(sk=>'<span style="background:#eff6ff;color:'+s.primary+';padding:4px 10px;border-radius:12px;font-size:12px">'+sk.trim()+'</span>').join('')+'</div></div>':'')+'</div>';}
  else{document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logoHTML()+'<h1 style="color:'+s.primary+';font-size:20px;text-align:center;margin:12px 0 4px">'+name+'</h1><p style="text-align:center;color:#64748b;font-size:12px;margin-bottom:20px">'+(v.co||'Company')+'</p><table style="width:100%;font-size:13px;border-collapse:collapse"><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:35%">Employee</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.emp||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Position</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.pos||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Department</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.dept||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Manager</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.mgr||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Date</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.date||'_____')+'</td></tr></table><div style="font-size:14px;line-height:1.6;white-space:pre-wrap;margin:20px 0">'+(v.details||'Details...')+'</div><div style="margin-top:30px;display:flex;justify-content:space-between"><div style="text-align:center;border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.sig||'Signature')+'</div><div style="text-align:center;border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">Employee</div></div></div>';}
  };updatePreviewFn();
}
function renderContract(name){
  const s=getThemeStyles();
  const fields=[{id:'a',label:'Party A',ph:'Company A'},{id:'b',label:'Party B',ph:'Company B'},{id:'date',label:'Effective Date',ph:'MM/DD/YYYY'},{id:'term',label:'Term',ph:'12 months'},{id:'scope',label:'Scope',ph:'This covers...',type:'textarea'},{id:'pay',label:'Payment Terms',ph:'$X/month',type:'textarea'},{id:'end',label:'Termination',ph:'Either party may...',type:'textarea'},{id:'law',label:'Governing Law',ph:'State of...'}];
  renderFormFields(fields);
  updatePreviewFn=()=>{const v=getFieldValues(fields);document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto">'+logoHTML()+'<h1 style="text-align:center;color:'+s.primary+';font-size:22px;margin:16px 0 4px">'+name.toUpperCase()+'</h1><p style="text-align:center;color:#64748b;font-size:12px;margin-bottom:24px">Effective: '+(v.date||'_____')+'</p><div style="font-size:13px;line-height:1.8"><p>This Agreement is entered into by:</p><div style="background:#f8fafc;padding:12px;border-radius:6px;margin:12px 0;border-left:4px solid '+s.primary+'"><strong>Party A:</strong> '+(v.a||'_____')+'<br><strong>Party B:</strong> '+(v.b||'_____')+'</div><h3 style="color:'+s.primary+';margin-top:20px">1. TERM</h3><p>Period: <strong>'+(v.term||'_____')+'</strong></p><h3 style="color:'+s.primary+';margin-top:16px">2. SCOPE</h3><p style="white-space:pre-wrap">'+(v.scope||'...')+'</p><h3 style="color:'+s.primary+';margin-top:16px">3. PAYMENT</h3><p style="white-space:pre-wrap">'+(v.pay||'...')+'</p><h3 style="color:'+s.primary+';margin-top:16px">4. TERMINATION</h3><p style="white-space:pre-wrap">'+(v.end||'...')+'</p><h3 style="color:'+s.primary+';margin-top:16px">5. GOVERNING LAW</h3><p>Governed by laws of <strong>'+(v.law||'_____')+'</strong></p><div style="margin-top:40px;display:flex;justify-content:space-between"><div><strong>Party A:</strong><br><br><div style="border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.a||'Signature')+'</div></div><div><strong>Party B:</strong><br><br><div style="border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.b||'Signature')+'</div></div></div></div></div>';};updatePreviewFn();
  }
function renderTaxFinancial(name){const s=getThemeStyles();const fields=[{id:'n',label:'Taxpayer/Company',ph:'Full Name'},{id:'ein',label:'SSN/EIN',ph:'XX-XXXXXXX'},{id:'year',label:'Year',ph:'2025'},{id:'status',label:'Status',ph:'Single/Married'},{id:'inc',label:'Income',ph:'$0.00'},{id:'ded',label:'Deductions',ph:'$0.00'},{id:'cred',label:'Credits',ph:'$0.00'},{id:'due',label:'Tax Due',ph:'$0.00'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'sig',label:'Signature',ph:'Taxpayer'}];renderFormFields(fields);updatePreviewFn=()=>{const v=getFieldValues(fields);document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto">'+logoHTML()+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+';margin-top:12px;text-align:center"><h1 style="font-size:18px">'+name.toUpperCase()+'</h1><p style="font-size:11px;opacity:.8">Tax Year: '+(v.year||'____')+'</p></div><div style="padding:20px;border:'+s.border+';border-top:none;border-radius:0 0 '+s.radius+' '+s.radius+'"><table style="width:100%;font-size:13px;border-collapse:collapse;margin-bottom:20px"><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:40%">Name</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.n||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">SSN/EIN</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.ein||'_____')+'</td></tr><tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Status</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.status||'_____')+'</td></tr></table><table style="width:100%;font-size:13px;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Item</th><th style="padding:10px;text-align:right">Amount</th></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Income</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">'+(v.inc||'$0')+'</td></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Deductions</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;color:#dc2626">-'+(v.ded||'$0')+'</td></tr><tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Credits</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;color:#16a34a">-'+(v.cred||'$0')+'</td></tr><tr style="font-weight:700"><td style="padding:10px;border-top:2px solid '+s.primary+'">Tax Due</td><td style="padding:10px;text-align:right;border-top:2px solid '+s.primary+';color:'+s.primary+';font-size:18px">'+(v.due||'$0')+'</td></tr></table><div style="margin-top:30px;display:flex;justify-content:space-between"><div style="font-size:12px;color:#64748b">Date: '+(v.date||'_____')+'</div><div style="text-align:center;border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">'+(v.sig||'Signature')+'</div></div></div></div>';};updatePreviewFn();}
function renderGenericDoc(name){const s=getThemeStyles();const fields=[{id:'title',label:'Title',ph:name},{id:'from',label:'From',ph:'Name'},{id:'to',label:'To',ph:'Recipient'},{id:'date',label:'Date',ph:'MM/DD/YYYY'},{id:'ref',label:'Ref #',ph:'REF-001'},{id:'body',label:'Content',ph:'...',type:'textarea'},{id:'sig',label:'Signature',ph:'Authorized'}];renderFormFields(fields);updatePreviewFn=()=>{const v=getFieldValues(fields);document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:600px;margin:auto">'+logoHTML()+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px;border-radius:'+s.radius+';margin-top:12px;text-align:center"><h1 style="font-size:18px">'+(v.title||name).toUpperCase()+'</h1></div><div style="padding:20px;border:'+s.border+';border-top:none;border-radius:0 0 '+s.radius+' '+s.radius+'"><div style="display:flex;justify-content:space-between;margin-bottom:16px;font-size:13px"><div><strong>From:</strong> '+(v.from||'_____')+'</div><div><strong>To:</strong> '+(v.to||'_____')+'</div></div><div style="display:flex;justify-content:space-between;margin-bottom:20px;font-size:13px"><div><strong>Date:</strong> '+(v.date||'_____')+'</div><div><strong>Ref:</strong> '+(v.ref||'_____')+'</div></div><hr style="margin-bottom:20px;border-color:#e2e8f0"><div style="font-size:14px;line-height:1.8;white-space:pre-wrap">'+(v.body||'...')+'</div><div style="margin-top:40px;text-align:right;border-top:1px solid #333;display:inline-block;width:180px;padding-top:4px;font-size:11px;float:right">'+(v.sig||'Signature')+'</div></div></div>';};updatePreviewFn();}
/* Category renderers */
function renderLegalGov(n){renderCatDoc(n,'LEGAL DOCUMENT','Case #','Court','State','Jurisdiction','Filed By','Description','Terms','Witness/Notary');}
function renderRealEstate(n){renderCatDoc(n,'REAL ESTATE','Property Address','Buyer','Seller','Price','Agent','Description','Terms','Closing Date');}
function renderHealthcare(n){renderCatDoc(n,'MEDICAL DOCUMENT','Patient Name','DOB','MRN','Provider','Facility','Diagnosis','Treatment','Follow-Up');}
function renderInsurance(n){renderCatDoc(n,'INSURANCE','Policy #','Insured Name','Date of Loss','Claim #','Adjuster','Description','Amount','Status');}
function renderEducation(n){renderCatDoc(n,'ACADEMIC','School','Student','Teacher','Grade','Subject','Date','Description','Score');}
function renderBusiness(n){renderCatDoc(n,'BUSINESS','Company','Department','Author','Date','Version','Description','Status','Approver');}
function renderBanking(n){renderCatDoc(n,'BANKING','Account Holder','Account #','Bank','Date','Amount','Description','Reference','Branch');}
function renderTransport(n){renderCatDoc(n,'SHIPPING/LOGISTICS','Shipper','Consignee','Carrier','Origin','Destination','Date','Weight','Tracking #');}
function renderTechIT(n){renderCatDoc(n,'TECHNICAL','Project','Author','Version','Date','Status','Description','Reviewer','Approval');}
function renderCatDoc(name,header,l1,l2,l3,l4,l5,l6,l7,l8){const s=getThemeStyles();const fields=[{id:'f1',label:l1,ph:l1},{id:'f2',label:l2,ph:l2},{id:'f3',label:l3,ph:l3},{id:'f4',label:l4,ph:l4},{id:'f5',label:l5,ph:l5},{id:'f6',label:l6,ph:l6,type:'textarea'},{id:'f7',label:l7,ph:l7,type:'textarea'},{id:'f8',label:l8,ph:l8}];renderFormFields(fields);updatePreviewFn=()=>{const v=getFieldValues(fields);let rows=fields.map(f=>'<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:35%">'+f.label+'</td><td style="padding:8px;border:1px solid #e2e8f0;white-space:pre-wrap">'+(v[f.id]||'_____')+'</td></tr>').join('');document.getElementById('docPreview').innerHTML='<div style="font-family:'+s.font+';max-width:650px;margin:auto">'+logoHTML()+'<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px;border-radius:'+s.radius+';margin:12px 0;text-align:center"><h1 style="font-size:16px">'+header+'</h1><p style="font-size:11px;opacity:.8">'+name+'</p></div><table style="width:100%;font-size:13px;border-collapse:collapse">'+rows+'</table><div style="margin-top:30px;display:flex;justify-content:space-between"><div style="text-align:center;border-top:1px solid #333;width:170px;padding-top:4px;font-size:11px">Authorized Signature</div><div style="text-align:center;border-top:1px solid #333;width:170px;padding-top:4px;font-size:11px">Date</div></div></div>';};updatePreviewFn();}
/* Form helpers */
function renderFormFields(fields){const fp=document.getElementById('formFields');let h='<h3>'+((currentDoc&&currentDoc.name)||'Document')+'</h3>';for(let i=0;i<fields.length;i+=2){h+='<div class="form-row">'+fieldHTML(fields[i]);if(fields[i+1])h+=fieldHTML(fields[i+1]);h+='</div>';}fp.innerHTML=h;fp.querySelectorAll('input,textarea').forEach(el=>el.addEventListener('input',()=>{if(updatePreviewFn)updatePreviewFn();}));}
function fieldHTML(f){return f.type==='textarea'?'<div class="form-field"><label>'+f.label+'</label><textarea id="field_'+f.id+'" placeholder="'+f.ph+'"></textarea></div>':'<div class="form-field"><label>'+f.label+'</label><input id="field_'+f.id+'" placeholder="'+f.ph+'"></div>';}
function getFieldValues(fields){const v={};fields.forEach(f=>{const el=document.getElementById('field_'+f.id);v[f.id]=el?el.value:'';});return v;}
function resetForm(){document.querySelectorAll('#formFields input,#formFields textarea').forEach(el=>el.value='');if(updatePreviewFn)updatePreviewFn();}

/* PDF & Print */
function generatePDF(){const el=document.getElementById('docPreview');if(!el||!el.innerHTML.trim()||el.querySelector('.welcome')){alert('Select a document first');return;}const name=(currentDoc?currentDoc.name:'Document')+'_DraftMyForms';html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#fff'}).then(canvas=>{const{jsPDF}=window.jspdf;const pdf=new jsPDF('p','mm','a4');const iw=pdf.internal.pageSize.getWidth()-20;const ih=canvas.height*iw/canvas.width;let ph=pdf.internal.pageSize.getHeight()-20;if(ih<=ph){pdf.addImage(canvas.toDataURL('image/png'),'PNG',10,10,iw,ih);}else{let srcY=0;const srcH=canvas.width*(ph/iw);while(srcY<canvas.height){const pc=document.createElement('canvas');pc.width=canvas.width;pc.height=Math.min(srcH,canvas.height-srcY);pc.getContext('2d').drawImage(canvas,0,srcY,canvas.width,pc.height,0,0,pc.width,pc.height);if(srcY>0)pdf.addPage();pdf.addImage(pc.toDataURL('image/png'),'PNG',10,10,iw,pc.height*iw/pc.width);srcY+=srcH;}}pdf.save(name+'.pdf');}).catch(err=>{console.error(err);alert('PDF failed. Try again.');});}
function printDoc(){const el=document.getElementById('docPreview');if(!el)return;const w=window.open('','_blank');w.document.write('<html><head><title>Print</title></head><body style="font-family:system-ui;padding:20px">'+el.innerHTML+'</body></html>');w.document.close();w.focus();w.print();}

/* Auth */
function openAuth(){document.getElementById('authModal').classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function switchAuthTab(tab){const b=document.querySelectorAll('.tab-btns button');b.forEach(x=>x.classList.remove('active'));if(tab==='login'){b[0].classList.add('active');document.getElementById('loginForm').style.display='block';document.getElementById('registerForm').style.display='none';document.getElementById('authTitle').textContent='Sign In';}else{b[1].classList.add('active');document.getElementById('loginForm').style.display='none';document.getElementById('registerForm').style.display='block';document.getElementById('authTitle').textContent='Create Account';}}
async function doLogin(){const email=document.getElementById('loginEmail').value;const pass=document.getElementById('loginPass').value;const msg=document.getElementById('authMsg');if(!email||!pass){msg.textContent='Fill in all fields';return;}msg.textContent='Signing in...';msg.style.color='var(--pri)';const{error}=await sb.auth.signInWithPassword({email,password:pass});if(error){msg.textContent=error.message;msg.style.color='var(--danger)';return;}msg.textContent='Success!';msg.style.color='var(--success)';setTimeout(()=>closeModal('authModal'),500);}
async function doRegister(){const name=document.getElementById('regName').value;const email=document.getElementById('regEmail').value;const pass=document.getElementById('regPass').value;const msg=document.getElementById('authMsg');if(!name||!email||!pass){msg.textContent='Fill in all fields';return;}if(pass.length<6){msg.textContent='Password min 6 chars';return;}msg.textContent='Creating...';msg.style.color='var(--pri)';const{error}=await sb.auth.signUp({email,password:pass,options:{data:{full_name:name}}});if(error){msg.textContent=error.message;msg.style.color='var(--danger)';return;}msg.textContent='Account created!';msg.style.color='var(--success)';setTimeout(()=>closeModal('authModal'),500);}
sb.auth.onAuthStateChange((ev,session)=>{
  if(session&&session.user){
    currentUser=session.user;const meta=currentUser.user_metadata||{};const ini=(meta.full_name||currentUser.email||'U').substring(0,2).toUpperCase();
    document.getElementById('userMenu').innerHTML='<div class="avatar" onclick="toggleUserMenu()">'+ini+'</div><div class="user-dropdown" id="userDropdown"><a href="#" style="font-weight:700;color:var(--pri)">'+(meta.full_name||currentUser.email)+'</a>'+(isAdmin()?'<a href="#" style="color:var(--success)">★ Admin Access</a>':'<a href="#" onclick="openPricing()">Plan: '+userPlan.toUpperCase()+'</a>')+'<div class="divider"></div><a href="#" onclick="openSavedDocsModal()">📄 My Documents</a><a href="#" onclick="openPricing()">💳 Manage Plan</a><div class="divider"></div><a href="#" onclick="doLogout()">Sign Out</a></div>';
    if(isAdmin()){userPlan='business';}else{loadUserPlan();document.querySelectorAll('.email-banner').forEach(function(e){e.style.display='none';});}
    updatePlanBadge();
    document.getElementById('saveDocBtn').style.display=currentDoc?'inline-block':'none';
    // Load theme preference from profile
    sb.from('profiles').select('theme_preference').eq('id',currentUser.id).single().then(({data})=>{
      if(data&&data.theme_preference&&data.theme_preference!=='system'){
        localStorage.setItem('docpro_theme',data.theme_preference);
        applyColorTheme(data.theme_preference);
        updateThemeButtons(data.theme_preference);
      }
    });
  }else{
    currentUser=null;userPlan='free';
    document.getElementById('userMenu').innerHTML='<button class="btn btn-sm" onclick="openAuth()">Sign In</button>';
    updatePlanBadge();
    document.getElementById('saveDocBtn').style.display='none';
  }
});
function toggleUserMenu(){const d=document.getElementById('userDropdown');if(d)d.classList.toggle('show');}
document.addEventListener('click',e=>{const d=document.getElementById('userDropdown');if(d&&!e.target.closest('.user-menu'))d.classList.remove('show');});
async function doLogout(){await sb.auth.signOut();}
async function loadUserPlan(){if(!currentUser)return;try{const{data}=await sb.from('profiles').select('plan,role').eq('id',currentUser.id).single();if(data){userPlan=data.plan||'free';if(data.role==='admin'){currentUser.role='admin';userPlan='business';}}}catch(e){}updatePlanBadge();}
function updatePlanBadge(){const b=document.getElementById('planBadge');if(isAdmin()){b.textContent='ADMIN';b.className='badge badge-biz';}else if(userPlan==='business'){b.textContent='BUSINESS';b.className='badge badge-biz';}else if(userPlan==='pro'){b.textContent='PRO';b.className='badge badge-pro';}else{b.textContent='FREE PLAN';b.className='badge badge-free';}}
/* Pricing, Logo, Upload */
function openPricing(){document.getElementById('pricingModal').classList.add('show');}
async function selectPlan(plan){if(plan==='free'){closeModal('pricingModal');return;}if(!currentUser){closeModal('pricingModal');openAuth();return;}closeModal('pricingModal');try{const res=await fetch('/api/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan:plan,userId:currentUser.id,userEmail:currentUser.email})});const data=await res.json();if(data.url){window.location.href=data.url;}else{alert('Error creating checkout session. Please try again.');}}catch(err){console.error('Checkout error:',err);alert('Error connecting to payment service. Please try again.');}}
function openLogo(){document.getElementById('logoModal').classList.add('show');}
function searchLogos(){const q=document.getElementById('logoSearch').value.trim();const g=document.getElementById('logoGrid');if(!q){g.innerHTML='<p style="grid-column:span 3;text-align:center;color:var(--muted);font-size:12px">Type a company name</p>';return;}const urls=['https://logo.clearbit.com/'+q.toLowerCase().replace(/\s+/g,'')+'.com','https://logo.clearbit.com/'+q.toLowerCase().split(' ')[0]+'.com'];g.innerHTML=urls.map(u=>'<img src="'+u+'" onerror="this.style.display=\'none\'" onclick="selectLogo(\''+u+'\')">').join('')+'<p style="grid-column:span 3;font-size:11px;color:var(--muted);text-align:center">Click to use or create below</p>';}
function selectLogo(url){customLogo=url;if(updatePreviewFn)updatePreviewFn();closeModal('logoModal');}
function createLogo(){const text=document.getElementById('logoText').value||'Logo';const color=document.getElementById('logoColor').value;const shape=document.getElementById('logoShape').value;const c=document.createElement('canvas');c.width=200;c.height=80;const ctx=c.getContext('2d');const ini=text.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();if(shape==='text-only'){ctx.fillStyle=color;ctx.font='bold 36px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,100,40);}else{const r=shape==='circle'?30:shape==='rounded'?8:0;ctx.fillStyle=color;if(shape==='circle'){ctx.beginPath();ctx.arc(40,40,30,0,Math.PI*2);ctx.fill();}else{ctx.beginPath();ctx.roundRect(10,10,60,60,r);ctx.fill();}ctx.fillStyle='#fff';ctx.font='bold 24px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(ini,40,42);ctx.fillStyle=color;ctx.font='bold 18px system-ui';ctx.textAlign='left';ctx.textBaseline='middle';ctx.fillText(text,80,40);}customLogo=c.toDataURL();document.getElementById('logoPreview').innerHTML='<img src="'+customLogo+'" style="max-height:60px"><p style="font-size:11px;color:var(--success);margin-top:4px">Logo created!</p>';if(updatePreviewFn)updatePreviewFn();}
function openUpload(){document.getElementById('uploadModal').classList.add('show');}
function handleUpload(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(ev){const t=ev.target.result;const res=document.getElementById('uploadResult');try{if(f.name.endsWith('.json')){const d=JSON.parse(t);res.innerHTML='<p style="color:var(--success)">JSON parsed!</p><pre style="background:#f8fafc;padding:8px;border-radius:4px;font-size:11px;max-height:200px;overflow:auto">'+JSON.stringify(d,null,2).substring(0,500)+'</pre>';}else if(f.name.endsWith('.csv')){const l=t.split('\n').filter(x=>x.trim());res.innerHTML='<p style="color:var(--success)">CSV: '+l.length+' rows</p>';}else{res.innerHTML='<p style="color:var(--success)">Loaded: '+f.name+'</p>';}}catch(err){res.innerHTML='<p style="color:var(--danger)">Error: '+err.message+'</p>';}};r.readAsText(f);}
/* Hide email banner if already captured */
if(localStorage.getItem('docpro_email')){const ebs=document.querySelectorAll('.email-banner');ebs.forEach(function(eb){eb.innerHTML='<h4 style="margin:0">3 Pro Templates Unlocked!</h4><p style="margin:4px 0 0;opacity:.85">1099-B V11, V13 & V15 are now free. <a href="#" onclick="openAuth();return false" style="color:var(--pri)">Sign up</a> to keep them.</p>';});}
init();
</script>
</body>
</html>
