<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DocPro - Free Document Generator | Invoices, Contracts, Legal Forms</title>
<meta name="description" content="Generate professional documents instantly. 10,000+ templates for invoices, contracts, legal forms, pay stubs, and more.">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--pri:#2563eb;--pri-d:#1d4ed8;--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--success:#22c55e;--warn:#f59e0b;--danger:#ef4444;--sidebar-w:340px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}
.sidebar{width:var(--sidebar-w);background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow:hidden}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-size:20px;color:var(--pri)}
.sidebar-header p{font-size:11px;color:var(--muted);margin-top:2px}
.search-box{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;margin-top:8px}
.search-box:focus{outline:none;border-color:var(--pri)}
.sidebar-content{flex:1;overflow-y:auto;padding:8px}
.cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:8px}
.cat-btn{padding:6px 4px;font-size:10px;text-align:center;border:1px solid var(--border);border-radius:4px;cursor:pointer;background:var(--card);transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cat-btn:hover{border-color:var(--pri);color:var(--pri)}
.cat-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.tier-filters{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
.tier-btn{padding:3px 10px;font-size:11px;border-radius:12px;cursor:pointer;border:1px solid var(--border);background:var(--card)}
.tier-btn:hover,.tier-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
.doc-list{list-style:none}
.doc-item{padding:8px 12px;cursor:pointer;border-radius:6px;font-size:13px;display:flex;justify-content:space-between;align-items:center;transition:.15s}
.doc-item:hover{background:var(--bg)}
.doc-item.active{background:#eff6ff;color:var(--pri);font-weight:600}
.doc-tier{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;text-transform:capitalize}
.doc-tier.free{background:#dcfce7;color:#16a34a}
.doc-tier.pro{background:#fef3c7;color:#d97706}
.doc-tier.business{background:#fee2e2;color:#dc2626}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:12px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--card)}
.main-header h2{font-size:18px}
.header-actions{display:flex;gap:8px;align-items:center}
.btn{padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;border:1px solid var(--border);background:var(--card);transition:.2s}
.btn:hover{border-color:var(--pri)}
.btn-pri{background:var(--pri);color:#fff;border-color:var(--pri)}
.btn-pri:hover{background:var(--pri-d)}
.badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;margin-left:8px}
.badge-free{background:#dcfce7;color:#16a34a}
.badge-pro{background:#fef3c7;color:#d97706}
.badge-biz{background:#dbeafe;color:#2563eb}
.main-content{flex:1;overflow-y:auto;padding:24px;display:flex;gap:24px}
.form-panel{width:50%;max-width:500px}
.form-panel h3{font-size:15px;color:var(--pri);margin-bottom:12px}
.form-row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.form-row label{font-size:11px;color:var(--muted);display:block;margin-bottom:2px}
.form-row input,.form-row textarea,.form-row select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:12px}
.form-row textarea{min-height:60px;resize:vertical}
.form-field{flex:1;min-width:120px}
.preview-panel{flex:1;min-width:300px}
#docPreview{background:#fff;border:1px solid var(--border);border-radius:8px;padding:40px;min-height:500px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.toolbar{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
.toolbar select,.toolbar button{padding:6px 12px;border-radius:4px;border:1px solid var(--border);font-size:12px;cursor:pointer}
/* Modal */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:12px;padding:32px;max-width:480px;width:90%;max-height:90vh;overflow-y:auto}
.modal h2{margin-bottom:16px;font-size:20px}
.modal-close{float:right;background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)}
.modal input[type="text"],.modal input[type="email"],.modal input[type="password"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;font-size:14px}
.modal .btn{width:100%;padding:12px;font-size:14px;margin-top:8px}
.tab-btns{display:flex;gap:0;margin-bottom:16px}
.tab-btns button{flex:1;padding:10px;border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:13px}
.tab-btns button.active{background:var(--pri);color:#fff;border-color:var(--pri)}
/* Pricing */
.pricing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.price-card{border:2px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
.price-card:hover,.price-card.popular{border-color:var(--pri)}
.price-card.popular{position:relative}
.price-card .price{font-size:28px;font-weight:800;color:var(--pri);margin:8px 0}
.price-card .price span{font-size:14px;color:var(--muted)}
.price-card ul{list-style:none;text-align:left;margin:12px 0;font-size:12px}
.price-card li{padding:4px 0;border-bottom:1px solid var(--bg)}
.price-card li::before{content:"\2713 ";color:var(--success)}
/* Logo Studio */
.logo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.logo-grid img{width:100%;height:80px;object-fit:contain;border:1px solid var(--border);border-radius:4px;cursor:pointer;padding:4px}
.logo-grid img:hover{border-color:var(--pri)}
/* Avatar */
.avatar{width:32px;height:32px;border-radius:50%;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;cursor:pointer}
.user-menu{position:relative}
.user-dropdown{position:absolute;top:40px;right:0;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;min-width:160px;display:none;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.user-dropdown.show{display:block}
.user-dropdown a{display:block;padding:8px 12px;font-size:13px;color:var(--text);text-decoration:none;border-radius:4px}
.user-dropdown a:hover{background:var(--bg)}
.load-more-btn{width:100%;padding:8px;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;color:var(--muted)}
.load-more-btn:hover{border-color:var(--pri);color:var(--pri)}
.doc-count{font-size:11px;color:var(--muted);padding:4px 12px;text-align:center}
@media print{.sidebar,.main-header,.toolbar,.form-panel,.modal-overlay{display:none!important}.main-content{padding:0!important}#docPreview{border:none!important;box-shadow:none!important;padding:20px!important}}
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <h1>DocPro</h1>
    <p>Professional USA Document Generator</p>
    <input class="search-box" id="searchBox" placeholder="Search 10,000+ templates..." oninput="filterDocs()">
  </div>
  <div class="sidebar-content">
    <div class="cat-grid" id="catGrid"></div>
    <div class="tier-filters" id="tierFilters">
      <span class="tier-btn active" onclick="setTier('all')">All</span>
      <span class="tier-btn" onclick="setTier('free')">Free</span>
      <span class="tier-btn" onclick="setTier('pro')">Pro</span>
      <span class="tier-btn" onclick="setTier('business')">Business</span>
    </div>
    <div class="doc-count" id="docCount"></div>
    <ul class="doc-list" id="docList"></ul>
    <button class="load-more-btn" id="loadMoreBtn" style="display:none" onclick="loadMoreDocs()">Load More...</button>
  </div>
</div>

<!-- Main Area -->
<div class="main">
  <div class="main-header">
    <div style="display:flex;align-items:center">
      <h2 id="docTitle">Select a Document</h2>
      <span class="badge badge-free" id="planBadge">FREE PLAN</span>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="openLogo()">Logo</button>
      <button class="btn" onclick="openUpload()">Upload</button>
      <button class="btn" onclick="openPricing()">Upgrade</button>
      <div class="user-menu" id="userMenu">
        <button class="btn" id="authBtn" onclick="openAuth()">Sign In</button>
      </div>
    </div>
  </div>
  <div class="main-content">
    <div class="form-panel" id="formPanel">
      <div class="toolbar">
        <select id="themeSelect" onchange="applyTheme()">
          <option value="modern">Modern</option>
          <option value="classic">Classic</option>
          <option value="elegant">Elegant</option>
          <option value="corporate">Corporate</option>
          <option value="minimal">Minimal</option>
          <option value="bold">Bold</option>
        </select>
        <button class="btn" onclick="printDoc()">Print</button>
        <button class="btn" onclick="resetForm()">Reset</button>
        <button class="btn btn-pri" onclick="generatePDF()">Download PDF</button>
      </div>
      <div id="formFields"></div>
    </div>
    <div class="preview-panel">
      <div id="docPreview">
        <div style="text-align:center;padding:60px;color:var(--muted)">
          <h3>Welcome to DocPro</h3>
          <p style="margin-top:8px">Select a document from the sidebar to get started</p>
          <p style="margin-top:16px;font-size:12px">10,000+ professional templates across 14 categories</p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modals -->
<div class="modal-overlay" id="authModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
    <h2 id="authTitle">Sign In</h2>
    <div class="tab-btns">
      <button class="active" onclick="switchAuthTab('login')">Login</button>
      <button onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPass" placeholder="Password">
      <button class="btn btn-pri" onclick="doLogin()">Sign In</button>
    </div>
    <div id="registerForm" style="display:none">
      <input type="text" id="regName" placeholder="Full Name">
      <input type="email" id="regEmail" placeholder="Email">
      <input type="password" id="regPass" placeholder="Password (min 6 chars)">
      <button class="btn btn-pri" onclick="doRegister()">Create Account</button>
    </div>
    <p id="authMsg" style="margin-top:8px;font-size:12px;color:var(--danger)"></p>
  </div>
</div>

<div class="modal-overlay" id="pricingModal">
  <div class="modal" style="max-width:700px">
    <button class="modal-close" onclick="closeModal('pricingModal')">&times;</button>
    <h2>Choose Your Plan</h2>
    <p style="color:var(--muted);margin-bottom:16px">Unlock premium templates and features</p>
    <div class="pricing-grid">
      <div class="price-card" onclick="selectPlan('free')">
        <h3>Free</h3>
        <div class="price">$0<span>/mo</span></div>
        <ul>
          <li>Basic templates</li>
          <li>Invoices & receipts</li>
          <li>Letters & memos</li>
          <li>Download as PDF</li>
          <li>6 design themes</li>
        </ul>
        <button class="btn" style="width:100%">Current Plan</button>
      </div>
      <div class="price-card popular" onclick="selectPlan('pro')">
        <h3>Pro</h3>
        <div class="price">$9.99<span>/mo</span></div>
        <ul>
          <li>All Free templates</li>
          <li>Contracts & agreements</li>
          <li>Tax & financial forms</li>
          <li>Real estate docs</li>
          <li>Priority support</li>
        </ul>
        <button class="btn btn-pri" style="width:100%">Upgrade to Pro</button>
      </div>
      <div class="price-card" onclick="selectPlan('business')">
        <h3>Business</h3>
        <div class="price">$24.99<span>/mo</span></div>
        <ul>
          <li>All Pro templates</li>
          <li>Legal & government</li>
          <li>Healthcare & medical</li>
          <li>Insurance & claims</li>
          <li>Custom branding</li>
        </ul>
        <button class="btn btn-pri" style="width:100%">Upgrade to Business</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="logoModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('logoModal')">&times;</button>
    <h2>Logo Studio</h2>
    <input type="text" id="logoSearch" placeholder="Search company logos..." oninput="searchLogos()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px">
    <div class="logo-grid" id="logoGrid"></div>
    <hr style="margin:16px 0">
    <h3 style="font-size:14px;margin-bottom:8px">Create Custom Logo</h3>
    <input type="text" id="logoText" placeholder="Company Name" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;margin-bottom:8px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input type="color" id="logoColor" value="#2563eb" style="width:40px;height:36px;border:none;cursor:pointer">
      <select id="logoShape" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:4px">
        <option value="circle">Circle</option>
        <option value="square">Square</option>
        <option value="rounded">Rounded</option>
        <option value="text-only">Text Only</option>
      </select>
      <button class="btn btn-pri" onclick="createLogo()">Create</button>
    </div>
    <div id="logoPreview" style="text-align:center;padding:16px"></div>
  </div>
</div>

<div class="modal-overlay" id="uploadModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
    <h2>Upload Document</h2>
    <p style="color:var(--muted);margin-bottom:16px;font-size:13px">Upload JSON, CSV, or TXT files to generate documents</p>
    <div style="border:2px dashed var(--border);border-radius:8px;padding:40px;text-align:center;cursor:pointer" onclick="document.getElementById('fileInput').click()">
      <p style="font-size:14px;color:var(--muted)">Click to upload or drag & drop</p>
      <p style="font-size:11px;color:var(--muted);margin-top:4px">JSON, CSV, TXT supported</p>
    </div>
    <input type="file" id="fileInput" accept=".json,.csv,.txt" style="display:none" onchange="handleUpload(event)">
    <div id="uploadResult" style="margin-top:12px"></div>
  </div>
</div>
<script>
/* ========== CONFIG ========== */
const SUPA_URL='https://mupeqeuuwdmkndvtbhzb.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11cGVxZXV1d2Rta25kdnRiaHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzkwNDMsImV4cCI6MjA4Njk1NTA0M30.aEixeQPtdXIxWUmCVXYba0G6x5Zs-2XRwt0gaA30ORk';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);

/* ========== STATE ========== */
let CATS=[];
let currentCat=null;
let currentTier='all';
let currentDoc=null;
let currentDocCat=null;
let currentUser=null;
let userPlan='free';
let docPageSize=50;
let docOffset=0;
let totalFilteredDocs=0;
let customLogo=null;

/* ========== INIT ========== */
async function init(){
  try{
    const allTemplates=await fetchAllTemplates();
    if(allTemplates.length>0){
      const catMap={};
      allTemplates.forEach(t=>{
        if(!catMap[t.category])catMap[t.category]={n:t.category,docs:[],tiers:{}};
        catMap[t.category].docs.push({name:t.name,tier:t.tier,fields:t.fields});
        catMap[t.category].tiers[t.tier]=(catMap[t.category].tiers[t.tier]||0)+1;
      });
      CATS=Object.values(catMap).sort((a,b)=>a.n.localeCompare(b.n));
      console.log('Loaded '+allTemplates.length+' templates from Supabase in '+CATS.length+' categories');
    }
  }catch(e){console.error('Supabase load error:',e);useFallbackCats();}
  renderSidebar();
}

async function fetchAllTemplates(){
  let all=[];
  let from=0;
  const batchSize=1000;
  while(true){
    const{data,error}=await sb.from('templates').select('name,category,tier,fields').range(from,from+batchSize-1).order('category').order('name');
    if(error){console.error('Fetch error:',error);break;}
    if(!data||data.length===0)break;
    all=all.concat(data);
    if(data.length<batchSize)break;
    from+=batchSize;
  }
  return all;
}

function useFallbackCats(){
  const cats=['Invoices & Receipts','Letters & Memos','Resumes & Employment','Contracts & Agreements','Tax & Financial','Legal & Government','Real Estate & Property','Healthcare & Medical','Insurance & Claims','Education & Academic','Business Operations','Banking & Financial','Transportation & Logistics','Technology & IT'];
  const tiers=['free','free','free','pro','pro','business','pro','business','business','free','pro','pro','pro','pro'];
  CATS=cats.map((n,i)=>{
    const docs=[];
    for(let j=1;j<=10;j++)docs.push({name:n.split('&')[0].trim()+' Template '+j,tier:tiers[i],fields:{}});
    return{n,docs};
  });
}

/* ========== SIDEBAR ========== */
function renderSidebar(){
  const grid=document.getElementById('catGrid');
  grid.innerHTML=CATS.map((c,i)=>'<div class="cat-btn'+(currentCat===i?' active':'')+'" onclick="selectCat('+i+')">'+c.n.split('&')[0].trim()+'</div>').join('');
  docOffset=0;
  renderDocList();
}

function selectCat(i){
  currentCat=currentCat===i?null:i;
  document.querySelectorAll('.cat-btn').forEach((b,idx)=>b.classList.toggle('active',idx===i&&currentCat!==null));
  if(currentCat===null)document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  docOffset=0;
  renderDocList();
}

function setTier(t){
  currentTier=t;
  document.querySelectorAll('.tier-btn').forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase()===t));
  docOffset=0;
  renderDocList();
}

function getFilteredDocs(){
  const q=document.getElementById('searchBox').value.toLowerCase();
  let docs=[];
  CATS.forEach((c,ci)=>{
    if(currentCat!==null&&currentCat!==ci)return;
    c.docs.forEach(d=>{
      if(currentTier!=='all'&&d.tier!==currentTier)return;
      if(q&&!d.name.toLowerCase().includes(q)&&!c.n.toLowerCase().includes(q))return;
      docs.push({...d,catIdx:ci,catName:c.n});
    });
  });
  return docs;
}

function renderDocList(){
  const docs=getFilteredDocs();
  totalFilteredDocs=docs.length;
  const page=docs.slice(0,docOffset+docPageSize);
  const list=document.getElementById('docList');
  list.innerHTML=page.map((d,i)=>'<li class="doc-item" onclick="openDoc('+i+')" data-idx="'+i+'"><span>'+d.name+'</span><span class="doc-tier '+d.tier+'">'+d.tier+'</span></li>').join('');
  document.getElementById('docCount').textContent=totalFilteredDocs.toLocaleString()+' documents found';
  const btn=document.getElementById('loadMoreBtn');
  btn.style.display=page.length<totalFilteredDocs?'block':'none';
}

function loadMoreDocs(){
  docOffset+=docPageSize;
  renderDocList();
}

function filterDocs(){
  docOffset=0;
  renderDocList();
}

/* ========== DOCUMENT RENDERING ========== */
function openDoc(listIdx){
  const docs=getFilteredDocs();
  const d=docs[listIdx];
  if(!d)return;
  if(!canAccess(d.tier)){openPricing();return;}
  currentDoc=d;
  currentDocCat=d.catName;
  document.getElementById('docTitle').textContent=d.name;
  document.querySelectorAll('.doc-item').forEach((el,i)=>el.classList.toggle('active',i===listIdx));
  renderDoc(d.name,d.catName);
}

function canAccess(tier){
  if(isAdmin())return true;
  if(tier==='free')return true;
  if(tier==='pro'&&(userPlan==='pro'||userPlan==='business'))return true;
  if(tier==='business'&&userPlan==='business')return true;
  return false;
}

function isAdmin(){
  return currentUser&&currentUser.email&&(currentUser.email==='admin@docpro.com'||currentUser.email==='larrywomack40@gmail.com'||currentUser.role==='admin');
}

function renderDoc(name, catName){
  const cn=catName.toLowerCase();
  const nm=name.toLowerCase();
  let renderer;
  if(cn.includes('invoice')||cn.includes('receipt'))renderer=renderInvoiceReceipt;
  else if(cn.includes('letter')||cn.includes('memo'))renderer=renderLetterMemo;
  else if(cn.includes('resume')||cn.includes('employment'))renderer=renderResumeEmployment;
  else if(cn.includes('contract')||cn.includes('agreement'))renderer=renderContract;
  else if(cn.includes('tax')||cn.includes('financial'))renderer=renderTaxFinancial;
  else if(cn.includes('legal')||cn.includes('government'))renderer=renderLegalGov;
  else if(cn.includes('real estate')||cn.includes('property'))renderer=renderRealEstate;
  else if(cn.includes('health')||cn.includes('medical'))renderer=renderHealthcare;
  else if(cn.includes('insurance')||cn.includes('claim'))renderer=renderInsurance;
  else if(cn.includes('education')||cn.includes('academic'))renderer=renderEducation;
  else if(cn.includes('business')||cn.includes('operation'))renderer=renderBusiness;
  else if(cn.includes('banking'))renderer=renderBanking;
  else if(cn.includes('transport')||cn.includes('logistics'))renderer=renderTransport;
  else if(cn.includes('tech')||cn.includes('it'))renderer=renderTechIT;
  else{
    if(nm.includes('invoice')||nm.includes('receipt'))renderer=renderInvoiceReceipt;
    else if(nm.includes('letter')||nm.includes('memo'))renderer=renderLetterMemo;
    else if(nm.includes('resume')||nm.includes('cv'))renderer=renderResumeEmployment;
    else if(nm.includes('contract')||nm.includes('agreement'))renderer=renderContract;
    else renderer=renderGenericDoc;
  }
  renderer(name);
}

function getThemeStyles(){
  const t=document.getElementById('themeSelect').value;
  const themes={
    modern:{primary:'#2563eb',font:'system-ui',border:'2px solid #2563eb',headerBg:'#2563eb',headerColor:'#fff',radius:'8px'},
    classic:{primary:'#1a1a1a',font:'Georgia, serif',border:'1px solid #333',headerBg:'#1a1a1a',headerColor:'#fff',radius:'0'},
    elegant:{primary:'#7c3aed',font:"'Palatino Linotype', serif",border:'1px solid #7c3aed',headerBg:'linear-gradient(135deg,#7c3aed,#a855f7)',headerColor:'#fff',radius:'12px'},
    corporate:{primary:'#0f172a',font:"'Segoe UI', sans-serif",border:'2px solid #0f172a',headerBg:'#0f172a',headerColor:'#f8fafc',radius:'4px'},
    minimal:{primary:'#64748b',font:'Inter, sans-serif',border:'1px solid #e2e8f0',headerBg:'#f8fafc',headerColor:'#1e293b',radius:'6px'},
    bold:{primary:'#dc2626',font:'Impact, sans-serif',border:'3px solid #dc2626',headerBg:'#dc2626',headerColor:'#fff',radius:'0'}
  };
  return themes[t]||themes.modern;
}

function applyTheme(){if(currentDoc)renderDoc(currentDoc.name,currentDocCat);}

function logoHTML(){
  if(customLogo)return '<img src="'+customLogo+'" style="max-height:50px;max-width:150px" alt="Logo">';
  return '';
}

/* ========== RENDERERS ========== */
function renderInvoiceReceipt(name){
  const s=getThemeStyles();
  const isReceipt=name.toLowerCase().includes('receipt');
  const fields=isReceipt?[
    {id:'from',label:'From',ph:'Your Company'},
    {id:'to',label:'To',ph:'Client Name'},
    {id:'rnum',label:'Receipt #',ph:'R-001'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'amount',label:'Amount',ph:'$0.00'},
    {id:'method',label:'Payment Method',ph:'Cash/Card/Check'},
    {id:'desc',label:'Description',ph:'Payment for...'},
    {id:'notes',label:'Notes',ph:'Additional notes',type:'textarea'}
  ]:[
    {id:'company',label:'Company Name',ph:'Your Company'},
    {id:'client',label:'Client Name',ph:'Client Co.'},
    {id:'invnum',label:'Invoice #',ph:'INV-001'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'due',label:'Due Date',ph:'MM/DD/YYYY'},
    {id:'item1',label:'Item 1',ph:'Service/Product'},
    {id:'qty1',label:'Qty 1',ph:'1'},
    {id:'rate1',label:'Rate 1',ph:'$0.00'},
    {id:'item2',label:'Item 2',ph:'Service/Product'},
    {id:'qty2',label:'Qty 2',ph:'1'},
    {id:'rate2',label:'Rate 2',ph:'$0.00'},
    {id:'tax',label:'Tax %',ph:'0'},
    {id:'notes',label:'Notes',ph:'Payment terms...',type:'textarea'}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    const logo=logoHTML();
    if(isReceipt){
      document.getElementById('docPreview').innerHTML=
        '<div style="font-family:'+s.font+';max-width:600px;margin:auto;padding:20px">'+
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">'+
        '<div>'+logo+'<h1 style="color:'+s.primary+';font-size:28px;margin-top:8px">RECEIPT</h1><p style="color:#64748b;font-size:13px">'+name+'</p></div>'+
        '<div style="text-align:right"><p style="font-weight:700">#'+(v.rnum||'___')+'</p><p style="color:#64748b;font-size:13px">'+(v.date||'___')+'</p></div></div>'+
        '<div style="border-top:'+s.border+';padding-top:16px;margin-bottom:16px">'+
        '<div style="display:flex;justify-content:space-between"><div><strong>From:</strong><br>'+(v.from||'________')+'</div><div style="text-align:right"><strong>To:</strong><br>'+(v.to||'________')+'</div></div></div>'+
        '<table style="width:100%;border-collapse:collapse;margin:16px 0"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left;border-radius:'+s.radius+' 0 0 0">Description</th><th style="padding:10px;text-align:right">Method</th><th style="padding:10px;text-align:right;border-radius:0 '+s.radius+' 0 0">Amount</th></tr>'+
        '<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+(v.desc||'Payment')+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">'+(v.method||'â€”')+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;font-weight:700">'+(v.amount||'$0.00')+'</td></tr></table>'+
        '<div style="text-align:right;font-size:20px;font-weight:800;color:'+s.primary+';margin:16px 0">Total: '+(v.amount||'$0.00')+'</div>'+
        (v.notes?'<div style="background:#f8fafc;padding:12px;border-radius:6px;font-size:12px;color:#64748b;margin-top:16px"><strong>Notes:</strong> '+v.notes+'</div>':'')+
        '</div>';
    }else{
      const q1=parseFloat(v.qty1)||1,r1=parseFloat(v.rate1)||0;
      const q2=parseFloat(v.qty2)||0,r2=parseFloat(v.rate2)||0;
      const sub=q1*r1+q2*r2;
      const tax=sub*(parseFloat(v.tax)||0)/100;
      const total=sub+tax;
      document.getElementById('docPreview').innerHTML=
        '<div style="font-family:'+s.font+';max-width:650px;margin:auto;padding:20px">'+
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px">'+
        '<div>'+logo+'<h1 style="color:'+s.primary+';font-size:32px;margin-top:8px">INVOICE</h1><p style="color:#64748b;font-size:13px">'+name+'</p></div>'+
        '<div style="text-align:right"><p style="font-weight:700;font-size:16px">'+(v.company||'Company Name')+'</p><p style="color:#64748b">#: '+(v.invnum||'___')+' | '+(v.date||'_/_/_')+'</p></div></div>'+
        '<hr style="border:none;border-top:'+s.border+';margin:0 0 20px">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:24px"><div><strong>BILL TO</strong><br>'+(v.client||'________')+'</div><div style="text-align:right"><strong>DUE</strong><br>'+(v.due||'________')+'</div></div>'+
        '<table style="width:100%;border-collapse:collapse"><tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Description</th><th style="padding:10px;text-align:center">Qty</th><th style="padding:10px;text-align:right">Rate</th><th style="padding:10px;text-align:right">Amount</th></tr>'+
        '<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+(v.item1||'Service')+'</td><td style="padding:10px;text-align:center;border-bottom:1px solid #e2e8f0">'+q1+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+r1.toFixed(2)+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+(q1*r1).toFixed(2)+'</td></tr>'+
        (v.item2?'<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">'+v.item2+'</td><td style="padding:10px;text-align:center;border-bottom:1px solid #e2e8f0">'+q2+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+r2.toFixed(2)+'</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">$'+(q2*r2).toFixed(2)+'</td></tr>':'')+
        '</table>'+
        '<div style="text-align:right;margin-top:16px"><p>Subtotal: $'+sub.toFixed(2)+'</p><p>Tax ('+(v.tax||'0')+'%): $'+tax.toFixed(2)+'</p><p style="font-size:22px;font-weight:800;color:'+s.primary+';margin-top:8px">Total: $'+total.toFixed(2)+'</p></div>'+
        (v.notes?'<div style="background:#f8fafc;padding:12px;border-radius:6px;font-size:12px;color:#64748b;margin-top:20px"><strong>Notes:</strong> '+v.notes+'</div>':'')+
        '</div>';
    }
  };
  updatePreviewFn();
}

function renderLetterMemo(name){
  const s=getThemeStyles();
  const isMemo=name.toLowerCase().includes('memo');
  const fields=isMemo?[
    {id:'from',label:'From',ph:'Your Name'},
    {id:'to',label:'To',ph:'Recipient'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'subject',label:'Subject',ph:'Memo Subject'},
    {id:'body',label:'Body',ph:'Memo content...',type:'textarea'},
    {id:'actions',label:'Action Items',ph:'List actions...',type:'textarea'}
  ]:[
    {id:'from',label:'From',ph:'Your Name'},
    {id:'address',label:'Your Address',ph:'123 Main St'},
    {id:'to',label:'To',ph:'Recipient Name'},
    {id:'toaddr',label:'Recipient Address',ph:'456 Oak Ave'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'subject',label:'Subject',ph:'Re: Subject'},
    {id:'body',label:'Body',ph:'Dear...',type:'textarea'},
    {id:'closing',label:'Closing',ph:'Sincerely'},
    {id:'sig',label:'Signature',ph:'Your Name'}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    const logo=logoHTML();
    if(isMemo){
      document.getElementById('docPreview').innerHTML=
        '<div style="font-family:'+s.font+';max-width:600px;margin:auto;padding:30px">'+logo+
        '<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+' '+s.radius+' 0 0;margin-top:12px"><h1 style="font-size:22px">MEMORANDUM</h1></div>'+
        '<div style="border:'+s.border+';border-top:none;padding:20px;border-radius:0 0 '+s.radius+' '+s.radius+'">'+
        '<table style="width:100%;font-size:13px;margin-bottom:16px"><tr><td style="padding:4px 0;width:80px;font-weight:700">TO:</td><td>'+(v.to||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">FROM:</td><td>'+(v.from||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">DATE:</td><td>'+(v.date||'_____')+'</td></tr><tr><td style="padding:4px 0;font-weight:700">RE:</td><td style="font-weight:700">'+(v.subject||'_____')+'</td></tr></table>'+
        '<hr style="border:none;border-top:2px solid '+s.primary+';margin:16px 0">'+
        '<div style="font-size:14px;line-height:1.6;white-space:pre-wrap">'+(v.body||'Memo content goes here...')+'</div>'+
        (v.actions?'<div style="margin-top:20px;background:#f8fafc;padding:12px;border-radius:6px;border-left:4px solid '+s.primary+'"><strong>Action Items:</strong><div style="margin-top:8px;font-size:13px;white-space:pre-wrap">'+v.actions+'</div></div>':'')+
        '</div></div>';
    }else{
      document.getElementById('docPreview').innerHTML=
        '<div style="font-family:'+s.font+';max-width:600px;margin:auto;padding:30px">'+logo+
        '<div style="margin-top:12px;margin-bottom:24px"><strong>'+(v.from||'Your Name')+'</strong><br><span style="color:#64748b;font-size:13px">'+(v.address||'Your Address')+'</span></div>'+
        '<div style="margin-bottom:24px"><span style="color:#64748b;font-size:13px">'+(v.date||'Date')+'</span></div>'+
        '<div style="margin-bottom:24px"><strong>'+(v.to||'Recipient')+'</strong><br><span style="color:#64748b;font-size:13px">'+(v.toaddr||'Recipient Address')+'</span></div>'+
        '<div style="margin-bottom:16px"><strong>Re: '+(v.subject||'Subject')+'</strong></div>'+
        '<div style="font-size:14px;line-height:1.8;white-space:pre-wrap">'+(v.body||'Dear Sir/Madam,\n\nI am writing to...')+'</div>'+
        '<div style="margin-top:32px"><p>'+(v.closing||'Sincerely')+'</p><p style="margin-top:24px;font-weight:700;border-top:1px solid #333;display:inline-block;padding-top:4px">'+(v.sig||'Signature')+'</p></div></div>';
    }
  };
  updatePreviewFn();
}

function renderResumeEmployment(name){
  const s=getThemeStyles();
  const isResume=name.toLowerCase().includes('resume')||name.toLowerCase().includes('cv');
  const fields=isResume?[
    {id:'fullname',label:'Full Name',ph:'John Smith'},
    {id:'email',label:'Email',ph:'john@email.com'},
    {id:'phone',label:'Phone',ph:'(555) 123-4567'},
    {id:'address',label:'Location',ph:'City, State'},
    {id:'summary',label:'Professional Summary',ph:'Experienced professional...',type:'textarea'},
    {id:'exp',label:'Experience',ph:'Company - Title - Years\nDescription...',type:'textarea'},
    {id:'edu',label:'Education',ph:'University - Degree - Year',type:'textarea'},
    {id:'skills',label:'Skills',ph:'Skill 1, Skill 2, Skill 3'}
  ]:[
    {id:'empname',label:'Employee Name',ph:'John Smith'},
    {id:'company',label:'Company',ph:'Acme Corp'},
    {id:'position',label:'Position',ph:'Software Engineer'},
    {id:'dept',label:'Department',ph:'Engineering'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'manager',label:'Manager',ph:'Jane Doe'},
    {id:'details',label:'Details',ph:'Document details...',type:'textarea'},
    {id:'sig',label:'Signature',ph:'Authorized Signatory'}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    const logo=logoHTML();
    if(isResume){
      document.getElementById('docPreview').innerHTML=
        '<div style="font-family:'+s.font+';max-width:600px;margin:auto;padding:30px">'+
        '<div style="text-align:center;padding:20px;background:'+s.headerBg+';color:'+s.headerColor+';border-radius:'+s.radius+';margin-bottom:20px">'+
        '<h1 style="font-size:28px;letter-spacing:2px">'+(v.fullname||'YOUR NAME')+'</h1>'+
        '<p style="margin-top:8px;font-size:13px;opacity:.9">'+(v.email||'email')+' | '+(v.phone||'phone')+' | '+(v.address||'location')+'</p></div>'+
        (v.summary?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">PROFESSIONAL SUMMARY</h3><p style="font-size:13px;line-height:1.6">'+v.summary+'</p></div>':'')+
        (v.exp?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">EXPERIENCE</h3><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+v.exp+'</div></div>':'')+
        (v.edu?'<div style="margin-bottom:20px"><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">EDUCATION</h3><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+v.edu+'</div></div>':'')+
        (v.skills?'<div><h3 style="color:'+s.primary+';border-bottom:2px solid '+s.primary+';padding-bottom:4px;margin-bottom:8px">SKILLS</h3><div style="display:flex;flex-wrap:wrap;gap:6px">'+v.skills.split(',').map(sk=>'<span style="background:#eff6ff;color:'+s.primary+';padding:4px 10px;border-radius:12px;font-size:12px">'+sk.trim()+'</span>').join('')+'</div></div>':'')+
        '</div>';
    }else{
      document.getElementById('docPreview').innerHTML=
        '<div style="font-family:'+s.font+';max-width:600px;margin:auto;padding:30px">'+logo+
        '<h1 style="color:'+s.primary+';font-size:22px;text-align:center;margin-bottom:4px">'+name+'</h1>'+
        '<p style="text-align:center;color:#64748b;font-size:13px;margin-bottom:24px">'+(v.company||'Company Name')+'</p>'+
        '<table style="width:100%;font-size:13px;margin-bottom:20px;border-collapse:collapse">'+
        '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;width:35%;background:#f8fafc">Employee</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.empname||'_____')+'</td></tr>'+
        '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Position</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.position||'_____')+'</td></tr>'+
        '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Department</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.dept||'_____')+'</td></tr>'+
        '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Manager</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.manager||'_____')+'</td></tr>'+
        '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Date</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.date||'_____')+'</td></tr></table>'+
        '<div style="font-size:14px;line-height:1.6;white-space:pre-wrap;margin-bottom:30px">'+(v.details||'Details will appear here...')+'</div>'+
        '<div style="margin-top:40px;display:flex;justify-content:space-between"><div style="text-align:center"><div style="border-top:1px solid #333;width:200px;padding-top:4px">'+(v.sig||'Authorized Signature')+'</div></div><div style="text-align:center"><div style="border-top:1px solid #333;width:200px;padding-top:4px">Employee Signature</div></div></div></div>';
    }
  };
  updatePreviewFn();
}

function renderContract(name){
  const s=getThemeStyles();
  const fields=[
    {id:'partyA',label:'Party A (First Party)',ph:'Company/Individual Name'},
    {id:'partyB',label:'Party B (Second Party)',ph:'Company/Individual Name'},
    {id:'effDate',label:'Effective Date',ph:'MM/DD/YYYY'},
    {id:'term',label:'Term/Duration',ph:'12 months'},
    {id:'scope',label:'Scope of Agreement',ph:'This agreement covers...',type:'textarea'},
    {id:'payment',label:'Payment Terms',ph:'$X per month, due on...',type:'textarea'},
    {id:'termination',label:'Termination Clause',ph:'Either party may terminate...',type:'textarea'},
    {id:'law',label:'Governing Law',ph:'State of California'}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    document.getElementById('docPreview').innerHTML=
      '<div style="font-family:'+s.font+';max-width:650px;margin:auto;padding:30px">'+logoHTML()+
      '<h1 style="text-align:center;color:'+s.primary+';font-size:24px;margin:20px 0 4px">'+name.toUpperCase()+'</h1>'+
      '<p style="text-align:center;color:#64748b;font-size:12px;margin-bottom:24px">Effective Date: '+(v.effDate||'_________')+'</p>'+
      '<div style="font-size:13px;line-height:1.8">'+
      '<p>This '+name+' ("Agreement") is entered into as of <strong>'+(v.effDate||'_________')+'</strong> by and between:</p>'+
      '<div style="background:#f8fafc;padding:12px;border-radius:6px;margin:12px 0;border-left:4px solid '+s.primary+'"><strong>Party A:</strong> '+(v.partyA||'_________')+'<br><strong>Party B:</strong> '+(v.partyB||'_________')+'</div>'+
      '<h3 style="color:'+s.primary+';margin-top:20px">1. TERM</h3><p>This Agreement shall remain in effect for a period of <strong>'+(v.term||'_________')+'</strong> from the Effective Date.</p>'+
      '<h3 style="color:'+s.primary+';margin-top:16px">2. SCOPE</h3><p style="white-space:pre-wrap">'+(v.scope||'The scope of this agreement includes...')+'</p>'+
      '<h3 style="color:'+s.primary+';margin-top:16px">3. PAYMENT TERMS</h3><p style="white-space:pre-wrap">'+(v.payment||'Payment details to be specified...')+'</p>'+
      '<h3 style="color:'+s.primary+';margin-top:16px">4. TERMINATION</h3><p style="white-space:pre-wrap">'+(v.termination||'Termination terms to be specified...')+'</p>'+
      '<h3 style="color:'+s.primary+';margin-top:16px">5. GOVERNING LAW</h3><p>This Agreement shall be governed by the laws of <strong>'+(v.law||'_________')+'</strong>.</p>'+
      '<div style="margin-top:40px;display:flex;justify-content:space-between"><div><strong>Party A:</strong><br><br><div style="border-top:1px solid #333;width:200px;padding-top:4px">'+(v.partyA||'Signature')+'</div></div><div><strong>Party B:</strong><br><br><div style="border-top:1px solid #333;width:200px;padding-top:4px">'+(v.partyB||'Signature')+'</div></div></div></div></div>';
  };
  updatePreviewFn();
}

function renderTaxFinancial(name){
  const s=getThemeStyles();
  const fields=[
    {id:'tname',label:'Taxpayer/Company Name',ph:'Full Legal Name'},
    {id:'ein',label:'SSN/EIN',ph:'XX-XXXXXXX'},
    {id:'year',label:'Tax Year/Period',ph:'2025'},
    {id:'status',label:'Filing Status',ph:'Single/Married/Business'},
    {id:'income',label:'Total Income',ph:'$0.00'},
    {id:'deductions',label:'Deductions',ph:'$0.00'},
    {id:'credits',label:'Credits',ph:'$0.00'},
    {id:'due',label:'Tax Due/Refund',ph:'$0.00'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'sig',label:'Signature',ph:'Taxpayer Signature'}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    document.getElementById('docPreview').innerHTML=
      '<div style="font-family:'+s.font+';max-width:650px;margin:auto;padding:30px">'+logoHTML()+
      '<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+';margin-top:12px;text-align:center"><h1 style="font-size:20px">'+name.toUpperCase()+'</h1><p style="font-size:12px;opacity:.8">Tax Year: '+(v.year||'____')+'</p></div>'+
      '<div style="padding:20px;border:'+s.border+';border-top:none;border-radius:0 0 '+s.radius+' '+s.radius+'">'+
      '<table style="width:100%;font-size:13px;border-collapse:collapse;margin-bottom:20px">'+
      '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:40%">Taxpayer Name</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.tname||'_____')+'</td></tr>'+
      '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">SSN/EIN</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.ein||'_____')+'</td></tr>'+
      '<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc">Filing Status</td><td style="padding:8px;border:1px solid #e2e8f0">'+(v.status||'_____')+'</td></tr></table>'+
      '<h3 style="color:'+s.primary+';margin-bottom:12px">Financial Summary</h3>'+
      '<table style="width:100%;font-size:13px;border-collapse:collapse">'+
      '<tr style="background:'+s.headerBg+';color:'+s.headerColor+'"><th style="padding:10px;text-align:left">Item</th><th style="padding:10px;text-align:right">Amount</th></tr>'+
      '<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Total Income</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0">'+(v.income||'$0.00')+'</td></tr>'+
      '<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Deductions</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;color:#dc2626">-'+(v.deductions||'$0.00')+'</td></tr>'+
      '<tr><td style="padding:10px;border-bottom:1px solid #e2e8f0">Credits</td><td style="padding:10px;text-align:right;border-bottom:1px solid #e2e8f0;color:#16a34a">-'+(v.credits||'$0.00')+'</td></tr>'+
      '<tr style="font-weight:700"><td style="padding:10px;border-top:2px solid '+s.primary+'">Tax Due / (Refund)</td><td style="padding:10px;text-align:right;border-top:2px solid '+s.primary+';color:'+s.primary+';font-size:18px">'+(v.due||'$0.00')+'</td></tr></table>'+
      '<div style="margin-top:30px;display:flex;justify-content:space-between"><div><p style="font-size:12px;color:#64748b">Date: '+(v.date||'_____')+'</p></div><div style="text-align:center"><div style="border-top:1px solid #333;width:200px;padding-top:4px;font-size:12px">'+(v.sig||'Taxpayer Signature')+'</div></div></div></div></div>';
  };
  updatePreviewFn();
}

function renderGenericDoc(name){
  const s=getThemeStyles();
  const fields=[
    {id:'title',label:'Document Title',ph:name},
    {id:'from',label:'From',ph:'Your Name/Company'},
    {id:'to',label:'To',ph:'Recipient'},
    {id:'date',label:'Date',ph:'MM/DD/YYYY'},
    {id:'ref',label:'Reference #',ph:'REF-001'},
    {id:'body',label:'Content',ph:'Document content...',type:'textarea'},
    {id:'sig',label:'Signature',ph:'Authorized Signatory'}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    document.getElementById('docPreview').innerHTML=
      '<div style="font-family:'+s.font+';max-width:600px;margin:auto;padding:30px">'+logoHTML()+
      '<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+';margin-top:12px;text-align:center"><h1 style="font-size:20px">'+(v.title||name).toUpperCase()+'</h1></div>'+
      '<div style="padding:20px;border:'+s.border+';border-top:none;border-radius:0 0 '+s.radius+' '+s.radius+'">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:16px;font-size:13px"><div><strong>From:</strong> '+(v.from||'_____')+'</div><div><strong>To:</strong> '+(v.to||'_____')+'</div></div>'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:20px;font-size:13px"><div><strong>Date:</strong> '+(v.date||'_____')+'</div><div><strong>Ref:</strong> '+(v.ref||'_____')+'</div></div>'+
      '<hr style="margin-bottom:20px;border-color:#e2e8f0">'+
      '<div style="font-size:14px;line-height:1.8;white-space:pre-wrap">'+(v.body||'Document content goes here...')+'</div>'+
      '<div style="margin-top:40px;text-align:right"><div style="border-top:1px solid #333;display:inline-block;width:200px;padding-top:4px;font-size:12px">'+(v.sig||'Signature')+'</div></div></div></div>';
  };
  updatePreviewFn();
}

/* Simplified renderers for remaining categories - use generic with category-specific headers */
function renderLegalGov(n){renderCategoryDoc(n,'LEGAL DOCUMENT','Case #','Court','State','Jurisdiction','Filed By','Description','Terms/Conditions','Witness/Notary');}
function renderRealEstate(n){renderCategoryDoc(n,'REAL ESTATE DOCUMENT','Property Address','Buyer','Seller','Price','Listing Agent','Description','Terms','Closing Date');}
function renderHealthcare(n){renderCategoryDoc(n,'MEDICAL DOCUMENT','Patient Name','DOB','MRN','Provider','Facility','Diagnosis','Treatment Plan','Follow-Up');}
function renderInsurance(n){renderCategoryDoc(n,'INSURANCE DOCUMENT','Policy #','Insured Name','Date of Loss','Claim #','Adjuster','Description','Amount','Status');}
function renderEducation(n){renderCategoryDoc(n,'ACADEMIC DOCUMENT','School Name','Student','Teacher','Grade/Level','Subject','Date','Description','Score/Grade');}
function renderBusiness(n){renderCategoryDoc(n,'BUSINESS DOCUMENT','Company','Department','Author','Date','Version','Description','Status','Approver');}
function renderBanking(n){renderCategoryDoc(n,'BANKING DOCUMENT','Account Holder','Account #','Bank Name','Date','Amount','Description','Reference #','Branch');}
function renderTransport(n){renderCategoryDoc(n,'SHIPPING DOCUMENT','Shipper','Consignee','Carrier','Origin','Destination','Date','Weight/Qty','Tracking #');}
function renderTechIT(n){renderCategoryDoc(n,'TECHNICAL DOCUMENT','Project Name','Author','Version','Date','Status','Description','Reviewer','Approval');}

function renderCategoryDoc(name,header,l1,l2,l3,l4,l5,l6,l7,l8){
  const s=getThemeStyles();
  const fields=[
    {id:'f1',label:l1,ph:l1},{id:'f2',label:l2,ph:l2},{id:'f3',label:l3,ph:l3},{id:'f4',label:l4,ph:l4},
    {id:'f5',label:l5,ph:l5},{id:'f6',label:l6,ph:l6,type:'textarea'},{id:'f7',label:l7,ph:l7,type:'textarea'},{id:'f8',label:l8,ph:l8}
  ];
  renderFormFields(fields);
  updatePreviewFn=()=>{
    const v=getFieldValues(fields);
    let rows=fields.map(f=>'<tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:700;background:#f8fafc;width:35%">'+f.label+'</td><td style="padding:8px;border:1px solid #e2e8f0;white-space:pre-wrap">'+(v[f.id]||'_____')+'</td></tr>').join('');
    document.getElementById('docPreview').innerHTML=
      '<div style="font-family:'+s.font+';max-width:650px;margin:auto;padding:30px">'+logoHTML()+
      '<div style="background:'+s.headerBg+';color:'+s.headerColor+';padding:16px 20px;border-radius:'+s.radius+';margin:12px 0;text-align:center"><h1 style="font-size:18px">'+header+'</h1><p style="font-size:12px;opacity:.8">'+name+'</p></div>'+
      '<table style="width:100%;font-size:13px;border-collapse:collapse">'+rows+'</table>'+
      '<div style="margin-top:30px;display:flex;justify-content:space-between"><div style="text-align:center"><div style="border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">Authorized Signature</div></div><div style="text-align:center"><div style="border-top:1px solid #333;width:180px;padding-top:4px;font-size:11px">Date</div></div></div></div>';
  };
  updatePreviewFn();
}

/* ========== FORM HELPERS ========== */
let updatePreviewFn=null;
function renderFormFields(fields){
  const fp=document.getElementById('formFields');
  let html='<h3>'+((currentDoc&&currentDoc.name)||'Document')+'</h3>';
  for(let i=0;i<fields.length;i+=2){
    html+='<div class="form-row">';
    html+=fieldHTML(fields[i]);
    if(fields[i+1])html+=fieldHTML(fields[i+1]);
    html+='</div>';
  }
  fp.innerHTML=html;
  fp.querySelectorAll('input,textarea,select').forEach(el=>el.addEventListener('input',()=>{if(updatePreviewFn)updatePreviewFn();}));
}

function fieldHTML(f){
  if(f.type==='textarea')return '<div class="form-field"><label>'+f.label+'</label><textarea id="field_'+f.id+'" placeholder="'+f.ph+'"></textarea></div>';
  return '<div class="form-field"><label>'+f.label+'</label><input id="field_'+f.id+'" placeholder="'+f.ph+'"></div>';
}

function getFieldValues(fields){
  const v={};
  fields.forEach(f=>{const el=document.getElementById('field_'+f.id);v[f.id]=el?el.value:'';});
  return v;
}

function resetForm(){
  document.querySelectorAll('#formFields input, #formFields textarea').forEach(el=>el.value='');
  if(updatePreviewFn)updatePreviewFn();
}

/* ========== PDF & PRINT ========== */
function generatePDF(){
  const el=document.getElementById('docPreview');
  if(!el||!el.innerHTML.trim()){alert('No document to download');return;}
  const name=(currentDoc?currentDoc.name:'Document')+'_DocPro';
  html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#ffffff'}).then(canvas=>{
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF('p','mm','a4');
    const iw=pdf.internal.pageSize.getWidth()-20;
    const ih=canvas.height*iw/canvas.width;
    let ph=pdf.internal.pageSize.getHeight()-20;
    let y=10;
    if(ih<=ph){
      pdf.addImage(canvas.toDataURL('image/png'),'PNG',10,y,iw,ih);
    }else{
      let srcY=0;
      const srcH=canvas.width*(ph/iw);
      while(srcY<canvas.height){
        const pageCanvas=document.createElement('canvas');
        pageCanvas.width=canvas.width;
        pageCanvas.height=Math.min(srcH,canvas.height-srcY);
        const ctx=pageCanvas.getContext('2d');
        ctx.drawImage(canvas,0,srcY,canvas.width,pageCanvas.height,0,0,pageCanvas.width,pageCanvas.height);
        const pgH=pageCanvas.height*iw/pageCanvas.width;
        if(srcY>0)pdf.addPage();
        pdf.addImage(pageCanvas.toDataURL('image/png'),'PNG',10,10,iw,pgH);
        srcY+=srcH;
      }
    }
    pdf.save(name+'.pdf');
  }).catch(err=>{console.error('PDF error:',err);alert('PDF generation failed. Try again.');});
}

function printDoc(){
  const el=document.getElementById('docPreview');
  if(!el)return;
  const w=window.open('','_blank','width=800,height=600');
  w.document.write('<html><head><title>Print</title></head><body style="font-family:system-ui;padding:20px">'+el.innerHTML+'</body></html>');
  w.document.close();
  w.focus();
  w.print();
}

/* ========== AUTH ========== */
function openAuth(){document.getElementById('authModal').classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}

function switchAuthTab(tab){
  const btns=document.querySelectorAll('.tab-btns button');
  btns.forEach(b=>b.classList.remove('active'));
  if(tab==='login'){btns[0].classList.add('active');document.getElementById('loginForm').style.display='block';document.getElementById('registerForm').style.display='none';document.getElementById('authTitle').textContent='Sign In';}
  else{btns[1].classList.add('active');document.getElementById('loginForm').style.display='none';document.getElementById('registerForm').style.display='block';document.getElementById('authTitle').textContent='Create Account';}
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value;
  const pass=document.getElementById('loginPass').value;
  const msg=document.getElementById('authMsg');
  if(!email||!pass){msg.textContent='Please fill in all fields';return;}
  msg.textContent='Signing in...';msg.style.color='var(--pri)';
  const{data,error}=await sb.auth.signInWithPassword({email,password:pass});
  if(error){msg.textContent=error.message;msg.style.color='var(--danger)';return;}
  msg.textContent='Success!';msg.style.color='var(--success)';
  setTimeout(()=>closeModal('authModal'),500);
}

async function doRegister(){
  const name=document.getElementById('regName').value;
  const email=document.getElementById('regEmail').value;
  const pass=document.getElementById('regPass').value;
  const msg=document.getElementById('authMsg');
  if(!name||!email||!pass){msg.textContent='Please fill in all fields';return;}
  if(pass.length<6){msg.textContent='Password must be at least 6 characters';return;}
  msg.textContent='Creating account...';msg.style.color='var(--pri)';
  const{data,error}=await sb.auth.signUp({email,password:pass,options:{data:{full_name:name}}});
  if(error){msg.textContent=error.message;msg.style.color='var(--danger)';return;}
  msg.textContent='Account created!';msg.style.color='var(--success)';
  setTimeout(()=>closeModal('authModal'),500);
}

sb.auth.onAuthStateChange((event,session)=>{
  if(session&&session.user){
    currentUser=session.user;
    const meta=currentUser.user_metadata||{};
    const initials=(meta.full_name||currentUser.email||'U').substring(0,2).toUpperCase();
    document.getElementById('userMenu').innerHTML=
      '<div class="avatar" onclick="toggleUserMenu()">'+initials+'</div>'+
      '<div class="user-dropdown" id="userDropdown">'+
      '<a href="#" style="font-weight:700;color:var(--pri)">'+(meta.full_name||currentUser.email)+'</a>'+
      '<a href="#" onclick="openPricing()">My Plan: '+userPlan.toUpperCase()+'</a>'+
      '<a href="#" onclick="doLogout()">Sign Out</a></div>';
    if(isAdmin()){userPlan='business';document.getElementById('planBadge').textContent='ADMIN';document.getElementById('planBadge').className='badge badge-biz';}
    else{loadUserPlan();}
    updatePlanBadge();
  }else{
    currentUser=null;userPlan='free';
    document.getElementById('userMenu').innerHTML='<button class="btn" onclick="openAuth()">Sign In</button>';
    updatePlanBadge();
  }
});

function toggleUserMenu(){
  const dd=document.getElementById('userDropdown');
  if(dd)dd.classList.toggle('show');
}
document.addEventListener('click',e=>{
  const dd=document.getElementById('userDropdown');
  if(dd&&!e.target.closest('.user-menu'))dd.classList.remove('show');
});

async function doLogout(){await sb.auth.signOut();}

async function loadUserPlan(){
  if(!currentUser)return;
  try{
    const{data}=await sb.from('profiles').select('plan,role').eq('id',currentUser.id).single();
    if(data){userPlan=data.plan||'free';if(data.role==='admin'){currentUser.role='admin';userPlan='business';}}
  }catch(e){}
  updatePlanBadge();
}

function updatePlanBadge(){
  const b=document.getElementById('planBadge');
  if(isAdmin()){b.textContent='ADMIN';b.className='badge badge-biz';}
  else if(userPlan==='business'){b.textContent='BUSINESS PLAN';b.className='badge badge-biz';}
  else if(userPlan==='pro'){b.textContent='PRO PLAN';b.className='badge badge-pro';}
  else{b.textContent='FREE PLAN';b.className='badge badge-free';}
}

/* ========== PRICING ========== */
function openPricing(){document.getElementById('pricingModal').classList.add('show');}

function selectPlan(plan){
  if(plan==='free'){closeModal('pricingModal');return;}
  if(!currentUser){closeModal('pricingModal');openAuth();return;}
  alert('Stripe Checkout integration coming soon! Selected plan: '+plan.toUpperCase()+'\n\nPrice: '+(plan==='pro'?'$9.99':'$24.99')+'/month');
  closeModal('pricingModal');
}

/* ========== LOGO ========== */
function openLogo(){document.getElementById('logoModal').classList.add('show');}

function searchLogos(){
  const q=document.getElementById('logoSearch').value.trim();
  const grid=document.getElementById('logoGrid');
  if(!q){grid.innerHTML='<p style="grid-column:span 3;text-align:center;color:var(--muted);font-size:12px">Type a company name to search</p>';return;}
  grid.innerHTML='<p style="grid-column:span 3;text-align:center;color:var(--muted);font-size:12px">Loading...</p>';
  const urls=[
    'https://logo.clearbit.com/'+q.toLowerCase().replace(/\s+/g,'')+'.com',
    'https://logo.clearbit.com/'+q.toLowerCase().replace(/\s+/g,'-')+'.com',
    'https://logo.clearbit.com/'+q.toLowerCase().split(' ')[0]+'.com'
  ];
  grid.innerHTML=urls.map(u=>'<img src="'+u+'" onerror="this.style.display=\'none\'" onclick="selectLogo(\''+u+'\')">').join('')+
    '<p style="grid-column:span 3;font-size:11px;color:var(--muted);text-align:center;margin-top:4px">Click a logo to use it, or create a custom one below</p>';
}

function selectLogo(url){customLogo=url;if(updatePreviewFn)updatePreviewFn();closeModal('logoModal');}

function createLogo(){
  const text=document.getElementById('logoText').value||'Logo';
  const color=document.getElementById('logoColor').value;
  const shape=document.getElementById('logoShape').value;
  const canvas=document.createElement('canvas');
  canvas.width=200;canvas.height=80;
  const ctx=canvas.getContext('2d');
  const initials=text.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
  if(shape==='text-only'){
    ctx.fillStyle=color;ctx.font='bold 36px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,100,40);
  }else{
    const r=shape==='circle'?30:shape==='rounded'?8:0;
    ctx.fillStyle=color;
    if(shape==='circle'){ctx.beginPath();ctx.arc(40,40,30,0,Math.PI*2);ctx.fill();}
    else{ctx.beginPath();ctx.roundRect(10,10,60,60,r);ctx.fill();}
    ctx.fillStyle='#fff';ctx.font='bold 24px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(initials,40,42);
    ctx.fillStyle=color;ctx.font='bold 18px system-ui';ctx.textAlign='left';ctx.textBaseline='middle';ctx.fillText(text,80,40);
  }
  customLogo=canvas.toDataURL();
  document.getElementById('logoPreview').innerHTML='<img src="'+customLogo+'" style="max-height:60px"><p style="font-size:11px;color:var(--success);margin-top:4px">Logo created! Click a document to apply it.</p>';
  if(updatePreviewFn)updatePreviewFn();
}

/* ========== UPLOAD ========== */
function openUpload(){document.getElementById('uploadModal').classList.add('show');}

function handleUpload(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const text=ev.target.result;
    const res=document.getElementById('uploadResult');
    try{
      if(file.name.endsWith('.json')){
        const data=JSON.parse(text);
        res.innerHTML='<p style="color:var(--success)">JSON parsed successfully!</p><pre style="background:#f8fafc;padding:8px;border-radius:4px;font-size:11px;max-height:200px;overflow:auto">'+JSON.stringify(data,null,2).substring(0,1000)+'</pre>';
      }else if(file.name.endsWith('.csv')){
        const lines=text.split('\n').filter(l=>l.trim());
        res.innerHTML='<p style="color:var(--success)">CSV loaded: '+lines.length+' rows</p><pre style="background:#f8fafc;padding:8px;border-radius:4px;font-size:11px;max-height:200px;overflow:auto">'+lines.slice(0,10).join('\n')+'</pre>';
      }else{
        res.innerHTML='<p style="color:var(--success)">File loaded: '+file.name+'</p><pre style="background:#f8fafc;padding:8px;border-radius:4px;font-size:11px;max-height:200px;overflow:auto">'+text.substring(0,1000)+'</pre>';
      }
    }catch(err){res.innerHTML='<p style="color:var(--danger)">Error: '+err.message+'</p>';}
  };
  reader.readAsText(file);
}

/* ========== STARTUP ========== */
init();
</script>
</body>
</html>
